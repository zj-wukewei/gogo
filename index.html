<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="GoGo&#39;s home">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="GoGo&#39;s home">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="GoGo&#39;s home">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>GoGo's home</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">GoGo's home</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/11/kotlin学习之DslAdapter/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="GoGo (吴克伟)">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GoGo's home">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/11/kotlin学习之DslAdapter/" itemprop="url">Kotlin学习之DslAdapter</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-11T12:22:29+08:00">
                2018-11-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>又开始学习kotlin了，Adapter的库在github也是一找一大堆，这次Dsl就用它来学习吧，DataBinding（支持多布局）</p>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">val mAdapter = MagicAdapter.repositoryAdapter()</div><div class="line">          .addItemDsl&lt;String&gt; &#123;</div><div class="line">              resId = R.layout.item_string</div><div class="line">              dataMatch = &#123; d, _ -&gt; d is String &#125;</div><div class="line">              itemId(BR.user) &#123; User(1234567, &quot;GoGo&quot;) &#125;</div><div class="line">              handler(BR.presenter, View.OnClickListener &#123;</div><div class="line">                  Toast.makeText(this@MainActivity, R.string.item_string, Toast.LENGTH_LONG).show()</div><div class="line">              &#125;)</div><div class="line">              areItems = &#123; o, n -&gt; o == n &#125;</div><div class="line">          &#125;</div><div class="line">          .addItemDsl&lt;User&gt; &#123;</div><div class="line">              resId = R.layout.item_user</div><div class="line">              dataMatch = &#123; d, _ -&gt; d is User &#125;</div><div class="line">              handler(BR.presenter, View.OnClickListener &#123;</div><div class="line">                  Toast.makeText(this@MainActivity, R.string.item_user, Toast.LENGTH_LONG).show()</div><div class="line">              &#125;)</div><div class="line">              areItems = &#123; o, n -&gt; o.id == n.id &#125;</div><div class="line">              areContents = &#123; o, n -&gt; o.id == n.id &amp;&amp; o.name == n.name&#125;</div><div class="line">          &#125;</div><div class="line">          .build()</div><div class="line"></div><div class="line">      binding.rv.run &#123;</div><div class="line">          adapter = mAdapter</div><div class="line">          layoutManager = LinearLayoutManager(this@MainActivity)</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      val data = ArrayList&lt;Any&gt;()</div><div class="line">      data.add(&quot;11111&quot;)</div><div class="line">      data.add(&quot;22222&quot;)</div><div class="line">      data.add(&quot;33333&quot;)</div><div class="line">      data.add(&quot;44444&quot;)</div><div class="line">      data.add(&quot;44444&quot;)</div><div class="line">      data.add(User(111, &quot;张三&quot;))</div><div class="line">      data.add(User(222, &quot;李四&quot;))</div><div class="line">      data.add(User(333, &quot;王五&quot;))</div><div class="line">      data.add(User(444, &quot;桃六&quot;))</div><div class="line"></div><div class="line">      mAdapter.submitList(data)</div></pre></td></tr></table></figure>
<p>主要方法介绍addItemDsl()方法代表添加一个布局可以指定类型，传入一个MagicItem类，resId代码布局id，dataMatch是之在多布局的时候，当前item的数据和你加入的布局类型是否符合，因为是DataBinding版本，所以在布局上默认有个BR.item的,如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;data&gt;</div><div class="line"></div><div class="line">      &lt;variable</div><div class="line">              name=&quot;item&quot;</div><div class="line">              type=&quot;String&quot;/&gt;</div><div class="line"></div><div class="line">      &lt;variable name=&quot;user&quot; type=&quot;com.github.wkw.magicadapter.User&quot;/&gt;</div><div class="line"></div><div class="line">      &lt;variable</div><div class="line">              name=&quot;presenter&quot;</div><div class="line">              type=&quot;android.view.View.OnClickListener&quot;/&gt;</div><div class="line"></div><div class="line">  &lt;/data&gt;</div></pre></td></tr></table></figure></p>
<p>itemId方法就是可以给布局加入其它类型的比如我加入了User类型，handler方法也是传人id和函数，因为有时候你会onClick，onLongClick自己可以加入。areItems和areContents代表的意思是加入了DiffUtil.Callback() 里面的两个areItemsTheSame和areContentsTheSame方法。</p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>MagicAdapter里面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">private var datas: MutableList&lt;Any&gt; = ArrayList()</div><div class="line"></div><div class="line">internal val items: MutableList&lt;MagicItem&lt;Any&gt;&gt; = builder.items</div><div class="line"></div><div class="line">private val positionToTypeMap = SparseIntArray()</div></pre></td></tr></table></figure>
<p>item就是记录所以的布局总和，如何通过position来找到对应的布局核心代码就是如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">private fun positionToItemsIndex(position: Int): Int &#123;</div><div class="line">       if (items.isEmpty()) &#123;</div><div class="line">           throw RuntimeException(&quot;item must add&quot;)</div><div class="line">       &#125;</div><div class="line">       items.forEachIndexed &#123; index, magicItem -&gt;</div><div class="line">           if (magicItem.getItemViewType(datas[position], position)) &#123;</div><div class="line">               positionToTypeMap.put(position, index)</div><div class="line">               return index</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       throw RuntimeException(&quot;can&apos;t find matched item&quot;)</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>onBindViewHolder默认</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">override fun onBindViewHolder(holder: BindingViewHolder&lt;ViewDataBinding&gt;, postion: Int) &#123;</div><div class="line">       val data = datas[postion]</div><div class="line">       val magicItem = items[positionToTypeMap.get(postion)]</div><div class="line"></div><div class="line">       holder.binding.setVariable(BR.item, data)</div><div class="line"></div><div class="line">       val handlers = magicItem.handlers()</div><div class="line">       for ((id, handle) in handlers) &#123;</div><div class="line">           holder.binding.setVariable(id, handle)</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       val itemIds = magicItem.itemIds()</div><div class="line">       for ((idGet, setter) in itemIds) &#123;</div><div class="line">           val itemVariable = idGet(data)</div><div class="line">           holder.binding.setVariable(itemVariable, setter(data))</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       holder.binding.executePendingBindings()</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>其实代码量很少。</p>
<h3 id="支持Dsl"><a href="#支持Dsl" class="headerlink" title="支持Dsl"></a>支持Dsl</h3><p>MagicDslItem类来支持</p>
<h3 id="不足之处"><a href="#不足之处" class="headerlink" title="不足之处"></a>不足之处</h3><p>目前只支持databinding版本后期可以支持普通版本，<a href="https://github.com/zj-wukewei/KotlinDslMagicAdapter/" target="_blank" rel="external">DataBindingDslAdapter</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/27/在library中使用productFlavors/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="GoGo (吴克伟)">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GoGo's home">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/27/在library中使用productFlavors/" itemprop="url">在library中使用productFlavors</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-27T16:10:13+08:00">
                2018-10-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>因为公司的app是医生端和患者端，在app开发中会很多模块是相似的只有一部分逻辑不同，比如登录模块,IM模块。</p>
<h3 id="library使用productFlavors"><a href="#library使用productFlavors" class="headerlink" title="library使用productFlavors"></a>library使用productFlavors</h3><p> 在library的 build.gradle中如下配置，</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">flavorDimensions &quot;type&quot;</div><div class="line"></div><div class="line">publishNonDefault true</div><div class="line"></div><div class="line"></div><div class="line">productFlavors &#123;</div><div class="line"></div><div class="line">    doctor &#123;</div><div class="line">        buildConfigField(&quot;String&quot;, &quot;appType&quot;, &quot;\&quot;1\&quot;&quot;)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    patient &#123;</div><div class="line">        buildConfigField(&quot;String&quot;, &quot;appType&quot;, &quot;\&quot;2\&quot;&quot;)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> 定义一个维度为 type类型的，分android和patient，定义了appType，1为医生端，2为患者端，在library中可以使用如下来区分是哪个渠道，BuildConfig.appType,但是当很大一部分代码不一样的时候，可以在src目录下建立两个doctor和patient的包，这样在打包的时候就不会把对方渠道的代码打进去，可以减少app的体积。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"> public class LoginActivity extends AppCompatActivity &#123;</div><div class="line">    private TextView mTvType;</div><div class="line">    @Override</div><div class="line">    protected void onCreate(@Nullable Bundle savedInstanceState) &#123;</div><div class="line">        super.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.login_activity_login);</div><div class="line">        mTvType = findViewById(R.id.tv_login_type);</div><div class="line">        mTvType.setText(BuildConfig.appType);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="app中使用"><a href="#app中使用" class="headerlink" title="app中使用"></a>app中使用</h3><p>  app是分两个的，在doctor的app下我们只想要doctor渠道，patient也是类型，但是我在doctor的app下面是不想要这两个渠道的，我只需要其中的一中而且是确定的，app下有自己的渠道,这种情况就是library中有，但是app中没有，这个时候可以使用missingDimensionStrategy选择策，在defaultConfig下，意思就是我当前app下没有和library相同渠道的时候，都采用你设置的渠道，这样不管app自己有什么渠道，都会采用library中你所选择的渠道。（还有很多其它场景可以使用matchingFallbacks属性来设置回退策略）</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">   defaultConfig &#123;</div><div class="line">        applicationId &quot;com.github.wkw.doctor&quot;</div><div class="line">        minSdkVersion 21</div><div class="line">        targetSdkVersion 28</div><div class="line">        versionCode 1</div><div class="line">        versionName &quot;1.0&quot;</div><div class="line">        testInstrumentationRunner &quot;android.support.test.runner.AndroidJUnitRunner&quot;</div><div class="line">        missingDimensionStrategy &quot;type&quot;, &quot;doctor&quot;</div><div class="line">    &#125;</div><div class="line">    buildTypes &#123;</div><div class="line">        release &#123;</div><div class="line">            minifyEnabled false</div><div class="line">            proguardFiles getDefaultProguardFile(&apos;proguard-android.txt&apos;), &apos;proguard-rules.pro&apos;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    flavorDimensions &quot;app&quot;</div><div class="line"></div><div class="line">    productFlavors &#123;</div><div class="line">        preProd &#123;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    dependencies &#123;</div><div class="line">       implementation fileTree(dir: &apos;libs&apos;, include: [&apos;*.jar&apos;])</div><div class="line">       implementation project(&apos;:module_login&apos;)</div><div class="line">    &#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>这样login模块就不用维护两份代码，当出现bug的时候还要修改两份，这种办法非常适合两个高度相似的app。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/21/android组件化登录的思考/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="GoGo (吴克伟)">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GoGo's home">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/21/android组件化登录的思考/" itemprop="url">android组件化登录的思考</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-21T21:07:23+08:00">
                2018-10-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="登录问题思考"><a href="#登录问题思考" class="headerlink" title="登录问题思考"></a>登录问题思考</h3><p> 很久没有写文章了，因为一些个人的原因，但是现在一切问题都解决了。1年前写了一篇android组件化的学习，里面提到了commonbusiness里面会包含登录模块，但是后来经过实践表明这是一个不理想的决定，因为在各个模块当然运行的时候大多数的功能都是会依赖登录模块的，这样会造成各个模块都要登录。<br> 现在的做法是把登录模块单独提取出来，也能单独运行， 登录模块运行之后，登录成功之后其它模块的app也能感知到登录成功之后的用户数据。</p>
<h3 id="运用内容提供者进行app之间通讯"><a href="#运用内容提供者进行app之间通讯" class="headerlink" title="运用内容提供者进行app之间通讯"></a>运用内容提供者进行app之间通讯</h3><p> 登录模块定义一个UserContentProvider代码如下：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">public class UserContentProvider extends DaggerContentProvider &#123;</div><div class="line"></div><div class="line"></div><div class="line">    private static final int SUCCESS = 1;</div><div class="line"></div><div class="line">    private final String[] columnNames = new String[]&#123;AppConstats.TOKEN, AppConstats.UID&#125;;</div><div class="line">    static UriMatcher mUriMatcher = new UriMatcher(UriMatcher.NO_MATCH);</div><div class="line"></div><div class="line">    static &#123;</div><div class="line">        mUriMatcher.addURI(&quot;com.modularization.android.login&quot;, &quot;user&quot;, SUCCESS);    //uri规则可自己定义，但一定和清单文件一直</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Inject</div><div class="line">    RxSharedPreferences mRxSharedPreferences;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean onCreate() &#123;</div><div class="line">        return super.onCreate();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Nullable</div><div class="line">    @Override</div><div class="line">    public Cursor query(@NonNull Uri uri, @Nullable String[] strings, @Nullable String s, @Nullable String[] strings1, @Nullable String s1) &#123;</div><div class="line">        String token = mRxSharedPreferences.getString(AppConstats.TOKEN).get();</div><div class="line">        String uId = mRxSharedPreferences.getString(AppConstats.UID).get();</div><div class="line">        MatrixCursor cursor = new MatrixCursor(columnNames);</div><div class="line">        cursor.addRow(new String[] &#123;token, uId&#125;);</div><div class="line">        return cursor;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Nullable</div><div class="line">    @Override</div><div class="line">    public String getType(@NonNull Uri uri) &#123;</div><div class="line">        return null;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Nullable</div><div class="line">    @Override</div><div class="line">    public Uri insert(@NonNull Uri uri, @Nullable ContentValues contentValues) &#123;</div><div class="line">        return null;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public int delete(@NonNull Uri uri, @Nullable String s, @Nullable String[] strings) &#123;</div><div class="line">        return 0;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public int update(@NonNull Uri uri, @Nullable ContentValues contentValues, @Nullable String s, @Nullable String[] strings) &#123;</div><div class="line">        return 0;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> 我这里简单的使用了RxSharedPreferences去保存登录成功之后的数据，提供了query方法。</p>
<p> 登录的伪代码</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">String token  = UUID.randomUUID().toString();</div><div class="line">         String uId = &quot;123456&quot;;</div><div class="line">         SharedPreferences.Editor editor = mSharedPreferences.edit();</div><div class="line">         editor.putString(AppConstats.TOKEN, token);</div><div class="line">         editor.putString(AppConstats.UID, uId);</div><div class="line">         editor.apply();</div><div class="line">         getContentResolver().notifyChange(Uri.parse(AppConstats.USER_URI), null);</div></pre></td></tr></table></figure>
<p>getContentResolver().notifyChange(）方法来通知其它模块app变化了。</p>
<p>因为在commonbusiness的UserSystem类，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">@Singleton</div><div class="line">public class UserSystem &#123;</div><div class="line">    private static final String KEY_TOKEN = &quot;token&quot;;</div><div class="line">    private static final String KEY_USER_ID = &quot;uid&quot;;</div><div class="line"></div><div class="line">    private BehaviorSubject&lt;TokenEntity&gt; mTokenEntityBehaviorSubject = BehaviorSubject.create();</div><div class="line"></div><div class="line">    private Context mContext;</div><div class="line"></div><div class="line">    @Inject</div><div class="line">    public UserSystem(Context context) &#123;</div><div class="line">        this.mContext = context;</div><div class="line">        loadTokenEntity();</div><div class="line">        context.getContentResolver().registerContentObserver(Uri.parse(AppConstats.USER_URI), false, new ContentObserver(null) &#123;</div><div class="line">            @Override</div><div class="line">            public void onChange(boolean selfChange) &#123;</div><div class="line">                super.onChange(selfChange);</div><div class="line">                loadTokenEntity();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    private void loadTokenEntity() &#123;</div><div class="line">        ContentResolver resolver = mContext.getContentResolver();</div><div class="line">        Uri uri = Uri.parse(AppConstats.USER_URI);</div><div class="line">        Cursor cursor = resolver.query(uri, null, null, null, null);</div><div class="line">        if (cursor != null) &#123;</div><div class="line">            while (cursor.moveToNext()) &#123;</div><div class="line">                String token = cursor.getString(0);</div><div class="line">                String uId = cursor.getString(1);</div><div class="line">                TokenEntity entity = new TokenEntity(uId, token);</div><div class="line">                mTokenEntityBehaviorSubject.onNext(entity);</div><div class="line">            &#125;</div><div class="line">            cursor.close();</div><div class="line">        &#125; else &#123;</div><div class="line">            ToastUtils.show(mContext, &quot;请安装登录模块&quot;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public Observable&lt;TokenEntity&gt; getTokenEntityObservable() &#123;</div><div class="line">        return mTokenEntityBehaviorSubject;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>registerContentObserver方法能监听到数据的变化，再去从新获取数据这样在登录模块单独运行的时候，登录成功其它模块的app也能感知得到变化，这样就只要登录一次就可以了。</p>
<h3 id="其它思考"><a href="#其它思考" class="headerlink" title="其它思考"></a>其它思考</h3><p>因为每个app接口要是你没有登录你都会返回一个错误码，全局app都有个错误处理的方法，我的如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">public class ResponseListenerImpl implements ResponseErrorListener &#123;</div><div class="line">    @Override</div><div class="line">    public void handleResponseError(Context context, Throwable t) &#123;</div><div class="line">        Timber.e(t);</div><div class="line">        if (t instanceof ResponseException) &#123;</div><div class="line"></div><div class="line">        &#125;</div><div class="line">        final String msg = ErrorMessageFactory.create(context, (Exception) t);</div><div class="line">        ToastUtils.show(context, msg);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这里面你就可以获取那个code，然后采用android:scheme 通过uri跳转到登录模块的LoginActivity,这样就算各个模块单独运行也会让你感觉在一个app之内一个，比如A模块app服务端返回要从新登录的code，这样跳转到Login模块的app中走完登录流程，采用内容提供者来通知A模块我登录完成了，A模块获取用户数据，再进行需要登录之后的操作，代码在我的github里面的<a href="https://github.com/zj-wukewei/ModularizationExample" target="_blank" rel="external">ModularizationExample项目</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/09/Lifecycle学习/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="GoGo (吴克伟)">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GoGo's home">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/09/Lifecycle学习/" itemprop="url">Lifecycle学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-09T22:46:02+08:00">
                2017-11-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>用于构建生命周期感知组件的类和接口，这些组件可以根据 Activity 或 Fragment 的当前生命周期自动调整其行为,在support版本为26.1.0中默认的AppCompatActivity和fragment已经集成这个功能。</p>
<h4 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h4><p>（1）首先让你的类实现LifecycleObserver接口，在类方法上加上注解OnLifecycleEvent</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">public class LifecycleTest implements LifecycleObserver &#123;</div><div class="line">    private static final String TAG = &quot;LifecycleTest&quot;;</div><div class="line"></div><div class="line">    @OnLifecycleEvent(Lifecycle.Event.ON_CREATE)</div><div class="line">    public void onCreate() &#123;</div><div class="line">        Log.d(TAG, &quot;onCreate&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @OnLifecycleEvent(Lifecycle.Event.ON_START)</div><div class="line">    public void onStart() &#123;</div><div class="line">        Log.d(TAG, &quot;onStart&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @OnLifecycleEvent(Lifecycle.Event.ON_RESUME)</div><div class="line">    public void onResume() &#123;</div><div class="line">        Log.d(TAG, &quot;onResume&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    @OnLifecycleEvent(Lifecycle.Event.ON_PAUSE)</div><div class="line">    public void onPause() &#123;</div><div class="line">        Log.d(TAG, &quot;onPause&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @OnLifecycleEvent(Lifecycle.Event.ON_STOP)</div><div class="line">    public void onStop() &#123;</div><div class="line">        Log.d(TAG, &quot;onStop&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @OnLifecycleEvent(Lifecycle.Event.ON_DESTROY)</div><div class="line">    public void onDestroy() &#123;</div><div class="line">        Log.d(TAG, &quot;onDestroy&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中的Event为以下代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">public enum Event &#123;</div><div class="line">       /**</div><div class="line">        * Constant for onCreate event of the &#123;@link LifecycleOwner&#125;.</div><div class="line">        */</div><div class="line">       ON_CREATE,</div><div class="line">       /**</div><div class="line">        * Constant for onStart event of the &#123;@link LifecycleOwner&#125;.</div><div class="line">        */</div><div class="line">       ON_START,</div><div class="line">       /**</div><div class="line">        * Constant for onResume event of the &#123;@link LifecycleOwner&#125;.</div><div class="line">        */</div><div class="line">       ON_RESUME,</div><div class="line">       /**</div><div class="line">        * Constant for onPause event of the &#123;@link LifecycleOwner&#125;.</div><div class="line">        */</div><div class="line">       ON_PAUSE,</div><div class="line">       /**</div><div class="line">        * Constant for onStop event of the &#123;@link LifecycleOwner&#125;.</div><div class="line">        */</div><div class="line">       ON_STOP,</div><div class="line">       /**</div><div class="line">        * Constant for onDestroy event of the &#123;@link LifecycleOwner&#125;.</div><div class="line">        */</div><div class="line">       ON_DESTROY,</div><div class="line">       /**</div><div class="line">        * An &#123;@link Event Event&#125; constant that can be used to match all events.</div><div class="line">        */</div><div class="line">       ON_ANY</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>很清晰的看到各种的值对应的生命周期的哪个方法。</p>
<p>（2）在activity或者fragmetn中注册</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">getLifecycle().addObserver(new LifecycleTest());</div></pre></td></tr></table></figure>
<h4 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h4><p>从addObserver这个方法切入，Lifecycle是一个抽象类，它的实现类是LifecycleRegistry，从下面我们可以猜测到运用了典型的观察者模式。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">@MainThread</div><div class="line">public abstract void addObserver(LifecycleObserver observer);</div><div class="line"></div><div class="line">@MainThread</div><div class="line">public abstract void removeObserver(LifecycleObserver observer);</div><div class="line"></div><div class="line">@MainThread</div><div class="line">public abstract State getCurrentState();</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div></pre></td><td class="code"><pre><div class="line">public class LifecycleRegistry extends Lifecycle &#123;</div><div class="line"></div><div class="line">    ....省略代码</div><div class="line"></div><div class="line">     @Override</div><div class="line">    public void addObserver(LifecycleObserver observer) &#123;</div><div class="line">        State initialState = mState == DESTROYED ? DESTROYED : INITIALIZED;</div><div class="line">        ObserverWithState statefulObserver = new ObserverWithState(observer, initialState);</div><div class="line">        ObserverWithState previous = mObserverMap.putIfAbsent(observer, statefulObserver);</div><div class="line"></div><div class="line">        if (previous != null) &#123;</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        boolean isReentrance = mAddingObserverCounter != 0 || mHandlingEvent;</div><div class="line"></div><div class="line">        State targetState = calculateTargetState(observer);</div><div class="line">        mAddingObserverCounter++;</div><div class="line">        while ((statefulObserver.mState.compareTo(targetState) &lt; 0</div><div class="line">                &amp;&amp; mObserverMap.contains(observer))) &#123;</div><div class="line">            pushParentState(statefulObserver.mState);</div><div class="line">            statefulObserver.dispatchEvent(mLifecycleOwner, upEvent(statefulObserver.mState));</div><div class="line">            popParentState();</div><div class="line">            // mState / subling may have been changed recalculate</div><div class="line">            targetState = calculateTargetState(observer);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (!isReentrance) &#123;</div><div class="line">            // we do sync only on the top level.</div><div class="line">            sync();</div><div class="line">        &#125;</div><div class="line">        mAddingObserverCounter--;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">static class ObserverWithState &#123;</div><div class="line">        State mState;</div><div class="line">        GenericLifecycleObserver mLifecycleObserver;</div><div class="line"></div><div class="line">        ObserverWithState(LifecycleObserver observer, State initialState) &#123;</div><div class="line">            mLifecycleObserver = Lifecycling.getCallback(observer);</div><div class="line">            mState = initialState;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        void dispatchEvent(LifecycleOwner owner, Event event) &#123;</div><div class="line">            State newState = getStateAfter(event);</div><div class="line">            mState = min(mState, newState);</div><div class="line">            mLifecycleObserver.onStateChanged(owner, event);</div><div class="line">            mState = newState;</div><div class="line">        &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"> @NonNull</div><div class="line">    static GenericLifecycleObserver getCallback(Object object) &#123;</div><div class="line">        if (object instanceof GenericLifecycleObserver) &#123;</div><div class="line">            return (GenericLifecycleObserver) object;</div><div class="line">        &#125;</div><div class="line">        //noinspection TryWithIdenticalCatches</div><div class="line">        try &#123;</div><div class="line">            final Class&lt;?&gt; klass = object.getClass();</div><div class="line">            Constructor&lt;? extends GenericLifecycleObserver&gt; cachedConstructor = sCallbackCache.get(</div><div class="line">                    klass);</div><div class="line">            if (cachedConstructor != null) &#123;</div><div class="line">                return cachedConstructor.newInstance(object);</div><div class="line">            &#125;</div><div class="line">            cachedConstructor = getGeneratedAdapterConstructor(klass);</div><div class="line">            if (cachedConstructor != null) &#123;</div><div class="line">                if (!cachedConstructor.isAccessible()) &#123;</div><div class="line">                    cachedConstructor.setAccessible(true);</div><div class="line">                &#125;</div><div class="line">            &#125; else &#123;</div><div class="line">                cachedConstructor = sREFLECTIVE;</div><div class="line">            &#125;</div><div class="line">            sCallbackCache.put(klass, cachedConstructor);</div><div class="line">            return cachedConstructor.newInstance(object);</div><div class="line">        &#125; catch (IllegalAccessException e) &#123;</div><div class="line">            throw new RuntimeException(e);</div><div class="line">        &#125; catch (InstantiationException e) &#123;</div><div class="line">            throw new RuntimeException(e);</div><div class="line">        &#125; catch (InvocationTargetException e) &#123;</div><div class="line">            throw new RuntimeException(e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">public interface GenericLifecycleObserver extends LifecycleObserver &#123;</div><div class="line">    /**</div><div class="line">     * Called when a state transition event happens.</div><div class="line">     *</div><div class="line">     * @param source The source of the event</div><div class="line">     * @param event The event</div><div class="line">     */</div><div class="line">    void onStateChanged(LifecycleOwner source, Lifecycle.Event event);</div><div class="line">&#125;</div><div class="line"></div><div class="line">class ReflectiveGenericLifecycleObserver implements GenericLifecycleObserver &#123;</div><div class="line">    private final Object mWrapped;</div><div class="line">    private final CallbackInfo mInfo;</div><div class="line">    //缓存ReflectiveGenericLifecycleObserver实例</div><div class="line">    @SuppressWarnings(&quot;WeakerAccess&quot;)</div><div class="line">    static final Map&lt;Class, CallbackInfo&gt; sInfoCache = new HashMap&lt;&gt;();</div><div class="line"></div><div class="line">    ReflectiveGenericLifecycleObserver(Object wrapped) &#123;  </div><div class="line">        mWrapped = wrapped;</div><div class="line">        mInfo = getInfo(mWrapped.getClass());</div><div class="line">    &#125;</div><div class="line">      private static CallbackInfo getInfo(Class klass) &#123;</div><div class="line">        CallbackInfo existing = sInfoCache.get(klass);</div><div class="line">        if (existing != null) &#123;</div><div class="line">            return existing;</div><div class="line">        &#125;</div><div class="line">        existing = createInfo(klass);</div><div class="line">        return existing;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private static CallbackInfo createInfo(Class klass) &#123;</div><div class="line">        Class superclass = klass.getSuperclass();</div><div class="line">        Map&lt;MethodReference, Event&gt; handlerToEvent = new HashMap&lt;&gt;();</div><div class="line">        if (superclass != null) &#123;</div><div class="line">            CallbackInfo superInfo = getInfo(superclass);</div><div class="line">            if (superInfo != null) &#123;</div><div class="line">                handlerToEvent.putAll(superInfo.mHandlerToEvent);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Method[] methods = klass.getDeclaredMethods();</div><div class="line"></div><div class="line">        Class[] interfaces = klass.getInterfaces();</div><div class="line">        for (Class intrfc : interfaces) &#123;</div><div class="line">            for (Entry&lt;MethodReference, Event&gt; entry : getInfo(intrfc).mHandlerToEvent.entrySet()) &#123;</div><div class="line">                verifyAndPutHandler(handlerToEvent, entry.getKey(), entry.getValue(), klass);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        for (Method method : methods) &#123;</div><div class="line">            OnLifecycleEvent annotation = method.getAnnotation(OnLifecycleEvent.class);</div><div class="line">            if (annotation == null) &#123;</div><div class="line">                continue;</div><div class="line">            &#125;</div><div class="line">            Class&lt;?&gt;[] params = method.getParameterTypes();</div><div class="line">            int callType = CALL_TYPE_NO_ARG;</div><div class="line">            if (params.length &gt; 0) &#123;</div><div class="line">                callType = CALL_TYPE_PROVIDER;</div><div class="line">                if (!params[0].isAssignableFrom(LifecycleOwner.class)) &#123;</div><div class="line">                    throw new IllegalArgumentException(</div><div class="line">                            &quot;invalid parameter type. Must be one and instanceof LifecycleOwner&quot;);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            Event event = annotation.value();</div><div class="line"></div><div class="line">            if (params.length &gt; 1) &#123;</div><div class="line">                callType = CALL_TYPE_PROVIDER_WITH_EVENT;</div><div class="line">                if (!params[1].isAssignableFrom(Event.class)) &#123;</div><div class="line">                    throw new IllegalArgumentException(</div><div class="line">                            &quot;invalid parameter type. second arg must be an event&quot;);</div><div class="line">                &#125;</div><div class="line">                if (event != Event.ON_ANY) &#123;</div><div class="line">                    throw new IllegalArgumentException(</div><div class="line">                            &quot;Second arg is supported only for ON_ANY value&quot;);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            if (params.length &gt; 2) &#123;</div><div class="line">                throw new IllegalArgumentException(&quot;cannot have more than 2 params&quot;);</div><div class="line">            &#125;</div><div class="line">            MethodReference methodReference = new MethodReference(callType, method);</div><div class="line">            verifyAndPutHandler(handlerToEvent, methodReference, event, klass);</div><div class="line">        &#125;</div><div class="line">        CallbackInfo info = new CallbackInfo(handlerToEvent);</div><div class="line">        sInfoCache.put(klass, info);</div><div class="line">        return info;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ObserverWithState这个类保持当前的状态和GenericLifecycleObserver，其中GenericLifecycleObserver也是个接口，实现类为ReflectiveGenericLifecycleObserver，就是把LifecycleObserver添加了onStateChanged（）的方法，这样在ObserverWithState的dispatchEvent的方法中调用onStateChanged，来通知状态发生变化，从而达到要调用那个注解方法，ReflectiveGenericLifecycleObserver里面有CallbackInfo mInfo，其实就是反射获取你添加了OnLifecycleEvent的注解的方法，以便到时候调用。</p>
<p>activity的生命周期和LifecycleRegistry关联，其中有个SupportActivity类，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">public class SupportActivity extends Activity implements LifecycleOwner &#123;</div><div class="line">    @Override</div><div class="line">    @SuppressWarnings(&quot;RestrictedApi&quot;)</div><div class="line">    protected void onCreate(@Nullable Bundle savedInstanceState) &#123;</div><div class="line">        super.onCreate(savedInstanceState);</div><div class="line">        ReportFragment.injectIfNeededIn(this);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">public class ReportFragment extends Fragment &#123;</div><div class="line">     public static void injectIfNeededIn(Activity activity) &#123;</div><div class="line">        // ProcessLifecycleOwner should always correctly work and some activities may not extend</div><div class="line">        // FragmentActivity from support lib, so we use framework fragments for activities</div><div class="line">        android.app.FragmentManager manager = activity.getFragmentManager();</div><div class="line">        if (manager.findFragmentByTag(REPORT_FRAGMENT_TAG) == null) &#123;</div><div class="line">            manager.beginTransaction().add(new ReportFragment(), REPORT_FRAGMENT_TAG).commit();</div><div class="line">            // Hopefully, we are the first to make a transaction.</div><div class="line">            manager.executePendingTransactions();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    @Override</div><div class="line">    public void onActivityCreated(Bundle savedInstanceState) &#123;</div><div class="line">        super.onActivityCreated(savedInstanceState);</div><div class="line">        dispatchCreate(mProcessListener);</div><div class="line">        dispatch(Lifecycle.Event.ON_CREATE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">     private void dispatch(Lifecycle.Event event) &#123;</div><div class="line">        Activity activity = getActivity();</div><div class="line">        if (activity instanceof LifecycleRegistryOwner) &#123;</div><div class="line">            ((LifecycleRegistryOwner) activity).getLifecycle().handleLifecycleEvent(event);</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (activity instanceof LifecycleOwner) &#123;</div><div class="line">            Lifecycle lifecycle = ((LifecycleOwner) activity).getLifecycle();</div><div class="line">            if (lifecycle instanceof LifecycleRegistry) &#123;</div><div class="line">                ((LifecycleRegistry) lifecycle).handleLifecycleEvent(event);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>就是通过添加个空的ReportFragment来监听activity的生命周期的变化（貌似很多地方都用到了这个），通过监听ReportFragment生命周期调用dispatch(Lifecycle.Event.ON_CREATE)，最后到LifecycleRegistry的handleLifecycleEvent方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">  public void handleLifecycleEvent(Lifecycle.Event event) &#123;</div><div class="line">        mState = getStateAfter(event);</div><div class="line">        if (mHandlingEvent || mAddingObserverCounter != 0) &#123;</div><div class="line">            mNewEventOccurred = true;</div><div class="line">            // we will figure out what to do on upper level.</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line">        mHandlingEvent = true;</div><div class="line">        sync();</div><div class="line">        mHandlingEvent = false;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">      // happens only on the top of stack (never in reentrance),</div><div class="line">    // so it doesn&apos;t have to take in account parents</div><div class="line">private void sync() &#123;</div><div class="line">        while (!isSynced()) &#123;</div><div class="line">            mNewEventOccurred = false;</div><div class="line">            // no need to check eldest for nullability, because isSynced does it for us.</div><div class="line">            if (mState.compareTo(mObserverMap.eldest().getValue().mState) &lt; 0) &#123;</div><div class="line">                backwardPass();</div><div class="line">            &#125;</div><div class="line">            Entry&lt;LifecycleObserver, ObserverWithState&gt; newest = mObserverMap.newest();</div><div class="line">            if (!mNewEventOccurred &amp;&amp; newest != null</div><div class="line">                    &amp;&amp; mState.compareTo(newest.getValue().mState) &gt; 0) &#123;</div><div class="line">                forwardPass();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        mNewEventOccurred = false;</div><div class="line">&#125;</div><div class="line"></div><div class="line">private boolean isSynced() &#123;</div><div class="line">        if (mObserverMap.size() == 0) &#123;</div><div class="line">            return true;</div><div class="line">        &#125;</div><div class="line">        State eldestObserverState = mObserverMap.eldest().getValue().mState;</div><div class="line">        State newestObserverState = mObserverMap.newest().getValue().mState;</div><div class="line">        return eldestObserverState == newestObserverState &amp;&amp; mState == newestObserverState;</div><div class="line">&#125;</div><div class="line">private void forwardPass() &#123;</div><div class="line">        Iterator&lt;Entry&lt;LifecycleObserver, ObserverWithState&gt;&gt; ascendingIterator =</div><div class="line">                mObserverMap.iteratorWithAdditions();</div><div class="line">        while (ascendingIterator.hasNext() &amp;&amp; !mNewEventOccurred) &#123;</div><div class="line">            Entry&lt;LifecycleObserver, ObserverWithState&gt; entry = ascendingIterator.next();</div><div class="line">            ObserverWithState observer = entry.getValue();</div><div class="line">            while ((observer.mState.compareTo(mState) &lt; 0 &amp;&amp; !mNewEventOccurred</div><div class="line">                    &amp;&amp; mObserverMap.contains(entry.getKey()))) &#123;</div><div class="line">                pushParentState(observer.mState);</div><div class="line">                observer.dispatchEvent(mLifecycleOwner, upEvent(observer.mState));</div><div class="line">                popParentState();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">static class CallbackInfo &#123;</div><div class="line">    final Map&lt;Event, List&lt;MethodReference&gt;&gt; mEventToHandlers;</div><div class="line">        final Map&lt;MethodReference, Event&gt; mHandlerToEvent;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>sync同步状态，isSynced判断要不要同步，它是比较当前的状态和我们存我们存放观察者的集合最早或最新放入的观察者的状态，当前状态比之前状态消的时候就是要回滚，好比从OnPause到OnResume，则调用backwardPass回退，forwardPass则为前进，最后调用<br>dispatchEvent方法就是，ObserverWithState的，最后调用onStateChanged，之前CallbackInfo的mEventToHandlers根据key就是事件，vaule就是方法，通过事件获取方法最后调用方法，从value是个list可以看出你可以给多个方法注解同个生命周期。</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>大致的流程就是通过在activity添加个空的fragment来和activity的生命周期同步，然后再调用LifecycleRegistry的handleLifecycleEvent方法到ObserverWithState的dispatchEvent方法到ReflectiveGenericLifecycleObserver的onStateChanged方法，根据注解方法获取各自监听生命周期的方法再调用，只是官方做的更加的完善方便。第一次写分析文章，大部分都是源码很少解读的，希望以后能够改进，通过这次的分析，可以学习到可以通过设置个空的fragment来监听activity的生命周末，很多高度抽象的东西，比如LifecycleObserver你只要实现，很多东西就会自动生成，让开发者集成更加的方便。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/30/jvm学习/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="GoGo (吴克伟)">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GoGo's home">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/30/jvm学习/" itemprop="url">jvm学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-30T22:01:02+08:00">
                2017-10-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/04/android组件化学习/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="GoGo (吴克伟)">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GoGo's home">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/04/android组件化学习/" itemprop="url">android组件化学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-04T10:11:25+08:00">
                2017-10-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>网上关于组件化的文章有很多了，大部分都知道实现的思路，不过还是要自己去实践一下才会发现问题。文章的<a href="https://github.com/zj-wukewei/ModularizationExample" target="_blank" rel="external">项目地址</a>，项目用到CleanArchitecture框架，本文会介绍CleanArchitecture框架和dagger2在组件化的使用。</p>
<h3 id="项目关系图"><a href="#项目关系图" class="headerlink" title="项目关系图"></a>项目关系图</h3><p><img src="http://upload-images.jianshu.io/upload_images/1353151-465fd79c815487c7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="关系图.png"></p>
<p>sdk:  一些公用库，各种辅助类，和第三方view<br>basic:  (依赖sdk) 网络访问初始化，本地缓存和第三方包等。<br>commonbusiness:  (依赖basic) 这里为什么我会多出这一层，因为有很多公共的业务，好比公司的app是强登录的，我会把登录模块写在这里，里面也包含了一些baseActivity和BaseApplication和各个组件的一些公共方法还有组件各种的服务接口的定义。<br>module_archives和module_knowledge： 就是两个组件，可以单独运行。</p>
<h4 id="application和library切换"><a href="#application和library切换" class="headerlink" title="application和library切换"></a>application和library切换</h4><p>想必大家都知道了，定义一个isBuildModule=false，在组件的build.gradle中加入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">if (isBuildModule.toBoolean()) &#123;</div><div class="line">    apply plugin: &apos;com.android.application&apos;</div><div class="line">&#125; else &#123;</div><div class="line">    apply plugin: &apos;com.android.library&apos;</div><div class="line">    apply from: &apos;maven-release-kline-aar.gradle&apos;</div><div class="line">&#125;</div><div class="line"></div><div class="line"> sourceSets &#123;</div><div class="line">        main &#123;</div><div class="line">            if (isBuildModule.toBoolean()) &#123;</div><div class="line">                manifest.srcFile &apos;src/main/debug/AndroidManifest.xml&apos;</div><div class="line">            &#125; else &#123;</div><div class="line">                manifest.srcFile &apos;src/main/release/AndroidManifest.xml&apos;</div><div class="line">                java &#123;</div><div class="line">                    exclude &apos;**/debug/**&apos;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>maven-release-kline-aar.gradle是一个打包aar的文件，在切换的时候也会使用不同的AndroidManifest.xml，因为在组件是debug的时候它是单独单独运行的，还有就是代码可以在建立一个debug包，可以在单独运行的时候做些初始化app的，打包的时候回剔除这部分代码。</p>
<h4 id="library依赖和资源问题"><a href="#library依赖和资源问题" class="headerlink" title="library依赖和资源问题"></a>library依赖和资源问题</h4><p>我把所以的library都依赖在basic，每个组件都会依赖这个包，这样就不会存在library的版本问题，资源的问题就是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">defaultConfig &#123;</div><div class="line"></div><div class="line">       if (isBuildModule.toBoolean()) &#123;</div><div class="line">           applicationId &quot;com.wkw.archives&quot;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       minSdkVersion rootProject.ext.minSdkVersion</div><div class="line">       targetSdkVersion rootProject.ext.targetSdkVersion</div><div class="line">       versionCode rootProject.ext.versionCode</div><div class="line">       versionName rootProject.ext.versionName</div><div class="line"></div><div class="line">       testInstrumentationRunner &quot;android.support.test.runner.AndroidJUnitRunner&quot;</div><div class="line"></div><div class="line">       resourcePrefix &quot;archives&quot;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h4 id="组件之间的通信"><a href="#组件之间的通信" class="headerlink" title="组件之间的通信"></a>组件之间的通信</h4><p>你可以选择阿里的<a href="https://github.com/alibaba/ARouter" target="_blank" rel="external">ARouter</a>库，但是我的项目没有那么复杂，组件也就4个左右，所以没有使用阿里的库，我采用的是以下就是核心代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Object result = null;</div><div class="line">Class&lt;?&gt; c = Class.forName(className);</div><div class="line">if (c != null) &#123;</div><div class="line">    result = c.newInstance();</div><div class="line">&#125;</div><div class="line">return result;</div></pre></td></tr></table></figure>
<p>但是采用Class.forName会有个问题那就是在混淆的时候，className是指定的，所以要在类上加@Keep 。</p>
<h4 id="CleanArchitecture框架和dagger在组件化的使用"><a href="#CleanArchitecture框架和dagger在组件化的使用" class="headerlink" title="CleanArchitecture框架和dagger在组件化的使用"></a>CleanArchitecture框架和dagger在组件化的使用</h4><p><a href="https://github.com/android10/Android-CleanArchitecture" target="_blank" rel="external">CleanArchitecture框架的github地址</a>，这里再介绍分享一篇文章<a href="http://www.jianshu.com/u/df40282480b4" target="_blank" rel="external">小鄧子</a>的<a href="http://www.jianshu.com/p/3edcf85539a6" target="_blank" rel="external">Easy Clean architecture on Android</a>,我把data和domain会写在各自的业务模块中，自己的模块只要定义自己的就可以了，有个ApplicationModule会定义一些每个模块都需要的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">public class ApplicationModule &#123;</div><div class="line"></div><div class="line">    @Provides</div><div class="line">    @Singleton</div><div class="line">    Context provideContext(Application application) &#123;</div><div class="line">        return application;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Provides</div><div class="line">    @Singleton</div><div class="line">    UserSystem provideUserSystem() &#123;</div><div class="line">        return new UserSystem();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Provides</div><div class="line">    @Singleton</div><div class="line">    ThreadExecutor provideThreadExecutor(JobExecutor jobExecutor) &#123;</div><div class="line">        return jobExecutor;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Provides</div><div class="line">    @Singleton</div><div class="line">    PostExecutionThread providePostExecutionThread(UIThread uiThread) &#123;</div><div class="line">        return uiThread;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Provides</div><div class="line">    @Singleton</div><div class="line">    MrService provideMrService() &#123;</div><div class="line">        return new MrService();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Provides</div><div class="line">    @Singleton</div><div class="line">    UserCache provideUserCache(UserCacheImpl userCache) &#123;</div><div class="line">        return userCache;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后在module_archives模块中会有ArchivesDataRepositoryModule和ArchivesActivityModule<br>其中KnowledgeDataRepositoryModule用于提供如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">@Module</div><div class="line">public class ArchivesDataRepositoryModule &#123;</div><div class="line"></div><div class="line">    @Provides</div><div class="line">    @Singleton</div><div class="line">    ArchivesApi providesArchivesApi(MrService mrService) &#123;</div><div class="line">        return mrService.createApi(ArchivesApi.class);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Provides</div><div class="line">    @Singleton</div><div class="line">    ArchivesRepository prvidesArchivesRepository(ArchivesDataRepository archivesDataRepository) &#123;</div><div class="line">        return archivesDataRepository;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ArchivesActivityModule的代码如下：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">@Module</div><div class="line">public abstract class ArchivesActivityModule &#123;</div><div class="line">    @PerActivity</div><div class="line">    @ContributesAndroidInjector()</div><div class="line">    abstract ArchivesActivity contributeArchivesActivity();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样在主app的AppComponent类中加入：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">@Singleton</div><div class="line">@Component(modules = &#123;</div><div class="line">        AndroidInjectionModule.class, ApplicationModule.class,</div><div class="line">        ArchivesDataRepositoryModule.class, ArchivesActivityModule.class,</div><div class="line">        KnowledgeDataRepositoryModule.class, KnowledgeActivityModule.class</div><div class="line">&#125;)</div><div class="line">public interface AppComponent &#123;</div><div class="line">    @Component.Builder</div><div class="line">    interface Builder &#123;</div><div class="line">        @BindsInstance</div><div class="line">        Builder application(Application application);</div><div class="line">        AppComponent build();</div><div class="line">    &#125;</div><div class="line">    void inject(MrApplication mrApplication);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在module_archives为debug模式下也会有个AppComponent</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">@Singleton</div><div class="line">@Component(modules = &#123;</div><div class="line">        AndroidInjectionModule.class, ApplicationModule.class,</div><div class="line">        ArchivesDataRepositoryModule.class, ArchivesActivityModule.class</div><div class="line">&#125;)</div><div class="line">public interface AppComponent &#123;</div><div class="line">    @Component.Builder</div><div class="line">    interface Builder &#123;</div><div class="line">        @BindsInstance</div><div class="line">        Builder application(Application application);</div><div class="line">        AppComponent build();</div><div class="line">    &#125;</div><div class="line">    void inject(ArchivesApplication mrApplication);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>各种模块初始化api和Repository，你要是嫌弃每个模块都要引入两个.class文件，你可以使用一个然后采用include的方式好比dagger中的AndroidSupportInjectionModule类方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">@Beta</div><div class="line">@Module(includes = AndroidInjectionModule.class)</div><div class="line">public abstract class AndroidSupportInjectionModule &#123;</div><div class="line">  @Multibinds</div><div class="line">  abstract Map&lt;Class&lt;? extends Fragment&gt;, AndroidInjector.Factory&lt;? extends Fragment&gt;&gt;</div><div class="line">      supportFragmentInjectorFactories();</div><div class="line"></div><div class="line">  private AndroidSupportInjectionModule() &#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样就会很清楚的知道自己模块需要初始化什么和使用什么，也不用考虑其它模块的初始化的数据，之后只需要在主app加入就行，也是比较方便的。</p>
<h4 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h4><p>各种模块当为library是要打包成aar的，maven-release-kline-aar.gradle文件代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">apply plugin: &apos;maven&apos;</div><div class="line"></div><div class="line">ext &#123;// ext is a gradle closure allowing the declaration of global properties</div><div class="line">    PUBLISH_GROUP_ID = &apos;com.wkw&apos;</div><div class="line">    PUBLISH_ARTIFACT_ID = &apos;archives&apos;</div><div class="line">    PUBLISH_VERSION = rootProject.ext.versionName</div><div class="line">&#125;</div><div class="line"></div><div class="line">uploadArchives &#123;</div><div class="line">    repositories.mavenDeployer &#123;</div><div class="line">        //这里就是最后输出地址，在自己电脑上新建个文件夹，把文件夹路径粘贴在此</div><div class="line">        //注意”file://“ + 路径，有三个斜杠，别漏了</div><div class="line">        repository(url: &quot;file:///Users/wukewei/Documents/android/ModularizationExample/repo&quot;)</div><div class="line"></div><div class="line">        pom.project &#123;</div><div class="line">            groupId project.PUBLISH_GROUP_ID</div><div class="line">            artifactId project.PUBLISH_ARTIFACT_ID</div><div class="line">            version project.PUBLISH_VERSION</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//以下代码会生成jar包源文件，如果是不开源码，请不要输入这段</div><div class="line">//aar包内包含注释</div><div class="line">task androidSourcesJar(type: Jar) &#123;</div><div class="line">    classifier = &apos;sources&apos;</div><div class="line">    from android.sourceSets.main.java.sourceFiles</div><div class="line">&#125;</div><div class="line"></div><div class="line">artifacts &#123;</div><div class="line">    archives androidSourcesJar</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我只是打包到本地，你可以自己建立一个本地maven库。</p>
<h4 id="如要改进的地方"><a href="#如要改进的地方" class="headerlink" title="如要改进的地方"></a>如要改进的地方</h4><p>1：每次建立一个模块还是要做很多初始化的工作<br>2：maven-release-kline-aar.gradle每个模块都会有，希望后期能改进。<br>3:  debug模式下各个模块登录之后跳转问题<br>4：等等。。。。。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://blog.zhaiyifan.cn/2016/10/20/android-new-project-from-0-p11/" target="_blank" rel="external">从零开始的Android新项目11 - 组件化实践（1）</a> -<br> 大帅</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/04/Kotlin学习之hot-kotlin/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="GoGo (吴克伟)">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GoGo's home">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/04/Kotlin学习之hot-kotlin/" itemprop="url">Kotlin学习之hot_kotlin</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-04T10:06:03+08:00">
                2017-10-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>自从google IO大会之后，kotlin的热度一直在上升，<a href="http://kotlinlang.org/docs/reference/" target="_blank" rel="external">kotlin官方文档</a>，这里也有个中文的<a href="https://www.kotlincn.net/docs/reference/android-overview.html" target="_blank" rel="external">中文文档</a>，作为android开发也可以看<a href="https://antonioleiva.com/kotlin-android-developers/" target="_blank" rel="external">Kotlin for Android Developers </a>，接下来就说说在android方面的使用，记录一下自己的学习，大部分是通过Kotlin for Android Developers 学习到的。</p>
<h3 id="Delegated-Properties的使用（委托属性"><a href="#Delegated-Properties的使用（委托属性" class="headerlink" title="Delegated Properties的使用（委托属性)"></a>Delegated Properties的使用（委托属性)</h3><p>（1）这里简单的说明一下：用var修饰的可变属性和由val修饰的只读属性。由val修饰的只读属性使用的委托需要实现ReadOnlyProperty，而var修饰的可变属性则需要实现ReadWriteProperty。在调用被委托的属性的getter和setter时，对应操作会被委托给getValue()以及setValue()。<br>因为我在项目中使用了dagger2所以在app上要初始化ApplicationComponent提供给其它的component作为依赖，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">class HotApp : Application() &#123;</div><div class="line"></div><div class="line">    companion object &#123;</div><div class="line">        var graph: ApplicationComponent by DelegatesExt.notNullSingleValue()</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    override fun onCreate() &#123;</div><div class="line">        super.onCreate()</div><div class="line">        graph = DaggerApplicationComponent.builder()</div><div class="line">                .applicationModule(ApplicationModule(this))</div><div class="line">                .build()</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">object DelegatesExt &#123;</div><div class="line">    fun &lt;T&gt; notNullSingleValue() = NotNullSingleValueVar&lt;T&gt;()</div><div class="line">&#125;</div><div class="line"></div><div class="line">class NotNullSingleValueVar&lt;T&gt; &#123;</div><div class="line"></div><div class="line">    private var value: T? = null</div><div class="line"></div><div class="line">    operator fun getValue(thisRef: Any?, property: KProperty&lt;*&gt;): T &#123;</div><div class="line">        return value ?: throw IllegalStateException(&quot;$&#123;property.name&#125; not initialized&quot;)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    operator fun setValue(thisRef: Any?, property: KProperty&lt;*&gt;, value: T) &#123;</div><div class="line">        this.value = if (this.value == null) value</div><div class="line">        else throw IllegalStateException(&quot;$&#123;property.name&#125; already initialized&quot;)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>graph属性只会被初始化一次，当你还没有初始化就去使用和多次初始化会报IllegalStateException异常。其中最主要的是getValue和setValue方法。<br>thisRef —— 必须与 属性所有者 类型（对于扩展属性——指被扩展的类型）相同或者是它的超类型，<br>property —— 必须是类型 KProperty&lt;*&gt; 或其超类型，<br>这个函数必须返回与属性相同的类型（或其子类型），<br>new value —— 必须和属性同类型或者是它的超类型。</p>
<p>（2）Lazy（延迟属性）</p>
<p>大部分app都会使用到toolbar，这时候你可以使用个接口对其统一的处理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">interface ToolbarManager &#123;</div><div class="line">    val toolbar: Toolbar</div><div class="line">    var toolbarTitle: String</div><div class="line">        get() = toolbar.title.toString()</div><div class="line">        set(value) &#123;</div><div class="line">            toolbar.title = value</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    fun enableHomeAsUp(up: () -&gt; Unit) &#123;</div><div class="line">        toolbar.navigationIcon = createUpDrawable()</div><div class="line">        toolbar.setNavigationOnClickListener &#123; up() &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private fun createUpDrawable() = DrawerArrowDrawable(toolbar.ctx).apply &#123; progress = 1f &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用的时候</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">class MainActivity : AppCompatActivity(), ToolbarManager &#123;</div><div class="line"></div><div class="line">    override val toolbar by lazy &#123;</div><div class="line">        tool_bar</div><div class="line">    &#125;</div><div class="line">...省略代码...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因为当你不使用lazy关键字的时候，因为view都还没有创建所以一定找不到的。</p>
<p>（3）Observable（可观察属性）<br><a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.properties/-delegates/observable.html" target="_blank" rel="external">Delegates.observable()
</a></p>
<p>接受两个参数：初始值和修改时处理程序（handler）， 每当我们给属性赋值时会调用该处理程序（在赋值<em>后</em>执行），它有三个参数：被赋值的属性、旧值和新值。在android使用就是adapter的使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">var populars: List&lt;PopularModel&gt; by Delegates.observable(emptyList()) &#123; _, _, _ -&gt; notifyDataSetChanged() &#125;</div></pre></td></tr></table></figure>
<p>就是在adapter的populars属性变化的时候调用notifyDataSetChanged() 方法，后期为了为了学习DiffUtil加上了，把之前的代码去掉了，因为我的viewmodel是data类，会自动推断产生以下函数，equals()/hashCode() pair,toString()，componentN()，copy()这样就会方便使用。</p>
<h3 id="Extensions（扩展函数）"><a href="#Extensions（扩展函数）" class="headerlink" title="Extensions（扩展函数）"></a>Extensions（扩展函数）</h3><p>用户经常会短时间多次点击按钮，所以我们可以对View进行扩展，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">fun View.singleClick(l: (android.view.View?) -&gt; Unit) &#123;</div><div class="line">    setOnClickListener(SingleClickListener(</div><div class="line">    &#125;</div><div class="line"></div><div class="line">class SingleClickListener(val click: (v: View) -&gt; Unit) : View.OnClickListener &#123;</div><div class="line"></div><div class="line">    companion object &#123;</div><div class="line">        private val DOUBLE_CLICK_TIMEOUT = ViewConfiguration.getDoubleTapTimeout()</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private var lastClick: Long = 0</div><div class="line"></div><div class="line">    override fun onClick(v: View) &#123;</div><div class="line">        if (getLastClickTimeout() &gt; DOUBLE_CLICK_TIMEOUT) &#123;</div><div class="line">            lastClick = System.currentTimeMillis()</div><div class="line">            click(v)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private fun getLastClickTimeout(): Long &#123;</div><div class="line">        return System.currentTimeMillis() - lastClick</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样View就有singleClick()函数了，其实你对代码进行Bytecode会发现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">public final class ViewExtensionsKt &#123;</div><div class="line">   public static final void singleClick(@NotNull View $receiver, @NotNull Function1 l) &#123;</div><div class="line">      Intrinsics.checkParameterIsNotNull($receiver, &quot;$receiver&quot;);</div><div class="line">      Intrinsics.checkParameterIsNotNull(l, &quot;l&quot;);</div><div class="line">      $receiver.setOnClickListener((OnClickListener)(new SingleClickListener(l)));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这不就是java的静态方法，这样你就可以根据自己的项目要求去愉快的扩展了，Extensions are resolved statically，扩展函数是静态解析的。</p>
<h3 id="inline-function（内联函数）"><a href="#inline-function（内联函数）" class="headerlink" title="inline function（内联函数）"></a>inline function（内联函数）</h3><p>以下代码来自anko，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line">inline fun &lt;reified T : Activity&gt; Context.startActivity(vararg params: Pair&lt;String, Any&gt;) &#123;</div><div class="line">    Internals.internalStartActivity(this, T::class.java, params)</div><div class="line">&#125;</div><div class="line">object Internals &#123;</div><div class="line">    @JvmStatic</div><div class="line">    fun internalStartActivity(</div><div class="line">            ctx: Context,</div><div class="line">            activity: Class&lt;out Activity&gt;,</div><div class="line">            params: Array&lt;out Pair&lt;String, Any&gt;&gt;</div><div class="line">    ) &#123;</div><div class="line">        ctx.startActivity(createIntent(ctx, activity, params))</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @JvmStatic</div><div class="line">    fun &lt;T&gt; createIntent(ctx: Context, clazz: Class&lt;out T&gt;, params: Array&lt;out Pair&lt;String, Any?&gt;&gt;): Intent &#123;</div><div class="line">        val intent = Intent(ctx, clazz)</div><div class="line">        if (params.isNotEmpty()) fillIntentArguments(intent, params)</div><div class="line">        return intent</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @JvmStatic</div><div class="line">    private fun fillIntentArguments(intent: Intent, params: Array&lt;out Pair&lt;String, Any?&gt;&gt;) &#123;</div><div class="line">        params.forEach &#123;</div><div class="line">            val value = it.second</div><div class="line">            when (value) &#123;</div><div class="line">                null -&gt; intent.putExtra(it.first, null as Serializable?)</div><div class="line">                is Int -&gt; intent.putExtra(it.first, value)</div><div class="line">                is Long -&gt; intent.putExtra(it.first, value)</div><div class="line">                is CharSequence -&gt; intent.putExtra(it.first, value)</div><div class="line">                is String -&gt; intent.putExtra(it.first, value)</div><div class="line">                is Float -&gt; intent.putExtra(it.first, value)</div><div class="line">                is Double -&gt; intent.putExtra(it.first, value)</div><div class="line">                is Char -&gt; intent.putExtra(it.first, value)</div><div class="line">                is Short -&gt; intent.putExtra(it.first, value)</div><div class="line">                is Boolean -&gt; intent.putExtra(it.first, value)</div><div class="line">                is Serializable -&gt; intent.putExtra(it.first, value)</div><div class="line">                is Bundle -&gt; intent.putExtra(it.first, value)</div><div class="line">                is Parcelable -&gt; intent.putExtra(it.first, value)</div><div class="line">                is Array&lt;*&gt; -&gt; when &#123;</div><div class="line">                    value.isArrayOf&lt;CharSequence&gt;() -&gt; intent.putExtra(it.first, value)</div><div class="line">                    value.isArrayOf&lt;String&gt;() -&gt; intent.putExtra(it.first, value)</div><div class="line">                    value.isArrayOf&lt;Parcelable&gt;() -&gt; intent.putExtra(it.first, value)</div><div class="line">                    else -&gt; throw RuntimeException(&quot;Intent extra $&#123;it.first&#125; has wrong type $&#123;value.javaClass.name&#125;&quot;)</div><div class="line">                &#125;</div><div class="line">                is IntArray -&gt; intent.putExtra(it.first, value)</div><div class="line">                is LongArray -&gt; intent.putExtra(it.first, value)</div><div class="line">                is FloatArray -&gt; intent.putExtra(it.first, value)</div><div class="line">                is DoubleArray -&gt; intent.putExtra(it.first, value)</div><div class="line">                is CharArray -&gt; intent.putExtra(it.first, value)</div><div class="line">                is ShortArray -&gt; intent.putExtra(it.first, value)</div><div class="line">                is BooleanArray -&gt; intent.putExtra(it.first, value)</div><div class="line">                else -&gt; throw RuntimeException(&quot;Intent extra $&#123;it.first&#125; has wrong type $&#123;value.javaClass.name&#125;&quot;)</div><div class="line">            &#125;</div><div class="line">            return@forEach</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这段代码包含的知识点很多，这里说一下reified修饰符“具体化”， 几乎就像是一个普通的类一样，正常的操作符如 !is 和 as 现在都能用了，在调用的时候要是具体的类型而不能是范型。</p>
<h3 id="项目介绍：hot项目之前使用java的时候写过链接，这里就不再过多的介绍了，kotlin-hot地址-项目采用第三方框架如下："><a href="#项目介绍：hot项目之前使用java的时候写过链接，这里就不再过多的介绍了，kotlin-hot地址-项目采用第三方框架如下：" class="headerlink" title="项目介绍：hot项目之前使用java的时候写过链接，这里就不再过多的介绍了，kotlin_hot地址,项目采用第三方框架如下："></a>项目介绍：hot项目之前使用java的时候写过<a href="http://www.jianshu.com/p/b1da0387f805" target="_blank" rel="external">链接</a>，这里就不再过多的介绍了，<a href="https://github.com/zj-wukewei/Hot_Kotlin" target="_blank" rel="external">kotlin_hot地址</a>,项目采用第三方框架如下：</h3><ul>
<li>Rxjava</li>
<li>MVP</li>
<li>Dagger2</li>
<li>Retrofit</li>
<li>OkHttp3</li>
<li>Glide</li>
<li>Kotlin<br>通过此次的学习自己也加深了对kotlin的理解，虽然还处于小白阶段，希望能帮助到你，要是有写的不对的地方望指出，一起学习进步。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/04/databinding和CleanArchitecture框架的使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="GoGo (吴克伟)">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GoGo's home">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/04/databinding和CleanArchitecture框架的使用/" itemprop="url">databinding和CleanArchitecture框架的使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-04T09:55:24+08:00">
                2017-10-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近在做一个公司内部的app，框架方面使用了CleanArchitecture，因为本身app的业务逻辑不是很复杂，所以在使用的时候我没有写presenter这一层，只有当页面逻辑比较复杂的时候还会去写presenter层，主要还是懒得去写那么多接口。</p>
<h3 id="databinding的使用"><a href="#databinding的使用" class="headerlink" title="databinding的使用"></a>databinding的使用</h3><h4 id="textview"><a href="#textview" class="headerlink" title="textview"></a>textview</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&lt;TextView</div><div class="line">            android:layout_width=&quot;60dp&quot;</div><div class="line">            android:layout_height=&quot;wrap_content&quot;</div><div class="line">            android:layout_marginLeft=&quot;20dp&quot;</div><div class="line">            android:text=&quot;@&#123;item.startedStatus&#125;&quot;</div><div class="line">            android:textColor=&quot;@color/dicuss_content_text_color&quot;</div><div class="line">            tools:text=&quot;启动状态&quot;/&gt;</div><div class="line"></div><div class="line">&lt;TextView</div><div class="line">    android:layout_width=&quot;wrap_content&quot;</div><div class="line">    android:layout_height=&quot;wrap_content&quot;</div><div class="line">    android:layout_marginLeft=&quot;8dp&quot;</div><div class="line">    android:text=&quot;@&#123;@string/monthperformance(totalContributionCount, totalInGroupCount)&#125;&quot;</div><div class="line">    android:textColor=&quot;@color/white&quot;</div><div class="line">    android:textSize=&quot;13sp&quot;</div><div class="line">    tools:text=&quot;总计：贡献额：3928191.21 元   入组数：102910 例&quot;/&gt;</div></pre></td></tr></table></figure>
<p>使用多个的的时候在strings里面定义的记得要写上%1和%2要不然会报错的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;string name=&quot;monthperformance&quot;&gt;总计：贡献额：%1$d 元   入组数：%2$d 例&lt;/string&gt;</div></pre></td></tr></table></figure>
<h4 id="view的VISIBLE和GONE"><a href="#view的VISIBLE和GONE" class="headerlink" title="view的VISIBLE和GONE"></a>view的VISIBLE和GONE</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">  &lt;data&gt;</div><div class="line">        &lt;import type=&quot;android.view.View&quot;/&gt;</div><div class="line">        &lt;variable</div><div class="line">            name=&quot;item&quot;</div><div class="line">            type=&quot;com.xxx.xxxx.model.QuestionModel&quot;/&gt;</div><div class="line">        &lt;variable</div><div class="line">            name=&quot;presenter&quot;</div><div class="line">            type=&quot;com.xxx.xxx.view.business.common.DetailActivity.Presenter&quot;/&gt;</div><div class="line">    &lt;/data&gt;</div><div class="line"></div><div class="line">&lt;ImageView</div><div class="line">          android:layout_width=&quot;wrap_content&quot;</div><div class="line">          android:layout_height=&quot;wrap_content&quot;</div><div class="line">          android:onClick=&quot;@&#123;() -&gt; presenter.onTopClick(item)&#125;&quot;</div><div class="line">          android:src=&quot;@&#123;item.topStatus ? @drawable/ic_had_up : @drawable/ic_up&#125;&quot;</div><div class="line">          android:visibility=&quot;@&#123;item.myQuestion ? View.VISIBLE : View.GONE&#125;&quot;</div><div class="line">          tools:src=&quot;@drawable/ic_had_up&quot;/&gt;</div></pre></td></tr></table></figure>
<p>这部分很好的说明了点击事件的使用和view的显示和隐藏，也可以根据状态来选择不同的src。</p>
<h4 id="onLongClick事件"><a href="#onLongClick事件" class="headerlink" title="onLongClick事件"></a>onLongClick事件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"> &lt;LinearLayout</div><div class="line">           android:layout_width=&quot;wrap_content&quot;</div><div class="line">           android:layout_height=&quot;wrap_content&quot;</div><div class="line">           android:gravity=&quot;center_horizontal&quot;</div><div class="line">           android:onClick=&quot;@&#123;() -&gt; presenter.onItemClick(item)&#125;&quot;</div><div class="line">           android:onLongClick=&quot;@&#123;() -&gt; presenter.onItemLongClick(item)&#125;&quot;</div><div class="line">           android:orientation=&quot;vertical&quot;</div><div class="line">           android:paddingRight=&quot;25dp&quot;</div><div class="line">           android:visibility=&quot;@&#123;item.showProgress ? View.INVISIBLE : View.VISIBLE&#125;&quot;&gt;</div><div class="line">....省略代码</div></pre></td></tr></table></figure>
<p>记得在定义方法的时候记得要有个boolean类型的返回，当时没有注意到导致了databinding生成不了，后来看了官网才发现，怪自己啊。。。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">public boolean onItemLongClick(FileModel model) &#123;</div><div class="line">  </div><div class="line">    return true;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="RecyclerView方面的使用"><a href="#RecyclerView方面的使用" class="headerlink" title="RecyclerView方面的使用"></a>RecyclerView方面的使用</h4><p>使用了<a href="https://github.com/markzhai/DataBindingAdapter" target="_blank" rel="external">databindingAdapter</a>，代码非常的简单，使用起来也非常的方便好比</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mAdapter = new MultiTypeAdapter(this);</div><div class="line">       mAdapter.addViewTypeToLayoutMap(PROJECT_VIEW_TYPE, R.layout.item_discuss_project);</div><div class="line">       mAdapter.addViewTypeToLayoutMap(STUDY_VIEW_TYPE, R.layout.item_discuss_study);</div><div class="line">       mAdapter.addViewTypeToLayoutMap(EXPERIENCE_VIEW_TYPE, R.layout.item_discuss_experience);</div><div class="line">       mAdapter.setPresenter(new Presenter());</div><div class="line">       getRecyclerViewWithFooter().setAdapter(mAdapter);</div><div class="line">       getRecyclerViewWithFooter().setVerticalLinearLayout();</div></pre></td></tr></table></figure>
<p>这是我RecyclerView多个布局的定义，在xml中使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;data&gt;</div><div class="line"></div><div class="line">       &lt;import type=&quot;android.view.View&quot;/&gt;</div><div class="line"></div><div class="line">       &lt;variable</div><div class="line">           name=&quot;item&quot;</div><div class="line">           type=&quot;com.xxx.xxx.model.CommentModel&quot;/&gt;</div><div class="line"></div><div class="line">       &lt;variable</div><div class="line">           name=&quot;presenter&quot;</div><div class="line">           type=&quot;com.xxx.xxx.listener.CommentPresenter&quot;/&gt;</div><div class="line">   &lt;/data&gt;</div></pre></td></tr></table></figure>
<p>就是数据的name为item和事件的name为presenter。更多的使用可以自己去看github上的介绍。</p>
<h4 id="图片访问方面"><a href="#图片访问方面" class="headerlink" title="图片访问方面"></a>图片访问方面</h4><p>因为这个app图片的使用上还是蛮多的，所以选择了Fresco（也看中它能在xml中写一些配置），不太好的地方就是包的体积大了些，但是还是能接受的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;com.xxx.xxx.view.widget.MyDraweeView</div><div class="line">                android:layout_width=&quot;@dimen/user_avater_w&quot;</div><div class="line">                android:layout_height=&quot;@dimen/user_avater_w&quot;</div><div class="line">                app:failureImage=&quot;@drawable/ic_avatar&quot;</div><div class="line">                app:placeholderImage=&quot;@drawable/ic_avatar&quot;</div><div class="line">                app:roundAsCircle=&quot;true&quot;</div><div class="line">                app:url=&quot;@&#123;item.avatar&#125;&quot;/&gt;</div></pre></td></tr></table></figure>
<p>这里的MyDraweeView是继承SimpleDraweeView因为fresco是不支持自适应的，所以在这里你可以自己设置view的LayoutParams来达到目的。</p>
<h3 id="CleanArchitecture框架的使用"><a href="#CleanArchitecture框架的使用" class="headerlink" title="CleanArchitecture框架的使用"></a>CleanArchitecture框架的使用</h3><h4 id="api和repository"><a href="#api和repository" class="headerlink" title="api和repository"></a>api和repository</h4><p>api和repository，我把各个模块的api都分开定义，这样在分模块开发的时候，可以各自定义api<br><img src="http://upload-images.jianshu.io/upload_images/1353151-0ff500dfe4defd74.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="api.png"></p>
<h4 id="module设计"><a href="#module设计" class="headerlink" title="module设计"></a>module设计</h4><p>dagger，在定义module的时候我采用的是new的方式，而不是使用在构造函数上加@Inject，因为采用new的方式能达到局部单例的效果，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">@Module</div><div class="line">public class ProjectModule &#123;</div><div class="line"></div><div class="line">    public ProjectModule() &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Provides</div><div class="line">    @PerActivity</div><div class="line">    ProjectSearchUseCase provideProjectSearchUseCase(ProjectRepository projectRepository,</div><div class="line">                                                     ThreadExecutor threadExecutor,</div><div class="line">                                                     PostExecutionThread postExecutionThread) &#123;</div><div class="line">        return new ProjectSearchUseCase(projectRepository, threadExecutor, postExecutionThread);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">this.provideProjectHistoryUseCaseeProvider =</div><div class="line">        DoubleCheck.provider(</div><div class="line">            ProjectModule_ProvideProjectHistoryUseCaseeFactory.create(</div><div class="line">                builder.projectModule,</div><div class="line">                userRepositoryProvider,</div><div class="line">                threadExecutorProvider,</div><div class="line">                postExecutionThreadProvider));</div></pre></td></tr></table></figure>
<p>这里的doublecheck就是起到这里这个效果，dagger中的单例也是如此，而不是你加上@Singleton就是单例了，是要在Application中才能达到单例的效果。这里就不展开了。</p>
<h4 id="component设计"><a href="#component设计" class="headerlink" title="component设计"></a>component设计</h4><p>component也是采用的分模块定义，在fragment和activity使用上我也是采用和github上一样的方法在activity上提供component，activity实现HasComponent接口，在fragment里面<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">protected &lt;C&gt; C getComponent(Class&lt;C&gt; componentType) &#123;</div><div class="line">       return componentType.cast(((HasComponent&lt;C&gt;) getActivity()).getComponent());</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>就能获取到activity的component了。</p>
<h4 id="数据模型的转换"><a href="#数据模型的转换" class="headerlink" title="数据模型的转换"></a>数据模型的转换</h4><p>CleanArchitecture中的各种DataMapper，之前不是很理解这个是干什么用的，github上在data层和presentation两层同时使用了。后来在实践的时候发现presentation这层的转化还是非常有必要的。当后台接口返回的数据格式不是你想要的时候，（后台还懒得去帮你改）你可以定义一层转换，还是就是viewmodel中还包含了一些接口返回没有的字段，好比一个view是否显示<br><img src="http://upload-images.jianshu.io/upload_images/1353151-70419deb3675f8b1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="datamapper.png">当后台返回的数据类型不是你想要的好比boolean类型返回的是string的‘0’和‘1’，还有就是null的判断，尽量的让view获取到的数据不是空对象。</p>
<h4 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h4><p>缓存方面，本身app就没有多大的缓存，只是记录一下搜索记录，没有引入什么第三方的数据库之类的，只是很简单的把搜索记录存入一个文件中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">if (!TextUtils.isEmpty(content)) &#123;</div><div class="line">          final File file = this.buildFile(fileName);</div><div class="line">          List&lt;String&gt; history = getHistoryList(fileName, false);</div><div class="line">          if (history.contains(content)) &#123;</div><div class="line">              history.remove(content);</div><div class="line">          &#125;</div><div class="line">          history.add(content);</div><div class="line">          final String jsonString = mGson.toJson(history).toString();</div><div class="line">          this.executeAsynchronously(new CacheWriter(mFileManager, file, jsonString));</div><div class="line">      &#125;</div></pre></td></tr></table></figure>
<p>在每次搜索的时候保存搜索记录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">   public Observable&lt;ProjectEntity&gt; getSearchData(ProjectSearch search, boolean isSave) &#123;</div><div class="line">       return mProjectApi.getListAndSearch(search)</div><div class="line">               .doOnNext(entity -&gt; &#123;</div><div class="line">                   if (isSave) &#123;</div><div class="line">                       ProjectDataRepository.this.mCacheImp.putProjectSearchHistory(search.getKey_Words());</div><div class="line">                   &#125;</div><div class="line">               &#125;)</div><div class="line">               .compose(RepositoryUtils.handleResult());</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h3 id="RecyclerView嵌套webview的问题"><a href="#RecyclerView嵌套webview的问题" class="headerlink" title="RecyclerView嵌套webview的问题"></a>RecyclerView嵌套webview的问题</h3><p>记录一次RecyclerView嵌套webview的问题，一开始我直接在layout布局里面是这样写的，发现页面显示不全（原因未找到。。。要是有人知道原因欢迎告知）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;LinearLayout</div><div class="line">       android:layout_width=&quot;match_parent&quot;</div><div class="line">       android:layout_height=&quot;match_parent&quot;</div><div class="line">       android:background=&quot;@color/white&quot;</div><div class="line">       android:orientation=&quot;vertical&quot;&gt;</div><div class="line"></div><div class="line">       &lt;WebView</div><div class="line">           android:layout_width=&quot;match_parent&quot;</div><div class="line">           android:layout_height=&quot;0dp&quot;</div><div class="line">           android:layout_weight=&quot;1&quot;</div><div class="line">           app:weburl=&quot;@&#123;item.studyContent&#125;&quot;/&gt;</div><div class="line"></div><div class="line">       &lt;include layout=&quot;@layout/layout_detail_discuss_header&quot;/&gt;</div><div class="line"></div><div class="line">   &lt;/LinearLayout&gt;</div></pre></td></tr></table></figure>
<p>解决方法就是自定义一个view继承LinearLayout，采用动态生成webview这样就能显示全了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">setOrientation(VERTICAL);</div><div class="line">      mWeb = new WebView(getContext().getApplicationContext(), null);</div><div class="line">      WebSettings setting = mWeb.getSettings();</div><div class="line">      setting.setJavaScriptEnabled(true);</div><div class="line">      setting.setBuiltInZoomControls(true);</div><div class="line">      setting.setUseWideViewPort(true);</div><div class="line">      setting.setLoadWithOverviewMode(true);</div><div class="line">      setting.setLayoutAlgorithm(WebSettings.LayoutAlgorithm.NARROW_COLUMNS);</div><div class="line">      LinearLayout.LayoutParams params = new LinearLayout.LayoutParams(LinearLayout.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.WRAP_CONTENT);</div><div class="line">      addView(mWeb, params);</div><div class="line">      LinearLayout tagViewsLayout = (LinearLayout) LayoutInflater.from(getContext()).inflate(R.layout.layout_detail_discuss_header, null);</div><div class="line">      addView(tagViewsLayout);</div></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>使用databinding的时候确实让我感受到了比平时写的要快一些，再也不是写id了也不用设置值了，写起来还是比较爽的，期间也遇到了一些问题，就是使用databinding和dagger一起使用的时候报错，有时候定位不是很准确，但是只要认真看看还是能找得到错误之处的，可能是因为我还是能力还不够的问题。通过这次的实践，让我更加深刻的理解了CleanArchitecture这个框架，也体会到了一些好的框架带来的好处。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/04/FragmentTabHost使用遇到的问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="GoGo (吴克伟)">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GoGo's home">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/04/FragmentTabHost使用遇到的问题/" itemprop="url">FragmentTabHost使用遇到的问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-04T09:45:16+08:00">
                2017-10-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文记录一下在使用fragmentTabHost的时候所遇到的问题。</p>
<h3 id="fragment的重新建立的原因"><a href="#fragment的重新建立的原因" class="headerlink" title="fragment的重新建立的原因"></a>fragment的重新建立的原因</h3><p>原生的fragmenttabhost在切换tab的时候，会导致fragment的重新建立</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">private FragmentTransaction doTabChanged(String tabId, FragmentTransaction ft) &#123;</div><div class="line">       .......省略部分代码</div><div class="line">        if (mLastTab != newTab) &#123;</div><div class="line">            if (ft == null) &#123;</div><div class="line">                ft = mFragmentManager.beginTransaction();</div><div class="line">            &#125;</div><div class="line">            if (mLastTab != null) &#123;</div><div class="line">                if (mLastTab.fragment != null) &#123;</div><div class="line">                    ft.detach(mLastTab.fragment);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            if (newTab != null) &#123;</div><div class="line">                if (newTab.fragment == null) &#123;</div><div class="line">                    newTab.fragment = Fragment.instantiate(mContext,</div><div class="line">                            newTab.clss.getName(), newTab.args);</div><div class="line">                    ft.add(mContainerId, newTab.fragment, newTab.tag);</div><div class="line">                &#125; else &#123;</div><div class="line">                    ft.attach(newTab.fragment);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            mLastTab = newTab;</div><div class="line">        &#125;</div><div class="line">        return ft;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>很清楚的看到在切换的时候上个fragment调用detach，新的fragment调用的是attach，所以会导致重新初始化。</p>
<h3 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h3><p>就是把源码复杂一份，修改这个部分代码就可以解决了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">if (mLastTab != null) &#123;</div><div class="line">                if (mLastTab.fragment != null) &#123;</div><div class="line">                    ft.hide(mLastTab.fragment);  //detach改为hide</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            if (newTab.fragment == null) &#123;</div><div class="line">                newTab.fragment = Fragment.instantiate(mContext,</div><div class="line">                        newTab.clss.getName(), newTab.args);</div><div class="line">                ft.add(mContainerId, newTab.fragment, newTab.tag);</div><div class="line">            &#125; else &#123;</div><div class="line">                ft.show(newTab.fragment); //attach改为show</div><div class="line">            &#125;</div></pre></td></tr></table></figure>
<h3 id="要求是当点击其中一个tab的时候不导致fragment的切换，而是做一些其他的操作"><a href="#要求是当点击其中一个tab的时候不导致fragment的切换，而是做一些其他的操作" class="headerlink" title="要求是当点击其中一个tab的时候不导致fragment的切换，而是做一些其他的操作"></a>要求是当点击其中一个tab的时候不导致fragment的切换，而是做一些其他的操作</h3><p>解决办法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">public class NoTabFragmentTabHost extends FragmentTabHost &#123;</div><div class="line">	</div><div class="line">	private String mCurrentTag;</div><div class="line">	</div><div class="line">	private String mNoTabChangedTag;</div><div class="line">	</div><div class="line">	public NoTabFragmentTabHost(Context context, AttributeSet attrs) &#123;</div><div class="line">		super(context, attrs);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	@Override</div><div class="line">	public void onTabChanged(String tag) &#123;</div><div class="line">		</div><div class="line">		if (tag.equals(mNoTabChangedTag)) &#123;</div><div class="line">			setCurrentTabByTag(mCurrentTag);</div><div class="line">		&#125; else &#123;</div><div class="line">			super.onTabChanged(tag);</div><div class="line">			mCurrentTag = tag;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	public void setNoTabChangedTag(String tag) &#123;</div><div class="line">		this.mNoTabChangedTag = tag;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="app当再次点击当前tab的时候会去刷新操作"><a href="#app当再次点击当前tab的时候会去刷新操作" class="headerlink" title="app当再次点击当前tab的时候会去刷新操作"></a>app当再次点击当前tab的时候会去刷新操作</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mTabHost.getTabWidget().getChildAt(i).setOnTouchListener(this);</div></pre></td></tr></table></figure>
<p>给每个的tabwidget的子view设置监听事件，再onTouch的处理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">boolean consumed = false;</div><div class="line">       if (event.getAction() == MotionEvent.ACTION_DOWN</div><div class="line">               &amp;&amp; v.equals(mTabHost.getCurrentTabView())) &#123;</div><div class="line"></div><div class="line">              Log.d(&quot;再次点击了&quot;, &quot;再次点击了&quot;);</div><div class="line">               consumed = true;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">return consumed;</div></pre></td></tr></table></figure>
<p>在这里你就可以获取当前的fragment再处理逻辑了。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/04/原生项目（hot）集成react－native/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="GoGo (吴克伟)">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GoGo's home">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/04/原生项目（hot）集成react－native/" itemprop="url">原生项目（hot）集成react－native</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-04T09:33:35+08:00">
                2017-10-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近react-native(以下简称rn)的技术越来越活，国内的使用情况也越来越多，国内的氛围也越来越好，其实我是从去年就接触了一下rn，当时我学习了一个多星期，然后刚好处于要换工作就没有学习了，刚好最近有点空闲的时间，就再次去学习，只能说rn的更新速度太快了，很多之前的写法都变了，只能从头开始，但是一整个项目都采用rn来构建还不是很现实，所以国内很多的也是集成rn，所以我也来凑凑热闹。</p>
<h3 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h3><p>在项目的build.gradle下添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">allprojects &#123;</div><div class="line">    repositories &#123;</div><div class="line">        mavenLocal()</div><div class="line">        jcenter()</div><div class="line">        maven &#123;</div><div class="line">            // All of React Native (JS, Android binaries) is installed from npm</div><div class="line">            url &quot;$rootDir/node_modules/react-native/android&quot;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="app的实现ReactApplication接口"><a href="#app的实现ReactApplication接口" class="headerlink" title="app的实现ReactApplication接口"></a>app的实现ReactApplication接口</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"> */</div><div class="line">public class App extends Application implements ReactApplication&#123;</div><div class="line"></div><div class="line">    private static App appContext;</div><div class="line">    private static AppComponent mAppComponent;</div><div class="line"></div><div class="line">    private final ReactNativeHost mReactNativeHost = new ReactNativeHost(this) &#123;</div><div class="line">        @Override</div><div class="line">        protected boolean getUseDeveloperSupport() &#123;</div><div class="line">            return BuildConfig.DEBUG;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        protected List&lt;ReactPackage&gt; getPackages() &#123;</div><div class="line">            return Arrays.&lt;ReactPackage&gt;asList(</div><div class="line">                    new MainReactPackage()</div><div class="line">            );</div><div class="line">        &#125;</div><div class="line">    &#125;;</div></pre></td></tr></table></figure>
<h3 id="AndroidManifest-xml"><a href="#AndroidManifest-xml" class="headerlink" title="AndroidManifest.xml"></a>AndroidManifest.xml</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;uses-permission android:name=&quot;android.permission.INTERNET&quot;&gt;&lt;/uses-permission&gt;</div><div class="line">&lt;activity android:name=&quot;com.facebook.react.devsupport.DevSettingsActivity&quot;/&gt;</div></pre></td></tr></table></figure>
<p>加入以下的activity可以在摇一摇出现rn的配置页面。</p>
<h3 id="activity来继承ReactActivity"><a href="#activity来继承ReactActivity" class="headerlink" title="activity来继承ReactActivity"></a>activity来继承ReactActivity</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">public class MainActivity extends ReactActivity &#123;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Returns the name of the main component registered from JavaScript.</div><div class="line">     * This is used to schedule rendering of the component.</div><div class="line">     */</div><div class="line">    @Override</div><div class="line">    protected String getMainComponentName() &#123;</div><div class="line">        return &quot;MyHot&quot;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这里介绍一篇大帅写的<a href="http://www.jianshu.com/p/ad887f61448a?utm_campaign=haruki&amp;utm_content=note&amp;utm_medium=reader_share&amp;utm_source=weixin" target="_blank" rel="external">React Native 0.31 Bundle 预加载优化</a>主要解决从原生页面到rn页面会有短暂的白屏。使用方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">    compile &quot;com.github.moduth:react-native-preloader:0.31.0&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>把之前继承ReactActivity变成继承MrReactActivity</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">public class MyReactActivity extends MrReactActivity &#123;</div><div class="line">    public static final ReactInfo reactInfo = new ReactInfo(&quot;MyHot&quot;, null);</div><div class="line"></div><div class="line"></div><div class="line">    @Override</div><div class="line">    protected String getMainComponentName() &#123;</div><div class="line">        return reactInfo.getMainComponentName();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public ReactInfo getReactInfo() &#123;</div><div class="line">        return reactInfo;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在调用rn页面调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ReactPreLoader.init(this, MyReactActivity.reactInfo);</div></pre></td></tr></table></figure>
<p>这样就能很好的解决上述的问题。</p>
<h3 id="react-native端的代码"><a href="#react-native端的代码" class="headerlink" title="react-native端的代码"></a>react-native端的代码</h3><p>在rn中我引入了redux，以下就贴出关键行代码，在最外层</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">import configureStore from &apos;./store/store.js&apos;</div><div class="line">import App from &apos;./containes/App.js&apos;</div><div class="line"></div><div class="line">const store = configureStore();</div><div class="line">class rootApp extends Component &#123;</div><div class="line">	render() &#123;</div><div class="line">		return (</div><div class="line">			&lt;Provider store=&#123;store&#125;&gt;</div><div class="line">               &lt;App/&gt;</div><div class="line">            &lt;/Provider&gt;</div><div class="line">		)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">export default rootApp;</div></pre></td></tr></table></figure>
<p>同时个actions的文件夹里面放着各种的操作，以下是我的newsList的代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">import * as types from &quot;../constants/ActionTypes.js&quot;;</div><div class="line">import * as Services from &quot;../utils/Services.js&quot;;</div><div class="line">import &#123;</div><div class="line">	NEW_LIST</div><div class="line">&#125; from &quot;../constants/Urls.js&quot;;</div><div class="line"></div><div class="line"></div><div class="line">export function fetchNews(loading, isRefresh, isLoadMore, pn) &#123;</div><div class="line">	return dispatch =&gt; &#123;</div><div class="line">		dispatch(fetchNewsList(loading, isRefresh, isLoadMore));</div><div class="line">		Services.getNewList(NEW_LIST, pn)</div><div class="line">			.then(result =&gt; &#123;</div><div class="line">				dispatch(receiveNewsList(result));</div><div class="line">			&#125;);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">function fetchNewsList(loading, isRefresh, isLoadMore) &#123;</div><div class="line">	return &#123;</div><div class="line">		type: types.FE_NEWLIST,</div><div class="line">		loading: loading,</div><div class="line">		isRefresh: isRefresh,</div><div class="line">		isLoadMore: isLoadMore</div><div class="line">	&#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line">function receiveNewsList(newsList) &#123;</div><div class="line">	return &#123;</div><div class="line">		type: types.RE_NEWLIST,</div><div class="line">		newsList: newsList</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>还有就是ruducers文件夹下的和action所对应的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">import * as types from &apos;../constants/ActionTypes&apos;;</div><div class="line"></div><div class="line">const initialState = &#123;</div><div class="line">	loading: true,</div><div class="line">	isRefresh: false,</div><div class="line">	isLoadMore: false,</div><div class="line">	newsList: []</div><div class="line">&#125;</div><div class="line"></div><div class="line">export default function revicesNewsList(state = initialState, action) &#123;</div><div class="line">	switch (action.type) &#123;</div><div class="line"></div><div class="line">		case types.FE_NEWLIST:</div><div class="line">			return Object.assign(&#123;&#125;, state, &#123;</div><div class="line">				loading: action.loading,</div><div class="line">				isRefresh: action.isRefresh,</div><div class="line">				isLoadMore: action.isLoadMore,</div><div class="line"></div><div class="line">			&#125;);</div><div class="line">		case types.RE_NEWLIST:</div><div class="line">			return Object.assign(&#123;&#125;, state, &#123;</div><div class="line">				loading: false,</div><div class="line">				isRefresh: false,</div><div class="line">				isLoadMore: false,</div><div class="line">				newsList: state.isLoadMore ? state.newsList.concat(action.newsList) : action.newsList,</div><div class="line">			&#125;);</div><div class="line"></div><div class="line">		default:</div><div class="line">			return state;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>还有就是一个转化的</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">import &#123;</div><div class="line">  connect</div><div class="line">&#125; from &apos;react-redux&apos;;</div><div class="line">import News from &quot;../pages/News.js&quot;;</div><div class="line">import &#123;</div><div class="line">  bindActionCreators</div><div class="line">&#125; from &apos;redux&apos;;</div><div class="line">import * as newsAction from &apos;../actions/newsList.js&apos;;</div><div class="line">class NewsContainer extends Component &#123;</div><div class="line"></div><div class="line">  render() &#123;</div><div class="line">    return (</div><div class="line">      &lt;News &#123;...this.props&#125; /&gt;</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">function mapStateToProps(state) &#123;</div><div class="line">  const &#123;</div><div class="line">    news</div><div class="line">  &#125; = state;</div><div class="line">  return &#123;</div><div class="line">    news</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">function mapDispatchToProp(dispatch) &#123;</div><div class="line">  return &#123;</div><div class="line">    actions: bindActionCreators(newsAction, dispatch)</div><div class="line">  &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line">export default connect(mapStateToProps, mapDispatchToProp)(NewsContainer);</div></pre></td></tr></table></figure>
<p>这样在使用的时候就是调用action的方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">componentDidMount() &#123;</div><div class="line">   const &#123;</div><div class="line">     actions</div><div class="line">   &#125; = this.props;</div><div class="line">   actions.fetchNews(true, false, false, page);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>接受到数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">render() &#123;</div><div class="line">     const &#123;</div><div class="line">       navigator,</div><div class="line">       news</div><div class="line">     &#125; = this.props;</div><div class="line">     return (</div><div class="line">       &lt;View style=&#123;styles.container&#125;&gt;</div><div class="line">     &lt;Header title=&quot;体育&quot; navigator= &#123;navigator&#125;/&gt;</div><div class="line">     &#123;this.renderContent()&#125;</div><div class="line">     &lt;/View&gt;</div><div class="line"></div><div class="line">     )</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>这样以后要是添加新的页面就很清楚了，在action里面添加动作，在reducers添加action的处理器，这样就很清晰了。<br>我添加了一个Services，来获取数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">const HOST = &quot;http://apis.baidu.com/&quot;;</div><div class="line">import FetchHttpClient, &#123;</div><div class="line">	query,</div><div class="line">	header</div><div class="line">&#125; from &apos;fetch-http-client&apos;;</div><div class="line">import &#123;</div><div class="line">	toastShort</div><div class="line">&#125; from &quot;./ToastUtil.js&quot;;</div><div class="line"></div><div class="line">let client = new FetchHttpClient(HOST);</div><div class="line"></div><div class="line">export function getNewList(url, pnSize) &#123;</div><div class="line"></div><div class="line">	return getClient().get(url, &#123;</div><div class="line">			query: &#123;</div><div class="line">				num: 10,</div><div class="line">				pn: pnSize</div><div class="line">			&#125;,</div><div class="line">		&#125;).then(filterJSON)</div><div class="line">		.then(filterStatus)</div><div class="line">		.catch((error) =&gt; &#123;</div><div class="line">			toastShort(&apos;网络发生错误,请重试!&apos;)</div><div class="line">		&#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">function getClient() &#123;</div><div class="line">	client.addMiddleware(query());</div><div class="line">	client.addMiddleware(request =&gt; &#123;</div><div class="line">		request.options.headers[&apos;apikey&apos;] = &apos;ff27ef67506b2c0738a3252b01f8d564&apos;;</div><div class="line">	&#125;);</div><div class="line">	return client;</div><div class="line">&#125;</div><div class="line"></div><div class="line">function filterStatus(res) &#123;</div><div class="line">	if (res.code === 200) &#123;</div><div class="line">		return res.newslist;</div><div class="line">	&#125; else &#123;</div><div class="line">		toastShort(res.msg);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">function filterJSON(res) &#123;</div><div class="line">	return res.json();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>通过这次的学习，让我了解了react-native，因为react-native的周边产品还是很多的，也学习了redux是的reacr-native也有一个小小的框架实现，使得代码结构更加的清晰，本人rn的水平有限，要是有不对的地方，还请指出和谅解。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.png"
                alt="GoGo (吴克伟)" />
            
              <p class="site-author-name" itemprop="name">GoGo (吴克伟)</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/zj-wukewei" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="http://www.jianshu.com/u/80402b2535d3" target="_blank" title="简书">
                    
                      <i class="fa fa-fw fa-简书"></i>简书</a>
                </span>
              
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">GoGo (吴克伟)</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  








  





  

  

  

  

  

  

</body>
</html>
