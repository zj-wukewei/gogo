<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="GoGo&#39;s home">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="GoGo&#39;s home">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="GoGo&#39;s home">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>GoGo's home</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">GoGo's home</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/16/发布React组件库到npm私服/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="GoGo (吴克伟)">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GoGo's home">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/16/发布React组件库到npm私服/" itemprop="url">发布React组件库到npm私服</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-16T00:09:07+08:00">
                2019-11-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="使用-nexus-搭建-npm-私服"><a href="#使用-nexus-搭建-npm-私服" class="headerlink" title="使用 nexus 搭建 npm 私服"></a>使用 nexus 搭建 npm 私服</h3><p>这里怎么去搭建 nexus 就不介绍了，在 nexus 设置模块中。</p>
<p>创建 Repositories<br><img src="/images/create-repositories.jpg" alt=""></p>
<ul>
<li>1: npm (proxy) 代理仓库</li>
<li>2: npm (hosted) 是私有仓库</li>
<li>3: npm (group) 是组合前面两个</li>
</ul>
<p>创建代理仓库<br><img src="/images/npm-proxy.jpg" alt=""></p>
<p>创建 npm (hosted) 仓库<br><img src="/images/npm-private.jpg" alt=""></p>
<p>创建 npm (group) 仓库<br><img src="/images/npm-group.jpg" alt=""></p>
<h3 id="组件库采用的技术方案"><a href="#组件库采用的技术方案" class="headerlink" title="组件库采用的技术方案"></a>组件库采用的技术方案</h3><p><a href="https://github.com/umijs/father" target="_blank" rel="external">技术方案</a>，改技术能很好的开发组件打包，发布组件，编写文档。项目也采用 TypeScript 来开发，主要是因为这样让后期开发人员能很好的使用。(package.json 中 peerDependencies 是不会被打包进去的)，其它的配置信息可以去看 father 的文档。</p>
<h3 id="开发流程"><a href="#开发流程" class="headerlink" title="开发流程"></a>开发流程</h3><ul>
<li><p>3.1 开发组件<br>在 src 的目录下面新建要开发的组件，文件名字采用的是驼峰的方式（首字母小写）。可参考写过的组件，接下来就是你自己自由的发挥了。</p>
</li>
<li><p>3.2 组件说明<br>就是你要写怎么使用这个组件，让组内的人员知道怎么使用。在文件夹下面新建 index.mdx（文件后缀名不要写错了）。这里简单的说明一下</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line">---</div><div class="line">name: TableHeader (组件名字)</div><div class="line">route: /TableHeader （文档的路由地址）</div><div class="line">menu: &apos;前端组件库&apos;</div><div class="line">edit: false</div><div class="line">sidebar: true</div><div class="line">---</div><div class="line">import &#123; Playground &#125; from &apos;docz&apos;;</div><div class="line">import &#123; Form, Table &#125; from &apos;antd&apos;;</div><div class="line">import TableHeader from &apos;./index.tsx&apos;;</div><div class="line"></div><div class="line"># TableHeader</div><div class="line"></div><div class="line">搜索条件嵌入到Table组件</div><div class="line"></div><div class="line">## 代码演示</div><div class="line"></div><div class="line">&lt;Playground&gt;</div><div class="line"></div><div class="line">     &#123;</div><div class="line">        () =&gt; &#123;</div><div class="line"></div><div class="line">            const Demo = (props) =&gt; &#123;</div><div class="line">            const fetchList = () =&gt; &#123;</div><div class="line">                   props.form.validateFields((err, values) =&gt; &#123;</div><div class="line">                            console.log(&apos;err&apos;, err)</div><div class="line">                              console.log(&apos;values&apos;, values)</div><div class="line"></div><div class="line">                   &#125;)</div><div class="line">                &#125;;</div><div class="line">           const columns = [</div><div class="line">             &#123;</div><div class="line">               title: () =&gt; &lt;TableHeader onSearch=&#123;fetchList&#125; form=&#123;props.form&#125; name=&quot;id&quot; title=&quot;id&quot; /&gt;,</div><div class="line">               dataIndex: &apos;id&apos;,</div><div class="line">               key: &apos;id&apos;,</div><div class="line">            &#125;,</div><div class="line">           &#123;</div><div class="line">              title: () =&gt; &lt;TableHeader onSearch=&#123;fetchList&#125; form=&#123;props.form&#125; name=&quot;userName&quot;</div><div class="line">                              title=&quot;userName&quot; /&gt;,</div><div class="line">             dataIndex: &apos;userName&apos;,</div><div class="line">             key: &apos;userName&apos;,</div><div class="line">         &#125;,</div><div class="line">         &#123;</div><div class="line">             title: () =&gt; &lt;TableHeader onSearch=&#123;fetchList&#125; form=&#123;props.form&#125; name=&quot;address&quot;</div><div class="line">                              isNumber title=&quot;address&quot; /&gt;,</div><div class="line">            dataIndex: &apos;address&apos;,</div><div class="line">            key: &apos;address&apos;,</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">           title: () =&gt; &lt;TableHeader onSearch=&#123;fetchList&#125; form=&#123;props.form&#125; name=&quot;age&quot; isNumber</div><div class="line">                             title=&quot;age&quot; /&gt;,</div><div class="line">           dataIndex: &apos;age&apos;,</div><div class="line">           key: &apos;age&apos;,</div><div class="line">           width: 100,</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">           title: () =&gt; &lt;TableHeader onSearch=&#123;fetchList&#125; form=&#123;props.form&#125; name=&quot;sex&quot; title=&quot;sex&quot;</div><div class="line">                            headerType=&quot;select&quot; options=&#123;[&#123;id: 0, value: &apos;男&apos;&#125;, &#123;id:1, value:&apos;女&apos;&#125;]&#125;  /&gt;,</div><div class="line">           dataIndex: &apos;sex&apos;,</div><div class="line">           key: &apos;sex&apos;,</div><div class="line">           width: 150,</div><div class="line">        &#125;,</div><div class="line">       ];</div><div class="line">      return  (</div><div class="line">           &lt;Table</div><div class="line">             columns=&#123;columns&#125;</div><div class="line">             list=&#123;[]&#125;</div><div class="line">             /&gt;</div><div class="line"></div><div class="line">          )</div><div class="line">     &#125;</div><div class="line">     const FormDemo = Form.create()(Demo)</div><div class="line">          return &lt;FormDemo /&gt;</div><div class="line">        &#125;</div><div class="line">     &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">&lt;/Playground&gt;</div></pre></td></tr></table></figure>
<ul>
<li>3.3 在线文件查看</li>
</ul>
<p>npm start, Open your browser and visit <a href="http://127.0.0.1:8001" target="_blank" rel="external">http://127.0.0.1:8001</a> , see more at Development，就是一个组件库的介绍网页。</p>
<h3 id="发布组件"><a href="#发布组件" class="headerlink" title="发布组件"></a>发布组件</h3><p>发布到 npm 的私服，在项目目录下新建.yarnrc</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">registry &quot;http://192.168.3.19:8081/repository/npm-group/&quot;</div></pre></td></tr></table></figure>
<p>在 package.json 中设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&quot;publishConfig&quot;: &#123;</div><div class="line">   &quot;registry&quot;: &quot;http://192.168.3.19:8081/repository/npm-private/&quot;</div><div class="line"> &#125;,</div></pre></td></tr></table></figure>
<ul>
<li><p>4.1 进行登录，要求输入用户名和密码，就是 nexus 的密码，可以新建多个用户。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yarn login --registry http://192.168.3.19:8081/repository/npm-private/</div></pre></td></tr></table></figure>
</li>
<li><p>4.2 发布到私服。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yarn pub --registry http://192.168.3.19:8081/repository/npm-private/</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="如何使用组件"><a href="#如何使用组件" class="headerlink" title="如何使用组件"></a>如何使用组件</h3><p>在你使用的项目中新建如果你用 npm 就是.npmrc,如果是 yarn 就是.yarnrc 文件内容分别为<br>.npmrc 文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">registry=http://192.168.3.19:8081/repository/npm-group/</div><div class="line">disturb=http://192.168.3.19:8081/repository/npm-private/</div></pre></td></tr></table></figure>
<p>.yarnrc 文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">registry &quot;http://192.168.3.19:8081/repository/npm-group/&quot;</div></pre></td></tr></table></figure>
<p>使用 npm login 和 yarn login 登录私服（用户名和密码就是上文说到的 npm 私服）</p>
<p>然后就可以使用也可以使用 yarn</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm i @gogo/app-core --save</div></pre></td></tr></table></figure>
<h3 id="配合之前的-jenkins"><a href="#配合之前的-jenkins" class="headerlink" title="配合之前的 jenkins"></a>配合之前的 jenkins</h3><p>配合 jenkins，写入一些脚本，实现代码上传之后，自动打包发布组件库和使用文档。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/22/react-native的列表使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="GoGo (吴克伟)">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GoGo's home">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/22/react-native的列表使用/" itemprop="url">react-native的列表使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-22T22:17:10+08:00">
                2019-07-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在官网中使用列表组件是FlatList，具体的api使用可以自行去官网查看，本人是从android端转来的，熟悉android开发的在列表加载初期（网络请求开发时候），会出现loading页面，当数据加载成功的时候，有数据的时候会显示数据，数据为空时候显示NotDataView页面，当Error时候会出现请求出差页面，列表的下拉刷新使用的时候官网自带的RefreshControl（也可以自行去写动画）。</p>
<h3 id="基础组件设计"><a href="#基础组件设计" class="headerlink" title="基础组件设计"></a>基础组件设计</h3><p>ErrorView（数据加载出错），LoadingView（正在请求中），NotDataView（无数据），ListView（带有上述功能的组件），前三者可以根据自己项目的效果修改，在此我使用最简单的方式实现。</p>
<h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><p>ErrorView（非常简单的显示加载出差和重试功能）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">import React from &quot;react&quot;;</div><div class="line">import &#123; TouchableOpacity, Text, StyleSheet &#125; from &quot;react-native&quot;;</div><div class="line"></div><div class="line">interface ErrorViewProps &#123;</div><div class="line">  errorMsg?: string;</div><div class="line">  onPress: () =&gt; void;</div><div class="line">&#125;</div><div class="line"></div><div class="line">const ErrorView: React.SFC&lt;ErrorViewProps&gt; = (&#123; errorMsg &#125;) =&gt; (</div><div class="line">  &lt;TouchableOpacity style=&#123;styles.container&#125;&gt;</div><div class="line">    &lt;Text&gt;&#123;errorMsg&#125;&lt;/Text&gt;</div><div class="line">  &lt;/TouchableOpacity&gt;</div><div class="line">);</div><div class="line"></div><div class="line">ErrorView.defaultProps = &#123;</div><div class="line">  errorMsg: &quot;服务器出差,请稍后再试...&quot;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">const styles = StyleSheet.create(&#123;</div><div class="line">  container: &#123;</div><div class="line">    flex: 1,</div><div class="line">    justifyContent: &quot;center&quot;,</div><div class="line">    alignItems: &quot;center&quot;</div><div class="line">  &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">export default ErrorView;</div></pre></td></tr></table></figure>
<p>LoadingView（正在加载中）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">import React from &quot;react&quot;;</div><div class="line">import &#123; View, Text, StyleSheet, ActivityIndicator &#125; from &quot;react-native&quot;;</div><div class="line"></div><div class="line">interface LoadingViewProps &#123;</div><div class="line">  backgroundColor?: string;</div><div class="line">  indicatorColor?: string;</div><div class="line">&#125;</div><div class="line"></div><div class="line">const LoadingView: React.SFC&lt;LoadingViewProps&gt; = (&#123;</div><div class="line">  backgroundColor,</div><div class="line">  indicatorColor</div><div class="line">&#125;) =&gt; (</div><div class="line">  &lt;View style=&#123;[styles.loading, &#123; backgroundColor: backgroundColor &#125;]&#125;&gt;</div><div class="line">    &lt;ActivityIndicator size=&quot;large&quot; color=&#123;indicatorColor&#125; /&gt;</div><div class="line">    &lt;Text style=&#123;styles.loadingText&#125;&gt;数据加载中...&lt;/Text&gt;</div><div class="line">  &lt;/View&gt;</div><div class="line">);</div><div class="line"></div><div class="line">LoadingView.defaultProps = &#123;</div><div class="line">  backgroundColor: &quot;#ffffff&quot;,</div><div class="line">  indicatorColor: &quot;4C7FEF&quot;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">const styles = StyleSheet.create(&#123;</div><div class="line">  loading: &#123;</div><div class="line">    flex: 1,</div><div class="line">    alignItems: &quot;center&quot;,</div><div class="line">    justifyContent: &quot;center&quot;</div><div class="line">  &#125;,</div><div class="line">  loadingText: &#123;</div><div class="line">    marginTop: 10,</div><div class="line">    textAlign: &quot;center&quot;</div><div class="line">  &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">export default LoadingView;</div></pre></td></tr></table></figure>
<p>NotDataView（简单的不能再简单）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">import React from &quot;react&quot;;</div><div class="line">import &#123; View, Text, StyleSheet &#125; from &quot;react-native&quot;;</div><div class="line"></div><div class="line">interface NotDataViewProps &#123;</div><div class="line">  msg: string;</div><div class="line">&#125;</div><div class="line"></div><div class="line">const NotDataView: React.SFC&lt;NotDataViewProps&gt; = (&#123; msg &#125;) =&gt; (</div><div class="line">  &lt;View style=&#123;styles.container&#125;&gt;</div><div class="line">    &lt;Text&gt;&#123;msg&#125;&lt;/Text&gt;</div><div class="line">  &lt;/View&gt;</div><div class="line">);</div><div class="line"></div><div class="line">NotDataView.defaultProps = &#123;</div><div class="line">  msg: &quot;暂无数据&quot;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">const styles = StyleSheet.create(&#123;</div><div class="line">  container: &#123;</div><div class="line">    flex: 1,</div><div class="line">    justifyContent: &quot;center&quot;,</div><div class="line">    alignItems: &quot;center&quot;</div><div class="line">  &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">export default NotDataView;</div></pre></td></tr></table></figure>
<h3 id="重头戏（ListView）"><a href="#重头戏（ListView）" class="headerlink" title="重头戏（ListView）"></a>重头戏（ListView）</h3><p>先上代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div></pre></td><td class="code"><pre><div class="line">interface ListViewProps &#123;</div><div class="line">  dataSource: ReadonlyArray&lt;any&gt;;</div><div class="line">  renderItem: ListRenderItem&lt;any&gt;;</div><div class="line">  onFetchList: (</div><div class="line">    loading: boolean,</div><div class="line">    isRefreshing: boolean,</div><div class="line">    loadMore: boolean,</div><div class="line">    pn: number</div><div class="line">  ) =&gt; void;</div><div class="line">  isRefreshing: boolean;</div><div class="line">  loading: boolean;</div><div class="line">  loadMore: boolean;</div><div class="line">  hasMore: boolean;</div><div class="line">  error: boolean;</div><div class="line">  refreshColor?: string;</div><div class="line">  backgroundColor?: string;</div><div class="line">  defaultPage?: number;</div><div class="line">&#125;</div><div class="line"></div><div class="line">const DefaultPage = 0;</div><div class="line"></div><div class="line">class ListView extends React.PureComponent&lt;ListViewProps&gt; &#123;</div><div class="line">  static defaultProps = &#123;</div><div class="line">    refreshColor: &quot;#4C7FEF&quot;,</div><div class="line">    backgroundColor: &quot;#ffffff&quot;,</div><div class="line">    defaultPage: DefaultPage</div><div class="line">  &#125;;</div><div class="line">  page: number;</div><div class="line"></div><div class="line">  constructor(props: ListViewProps) &#123;</div><div class="line">    super(props);</div><div class="line">    const &#123; defaultPage &#125; = props;</div><div class="line">    this.page = defaultPage || DefaultPage;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  componentDidMount() &#123;</div><div class="line">    const &#123; onFetchList &#125; = this.props;</div><div class="line">    onFetchList(true, false, false, this.page);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  onEndReached = () =&gt; &#123;</div><div class="line">    const &#123; onFetchList, loadMore, hasMore, error &#125; = this.props;</div><div class="line">    if (loadMore || !hasMore || error) &#123;</div><div class="line">      return;</div><div class="line">    &#125;</div><div class="line">    this.page = this.page + 1;</div><div class="line">    onFetchList(false, false, true, this.page);</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  renderFooter = () =&gt; &#123;</div><div class="line">    const &#123; loadMore, error &#125; = this.props;</div><div class="line">    if (loadMore) &#123;</div><div class="line">      return (</div><div class="line">        &lt;View style=&#123;styles.footer&#125;&gt;</div><div class="line">          &lt;ActivityIndicator /&gt;</div><div class="line">          &lt;Text style=&#123;&#123; marginLeft: 5 &#125;&#125;&gt;加载中...&lt;/Text&gt;</div><div class="line">        &lt;/View&gt;</div><div class="line">      );</div><div class="line">    &#125;</div><div class="line">    if (error) &#123;</div><div class="line">      return (</div><div class="line">        &lt;TouchableOpacity</div><div class="line">          style=&#123;styles.errorFooter&#125;</div><div class="line">          onPress=&#123;() =&gt; &#123;</div><div class="line">            const &#123; onFetchList &#125; = this.props;</div><div class="line">            onFetchList(false, false, true, this.page);</div><div class="line">          &#125;&#125;</div><div class="line">        &gt;</div><div class="line">          &lt;Text&gt;加载出错，点击重试&lt;/Text&gt;</div><div class="line">        &lt;/TouchableOpacity&gt;</div><div class="line">      );</div><div class="line">    &#125;</div><div class="line">    return &lt;View /&gt;;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  handleRefresh = () =&gt; &#123;</div><div class="line">    const &#123; onFetchList, defaultPage &#125; = this.props;</div><div class="line">    this.page = defaultPage || DefaultPage;</div><div class="line">    onFetchList(false, true, false, this.page);</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  render() &#123;</div><div class="line">    const &#123;</div><div class="line">      dataSource,</div><div class="line">      renderItem,</div><div class="line">      isRefreshing,</div><div class="line">      loading,</div><div class="line">      error,</div><div class="line">      refreshColor,</div><div class="line">      backgroundColor,</div><div class="line">      defaultPage</div><div class="line">    &#125; = this.props;</div><div class="line">    const refreshColors: string[] = [refreshColor || &quot;#4C7FEF&quot;];</div><div class="line">    if (loading &amp;&amp; this.page === defaultPage) &#123;</div><div class="line">      return (</div><div class="line">        &lt;LoadingView</div><div class="line">          indicatorColor=&#123;refreshColor&#125;</div><div class="line">          backgroundColor=&#123;backgroundColor&#125;</div><div class="line">        /&gt;</div><div class="line">      );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (error &amp;&amp; this.page === defaultPage) &#123;</div><div class="line">      return (</div><div class="line">        &lt;ErrorView</div><div class="line">          onPress=&#123;() =&gt; &#123;</div><div class="line">            const &#123; onFetchList &#125; = this.props;</div><div class="line">            onFetchList(true, false, false, this.page);</div><div class="line">          &#125;&#125;</div><div class="line">        /&gt;</div><div class="line">      );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return (</div><div class="line">      &lt;FlatList</div><div class="line">        data=&#123;dataSource&#125;</div><div class="line">        onEndReached=&#123;this.onEndReached&#125;</div><div class="line">        onEndReachedThreshold=&#123;0.2&#125;</div><div class="line">        ListEmptyComponent=&#123;NotDataView&#125;</div><div class="line">        keyExtractor=&#123;(item, index) =&gt; item.id || index.toString()&#125;</div><div class="line">        renderItem=&#123;renderItem&#125;</div><div class="line">        ListFooterComponent=&#123;this.renderFooter&#125;</div><div class="line">        refreshControl=&#123;</div><div class="line">          &lt;RefreshControl</div><div class="line">            refreshing=&#123;isRefreshing&#125;</div><div class="line">            onRefresh=&#123;this.handleRefresh&#125;</div><div class="line">            colors=&#123;refreshColors&#125;</div><div class="line">            progressBackgroundColor=&#123;backgroundColor&#125;</div><div class="line">          /&gt;</div><div class="line">        &#125;</div><div class="line">      /&gt;</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">const styles = StyleSheet.create(&#123;</div><div class="line">  footer: &#123;</div><div class="line">    height: 40,</div><div class="line">    flexDirection: &quot;row&quot;,</div><div class="line">    justifyContent: &quot;center&quot;,</div><div class="line">    alignItems: &quot;center&quot;</div><div class="line">  &#125;,</div><div class="line">  errorFooter: &#123;</div><div class="line">    height: 40,</div><div class="line">    flexDirection: &quot;row&quot;,</div><div class="line">    justifyContent: &quot;center&quot;,</div><div class="line">    alignItems: &quot;center&quot;</div><div class="line">  &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">export default ListView;</div></pre></td></tr></table></figure>
<p>从Props可以很明显的看出该组件的功能，dataSource(数据源)，renderItem（渲染的Item），onFetchList（请求数据），isRefreshing（是否正在下拉刷新），loading（是否显示正在加载），loadMore（是否显示footer正在加载），hasMore（是否还有数据），error（是否加载出错），refreshColor（下拉刷新的颜色），backgroundColor（背景颜色），defaultPage（默认开始页码）。</p>
<h3 id="接口设计"><a href="#接口设计" class="headerlink" title="接口设计"></a>接口设计</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">export interface PageEntity&lt;TMODLE&gt; &#123;</div><div class="line">  //代表是否还有数据</div><div class="line">  hasMore: boolean;</div><div class="line">  list: TMODLE[];</div><div class="line">  totalCount: number;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="redux设计"><a href="#redux设计" class="headerlink" title="redux设计"></a>redux设计</h3><p>项目中使用的是redux，我们中间件采用的是redux-promise-middleware（简单的来说就是把Promise的三种状态采用拼接的type的形式）。一般来说一个接口有请求开始，成功，失败。</p>
<p>handleReducer设计（对应Promise的三种状态）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">export interface BaseAction &#123;</div><div class="line">  type: string;</div><div class="line">&#125;</div><div class="line"></div><div class="line">export interface Action&lt;Payload&gt; extends BaseAction &#123;</div><div class="line">  payload: Payload;</div><div class="line">&#125;</div><div class="line"></div><div class="line">export interface ActionMeta&lt;Payload, Meta&gt; extends Action&lt;Payload&gt; &#123;</div><div class="line">  meta: Meta;</div><div class="line">&#125;</div><div class="line"></div><div class="line">export interface Reducer&lt;State, Payload, Meta&gt; &#123;</div><div class="line">  pending: (state: State, action: ActionMeta&lt;Payload, Meta&gt;) =&gt; State;</div><div class="line">  fulfilled: (state: State, action: ActionMeta&lt;Payload, Meta&gt;) =&gt; State;</div><div class="line">  rejected: (state: State, action: ActionMeta&lt;Payload, Meta&gt;) =&gt; State;</div><div class="line">&#125;</div><div class="line"></div><div class="line">export default function handleReducer&lt;State, Payload, Meta = any&gt;(</div><div class="line">  typeName: string,</div><div class="line">  initialState: State,</div><div class="line">  reducer: Reducer&lt;State, Payload, Meta&gt;</div><div class="line">) &#123;</div><div class="line">  return function(state = initialState, action: ActionMeta&lt;Payload, Meta&gt;) &#123;</div><div class="line">    const type = action.type;</div><div class="line">    const &#123; pending, fulfilled, rejected &#125; = reducer;</div><div class="line">    if (pending &amp;&amp; typeName + &quot;_PENDING&quot; === type) &#123;</div><div class="line">      return pending(state, action);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (fulfilled &amp;&amp; typeName + &quot;_FULFILLED&quot; === type) &#123;</div><div class="line">      return fulfilled(state, action);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (rejected &amp;&amp; typeName + &quot;_REJECTED&quot; === type) &#123;</div><div class="line">      return rejected(state, action);</div><div class="line">    &#125;</div><div class="line">    return state;</div><div class="line">  &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>pageReducer的设计(基本看代码都能看出来和ListView相对应)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line">import handleReducer from &quot;./handleReducer&quot;;</div><div class="line"></div><div class="line">export interface PageState&lt;TMODLE&gt; &#123;</div><div class="line">  dataSource: TMODLE[];</div><div class="line">  isRefreshing: boolean;</div><div class="line">  loading: boolean;</div><div class="line">  loadMore: boolean;</div><div class="line">  hasMore: boolean;</div><div class="line">  error: boolean;</div><div class="line">&#125;</div><div class="line"></div><div class="line">export interface PageMeta &#123;</div><div class="line">  loading: boolean;</div><div class="line">  isRefreshing: boolean;</div><div class="line">  loadMore: boolean;</div><div class="line">&#125;</div><div class="line"></div><div class="line">export interface PageEntity&lt;TMODLE&gt; &#123;</div><div class="line">  hasMore: boolean;</div><div class="line">  list: TMODLE[];</div><div class="line">  totalCount: number;</div><div class="line">&#125;</div><div class="line"></div><div class="line">export function pageAction&lt;TMODLE, PARAMS&gt;(</div><div class="line">  typeName: string,</div><div class="line">  api: (param: PARAMS) =&gt; Promise&lt;PageEntity&lt;TMODLE&gt;&gt;,</div><div class="line">  paramCallback?: (param: PARAMS) =&gt; PARAMS</div><div class="line">) &#123;</div><div class="line">  return (</div><div class="line">    loading: boolean,</div><div class="line">    isRefreshing: boolean,</div><div class="line">    loadMore: boolean,</div><div class="line">    param: PARAMS</div><div class="line">  ) =&gt; (&#123;</div><div class="line">    type: typeName,</div><div class="line">    payload: paramCallback ? api(paramCallback(param)) : api(param),</div><div class="line">    meta: &#123;</div><div class="line">      loading,</div><div class="line">      isRefreshing,</div><div class="line">      loadMore</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">const initialState: PageState&lt;any&gt; = &#123;</div><div class="line">  dataSource: [],</div><div class="line">  isRefreshing: false,</div><div class="line">  loading: false,</div><div class="line">  loadMore: false,</div><div class="line">  hasMore: false,</div><div class="line">  error: false</div><div class="line">&#125;;</div><div class="line"></div><div class="line">export function pageReducer&lt;TMODEL&gt;(typeName: string) &#123;</div><div class="line">  return handleReducer&lt;PageState&lt;TMODEL&gt;, PageEntity&lt;TMODEL&gt;, PageMeta&gt;(</div><div class="line">    typeName,</div><div class="line">    initialState,</div><div class="line">    &#123;</div><div class="line">      pending: (state, &#123; meta &#125;) =&gt; (&#123;</div><div class="line">        ...state,</div><div class="line">        ...meta</div><div class="line">      &#125;),</div><div class="line">      fulfilled: (state, &#123; payload &#125;) =&gt; (&#123;</div><div class="line">        ...state,</div><div class="line">        isRefreshing: false,</div><div class="line">        loading: false,</div><div class="line">        loadMore: false,</div><div class="line">        error: false,</div><div class="line">        hasMore: payload.hasMore,</div><div class="line">        dataSource: state.loadMore</div><div class="line">          ? state.dataSource.concat(payload.list)</div><div class="line">          : payload.list</div><div class="line">      &#125;),</div><div class="line">      rejected: state =&gt; (&#123;</div><div class="line">        ...state,</div><div class="line">        isRefreshing: false,</div><div class="line">        loading: false,</div><div class="line">        loadMore: false,</div><div class="line">        hasMore: false,</div><div class="line">        error: true</div><div class="line">      &#125;)</div><div class="line">    &#125;</div><div class="line">  );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>好比有个UserList页面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">interface UserListProps &#123;</div><div class="line">  fetchUserList: (</div><div class="line">    loading: boolean,</div><div class="line">    isRefreshing: boolean,</div><div class="line">    loadMore: boolean,</div><div class="line">    param: CommomListParams</div><div class="line">  ) =&gt; void;</div><div class="line">  userList: PageState&lt;UserData&gt;;</div><div class="line">&#125;</div><div class="line"></div><div class="line">class UserList extends React.Component&lt;UserListProps&gt; &#123;</div><div class="line">  onFetchList = (</div><div class="line">    loading: boolean,</div><div class="line">    isRefreshing: boolean,</div><div class="line">    loadMore: boolean,</div><div class="line">    page: number</div><div class="line">  ) =&gt; &#123;</div><div class="line">    const &#123; fetchUserList &#125; = this.props;</div><div class="line">    fetchUserList(loading, isRefreshing, loadMore, &#123; start: page &#125;);</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  renderUserItem = (&#123; item &#125;: ListRenderItemInfo&lt;UserData&gt;) =&gt; (</div><div class="line">    &lt;View&gt;</div><div class="line">      &lt;Text&gt;&#123;item.id&#125;&lt;/Text&gt;</div><div class="line">      &lt;Text&gt;&#123;item.name&#125;&lt;/Text&gt;</div><div class="line">      &lt;Text&gt;&#123;item.age&#125;&lt;/Text&gt;</div><div class="line">      &lt;Text&gt;&#123;item.sex&#125;&lt;/Text&gt;</div><div class="line">    &lt;/View&gt;</div><div class="line">  );</div><div class="line"></div><div class="line">  render() &#123;</div><div class="line">    const &#123; userList &#125; = this.props;</div><div class="line">    return (</div><div class="line">      &lt;ListView</div><div class="line">        &#123;...userList&#125;</div><div class="line">        onFetchList=&#123;this.onFetchList&#125;</div><div class="line">        renderItem=&#123;this.renderUserItem&#125;</div><div class="line">      /&gt;</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">function mapStateToProps(state: ReducerType) &#123;</div><div class="line">  return &#123;</div><div class="line">    userList: state.userList</div><div class="line">  &#125;;</div><div class="line">&#125;</div><div class="line">export default connect(</div><div class="line">  mapStateToProps,</div><div class="line">  &#123;</div><div class="line">    fetchUserList: fetchUserListAction</div><div class="line">  &#125;</div><div class="line">)(UserList);</div></pre></td></tr></table></figure>
<p>action很简单</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">export const fetchUserListAction = pageAction&lt;UserData, CommomListParams&gt;(</div><div class="line">  User.FETCH_USER_LSIT,</div><div class="line">  fetchUserList</div><div class="line">);</div></pre></td></tr></table></figure>
<p>reducers也很简单，不需要写任何其它纯函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">const reducer = combineReducers(&#123;</div><div class="line">  userList: pageReducer&lt;UserData&gt;(User.FETCH_USER_LSIT)</div><div class="line">&#125;);</div><div class="line"></div><div class="line">export default reducer;</div><div class="line"></div><div class="line">export interface ReducerType &#123;</div><div class="line">  userList: PageState&lt;UserData&gt;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>通过这次的封装使我对redux， Typescript有更加深入的了解。<a href="https://github.com/zj-wukewei/react_native_listview" target="_blank" rel="external">代码地址</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/07/使用Typescript-ESLint-Prettier来搭建React开发环境/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="GoGo (吴克伟)">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GoGo's home">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/07/使用Typescript-ESLint-Prettier来搭建React开发环境/" itemprop="url">使用Typescript, ESLint, Prettier来搭建React开发环境</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-07T23:14:18+08:00">
                2019-07-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>  前端新手……………….,先安装create-react-app</p>
<h3 id="使用Typescript安装"><a href="#使用Typescript安装" class="headerlink" title="使用Typescript安装"></a>使用Typescript安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yarn create react-app my-test-ts --typescript</div></pre></td></tr></table></figure>
<h3 id="安装ESLint-Prettier"><a href="#安装ESLint-Prettier" class="headerlink" title="安装ESLint, Prettier"></a>安装ESLint, Prettier</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yarn add eslint eslint-plugin-react @typescript-eslint/parser @typescript-eslint/eslint-plugin --dev</div><div class="line">yarn add prettier eslint-plugin-prettier eslint-config-prettier --dev</div></pre></td></tr></table></figure>
<p>创建 .eslintrc.js 文件,可以加入rules的规则,但是在加入之前一定要组内讨论一下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">module.exports = &#123;</div><div class="line">  // 指定 ESLint parser</div><div class="line">  parser: &apos;@typescript-eslint/parser&apos;,</div><div class="line">  extends: [</div><div class="line">    // 使用 @eslint-plugin-react 中推荐的规则</div><div class="line">    &apos;plugin:react/recommended&apos;,</div><div class="line">    // 使用 @typescript-eslint/eslint-plugin 中推荐的规则</div><div class="line">    &apos;plugin:@typescript-eslint/recommended&apos;,</div><div class="line">    // 使用 eslint-config-prettier 来禁止 @typescript-eslint/eslint-plugin 中那些和 prettier 冲突的规则</div><div class="line">    &apos;prettier/@typescript-eslint&apos;,</div><div class="line">    // 使用 eslint-plugin-prettier 来将 prettier 错误作为 ESLint 错误显示</div><div class="line">    // 确保下面这行配置是这个数组里的最后一行配置</div><div class="line">    &apos;plugin:prettier/recommended&apos;,</div><div class="line">  ],</div><div class="line">  parserOptions: &#123;</div><div class="line">    ecmaVersion: 2018, // 允许解析现代 es 特性</div><div class="line">    sourceType: &apos;module&apos;, // 允许使用 imports</div><div class="line">    ecmaFeatures: &#123;</div><div class="line">      jsx: true, // 允许解析 jsx</div><div class="line">    &#125;,</div><div class="line">  &#125;,</div><div class="line">  rules: &#123;</div><div class="line">    &apos;react/display-name&apos;: &apos;off&apos;,</div><div class="line">    &apos;react/prop-types&apos;: &apos;off&apos;,</div><div class="line">    &apos;import/no-unresolved&apos;: &apos;off&apos;,</div><div class="line">    &apos;react/jsx-filename-extension&apos;: [1, &#123; &quot;extensions&quot;: [&quot;.ts&quot;, &quot;.tsx&quot;] &#125;],</div><div class="line">    &apos;no-undef&apos;: &apos;off&apos;,</div><div class="line">    // 类名与接口名必须为驼峰式</div><div class="line">    &apos;@typescript-eslint/class-name-casing&apos;: &apos;error&apos;,</div><div class="line">  &#125;,</div><div class="line">  settings: &#123;</div><div class="line">    react: &#123;</div><div class="line">      // Tells eslint-plugin-react to automatically detect the version of React to use</div><div class="line">      version: &apos;detect&apos;,</div><div class="line">    &#125;,</div><div class="line">  &#125;,</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>创建 .prettierrc.js 文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">module.exports = &#123;</div><div class="line">  semi: false,</div><div class="line">  trailingComma: &apos;all&apos;,</div><div class="line">  singleQuote: true,</div><div class="line">  printWidth: 120,</div><div class="line">  tabWidth: 2,</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="安装eslint-config-airbnb"><a href="#安装eslint-config-airbnb" class="headerlink" title="安装eslint-config-airbnb"></a>安装eslint-config-airbnb</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npx install-peerdeps --dev eslint-config-airbnb</div></pre></td></tr></table></figure>
<p>添加 “extends”: “airbnb” 到 .eslintrc</p>
<h3 id="VsCode配置"><a href="#VsCode配置" class="headerlink" title="VsCode配置"></a>VsCode配置</h3><p>setting.json配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;eslint.autoFixOnSave&quot;: true,</div><div class="line">  &quot;eslint.validate&quot;: [</div><div class="line">    &quot;javascript&quot;,</div><div class="line">    &quot;javascriptreact&quot;,</div><div class="line">    &#123; &quot;language&quot;: &quot;typescript&quot;, &quot;autoFix&quot;: true &#125;,</div><div class="line">    &#123; &quot;language&quot;: &quot;typescriptreact&quot;, &quot;autoFix&quot;: true &#125;</div><div class="line">  ],</div><div class="line"></div><div class="line">  &quot;editor.formatOnSave&quot;: true,</div><div class="line">  &quot;[javascript]&quot;: &#123;</div><div class="line">    &quot;editor.formatOnSave&quot;: false</div><div class="line">  &#125;,</div><div class="line">  &quot;[javascriptreact]&quot;: &#123;</div><div class="line">    &quot;editor.formatOnSave&quot;: false</div><div class="line">  &#125;,</div><div class="line">  &quot;[typescript]&quot;: &#123;</div><div class="line">    &quot;editor.formatOnSave&quot;: false</div><div class="line">  &#125;,</div><div class="line">  &quot;[typescriptreact]&quot;: &#123;</div><div class="line">    &quot;editor.formatOnSave&quot;: false</div><div class="line">  &#125;,</div><div class="line">  &quot;javascript.updateImportsOnFileMove.enabled&quot;: &quot;always&quot;,</div><div class="line">  &quot;typescript.updateImportsOnFileMove.enabled&quot;: &quot;always&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/26/jenkins-gitlab-pm2自动化部署react项目/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="GoGo (吴克伟)">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GoGo's home">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/26/jenkins-gitlab-pm2自动化部署react项目/" itemprop="url">jenkins+gitlab+pm2自动化部署react项目</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-26T10:27:18+08:00">
                2019-04-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="服务器"><a href="#服务器" class="headerlink" title="服务器"></a>服务器</h3><p>   环境：centos、jenkins（汉化版）、gitlab、node、pm2都已经安装好里，这里也不再描述安装过程。<br>   cnpm安装环境（npm网络不是很稳定，下载慢）：</p>
   <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">npm install -g cnpm --registry=https://registry.npm.taobao.org</div><div class="line">//然后建软链接，要不然输入cnpm -v会出错，未找到命令的错误</div><div class="line">sudo ln -s /usr/node/node-v8.12.0-linux-x64/node-v8.12.0-linux-x64/bin/cnpm /usr/local/bin/cnpm</div></pre></td></tr></table></figure>
<h3 id="jenkins设置（Gitlab-Plugin、NodeJs-Plugin安装）"><a href="#jenkins设置（Gitlab-Plugin、NodeJs-Plugin安装）" class="headerlink" title="jenkins设置（Gitlab Plugin、NodeJs Plugin安装）"></a>jenkins设置（Gitlab Plugin、NodeJs Plugin安装）</h3><p>  进入jenkins的页面<br>  <img src="/images/jenkins.jpg" alt=""><br>  点击左上角的新建任务，输入你的任务名字比如（text-web）,建议名字由项目名字-前端部署的端口号，记住名字后面会用到，选择构建一个自由风格的软件任务<br>  <img src="/images/task.jpg" alt=""><br>  会进入一个页面有General、源码管理、构建触发器、构建环境、构建、构建后操作的tab页面。<br>  1:先是General中描述，输入你想要对项目的描述。<br>   <img src="/images/general.jpg" alt=""><br>  2:源码管理，选择Git，在Repository URL输入，你要部署项目的gitlab的地址，我这里引用的方式是http不是ssh的，Credentials中选择就是你自己的gitlab的账号，还没有添加过的添加add<br>  <img src="/images/code.jpg" alt=""><br>  会出现下面页面UserName和Password添加你自己的gitlab账号，点击添加回到之前的页面在Credentials中就可以选择你添加的账号。<br>  <img src="/images/add-gitlab-user.jpg" alt=""><br>  Branch Specifier (blank for ‘any’)输入dev，因为我只是设置dev的时候才去采用自动化构建。<br>  3:构建触发器<br>  选择Build when a change is pushed to GitLab. GitLab webhook ，出现下图，记住GitLab webhook Url地址：<br>  <img src="/images/structure.jpg" alt=""><br>  点击高级按钮出现下图，看到Secret token，点击Generate出现一串字符，记录下来。<br>  <img src="/images/structure-senior.jpg" alt=""><br>  4:构建环境<br>  选择Provide Node &amp; npm bin/ folder to PATH<br>   在NodeJS Installation选择NodeJs(之前安装过)<br>    <img src="/images/environmental.jpg" alt=""><br>  5:构建<br>  点击添加构建步骤，选择执行Shell输入（deploy.sh就是要执行的脚本文件名）<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cnpm install</div><div class="line">cnpm run build</div><div class="line">sh deploy.sh</div></pre></td></tr></table></figure></p>
<p>   <img src="/images/structure-1.jpg" alt=""><br>   记得保存，在jenkins设置中记录两个，第一构建触发器中的GitLab webhook Url地址和Secret token后续会用到。</p>
<h3 id="gitlab（汉化）设置"><a href="#gitlab（汉化）设置" class="headerlink" title="gitlab（汉化）设置"></a>gitlab（汉化）设置</h3><p>进入要部署的gitlab项目地址，点击设置中的导入所有仓库<br><img src="/images/gitlab.jpg" alt=""><br><img src="/images/gitlab-setting.jpg" alt="">,<br>在链接(URL)填入上面记录的GitLab webhook Url地址（就是jenkins你的任务地址，记得修改jenkins部署的是8000端口，要是之前直接复制的地址是8080的，一定记得改成8000端口的，一定记得改成8000端口的，一定记得改成8000端口的，重要的事情说三遍，我之前也是入坑了），在安全令牌输入Secret token后面复制的一串字符，在推送事件时间下输入dev，因为只想在dev推送的时候触发自动构建和jenkins中设置的dev相对应，点击添加Web钩子, 记得端口对应jenkins的端口。<br><img src="/images/webhook.jpg" alt=""></p>
<h3 id="react项目"><a href="#react项目" class="headerlink" title="react项目"></a>react项目</h3><p>最主要的是已经四个文件部署要用到的，config.prod.js（定义了端口和代理ip地址）、deploy.sh（运行的脚本）、pm2.json、server.js<br><img src="/images/text-web-source.jpg" alt=""><br>1:config.prod.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">module.exports = &#123;</div><div class="line">  //端口号</div><div class="line">  port: 4005,</div><div class="line">  //api代理地址</div><div class="line">  api: &apos;http://localhost:8080/&apos;,</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>2:pm2.json</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;name&quot;: &quot;text-web&quot;,</div><div class="line">  &quot;script&quot;: &quot;server.js&quot;,</div><div class="line">  &quot;env&quot;: &#123;</div><div class="line">    &quot;NODE_ENV&quot;: &quot;production&quot;</div><div class="line">  &#125;,</div><div class="line">  &quot;error_file&quot;: &quot;log/app-err.log&quot;,</div><div class="line">  &quot;out_file&quot;: &quot;log/app-out.log&quot;,</div><div class="line">  &quot;exec_mode&quot;: &quot;cluster&quot;,</div><div class="line">  &quot;instances&quot;: 1,</div><div class="line">  &quot;log_date_format&quot;: &quot;YYYY-MM-DD HH:mm Z&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>3:server.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">&apos;use strict&apos;;</div><div class="line">// 依赖</div><div class="line">const path = require(&apos;path&apos;);</div><div class="line">const express = require(&apos;express&apos;);</div><div class="line">const proxy = require(&apos;express-http-proxy&apos;);</div><div class="line">const helmet = require(&apos;helmet&apos;);</div><div class="line">const compression = require(&apos;compression&apos;);</div><div class="line">const config = require(&apos;./config.prod&apos;);</div><div class="line">// express 实例</div><div class="line">const app = express();</div><div class="line">// 设置 HTTP 头</div><div class="line">// reference: http://expressjs.com/zh-cn/advanced/best-practice-security.html</div><div class="line">app.use(helmet());</div><div class="line">// 开启 gzip 压缩</div><div class="line">// reference: http://expressjs.com/zh-cn/advanced/best-practice-performance.html</div><div class="line">app.use(compression());</div><div class="line">// 静态资源服务</div><div class="line">app.use(express.static(path.join(__dirname, &apos;dist&apos;)));</div><div class="line"></div><div class="line">// api proxy</div><div class="line">app.use(&apos;/api&apos;, proxy(config.api, &#123;</div><div class="line">  forwardPath: function (req, res) &#123;</div><div class="line">    // return require(&apos;url&apos;).parse(&quot;/smartShoes-wechat&quot; + req.url).path;</div><div class="line">    return require(&apos;url&apos;).parse(req.url).path;</div><div class="line">  &#125;</div><div class="line">&#125;));</div><div class="line">app.get(&apos;*&apos;, function (req, res) &#123;</div><div class="line">  res.sendFile(__dirname + &apos;/dist/index.html&apos;);</div><div class="line">&#125;);</div><div class="line">const port = config.port || process.env.PORT</div><div class="line">console.log(&quot;prot:&quot; + config.port)</div><div class="line">app.listen(port, function () &#123;</div><div class="line">  console.log(&apos;🌎 =&gt; App is running on port %s&apos;, port)</div></pre></td></tr></table></figure>
<p>4:deploy.sh文件，要修改两个地址project_home/最后面的text-web-4005修改为你的项目-端口号，project_name就是jenkins的任务名字。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">echo &apos;---------------------------------- 部署Begin ----------------------------------&apos;</div><div class="line">#定义基础路径及目录</div><div class="line">#项目部署的地址/usr/server固定，后面由项目名字加上config.prod中的端口号，根据项目</div><div class="line">project_home=/usr/server/text-web-4005</div><div class="line">#jenkins服务器路径</div><div class="line">jenkins_home=/root/.jenkins/workspace</div><div class="line">#jenkins的任务名字</div><div class="line">project_name=text-web</div><div class="line">#server.js运行的依赖</div><div class="line">mode_modules=/usr/server/node_modules/node_modules.tar.gz</div><div class="line">tar -czf dist.tar.gz dist</div><div class="line">rm -rf dist</div><div class="line">if [ -d &quot;$project_home/&quot; ]; then</div><div class="line">  &#123;</div><div class="line">    echo &apos;----------------------------------文件存在----------------------------------&apos;</div><div class="line">    rm -rf $project_home</div><div class="line">  &#125;</div><div class="line">fi</div><div class="line">#建立新文件夹</div><div class="line">mkdir $project_home</div><div class="line">echo &apos;---------------------------------- 文件拷贝Begin ----------------------------------&apos;</div><div class="line">cp $jenkins_home/$project_name/dist.tar.gz $project_home</div><div class="line">cp $jenkins_home/$project_name/config.prod.js $project_home</div><div class="line">cp $jenkins_home/$project_name/server.js $project_home</div><div class="line">cp $jenkins_home/$project_name/pm2.json $project_home</div><div class="line">cp $mode_modules $project_home </div><div class="line">echo &apos;---------------------------------- 文件拷贝End ----------------------------------&apos;</div><div class="line">echo &apos;---------------------------------- 解压Begin ----------------------------------&apos;</div><div class="line">cd $project_home</div><div class="line">tar -xzvf dist.tar.gz</div><div class="line">tar -xzvf node_modules.tar.gz</div><div class="line">mkdir log</div><div class="line">rm -rf $project_home/dist.tar.gz</div><div class="line">rm -rf $project_home/node_modules.tar.gz</div><div class="line">echo &apos;---------------------------------- 解压End ----------------------------------&apos;</div><div class="line">echo &apos;---------------------------------- Pm2Begin ----------------------------------&apos;</div><div class="line">#到/usr文件夹目的是因为确保pm2第一次在安全的目录运行</div><div class="line">cd /usr</div><div class="line">pm2 list</div><div class="line">cd $project_home</div><div class="line">pm2 startOrRestart pm2.json</div><div class="line">echo &apos;---------------------------------- Pm2End ----------------------------------&apos;</div><div class="line">echo &apos;---------------------------------- 部署End ----------------------------------&apos;</div></pre></td></tr></table></figure>
<h3 id="pm2遇到的坑"><a href="#pm2遇到的坑" class="headerlink" title="pm2遇到的坑"></a>pm2遇到的坑</h3><p> 当我在给一个项目配置的时候pm2出现了以下错误</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">PM2        |</div><div class="line">PM2        | Error: ENOENT: no such file or directory, uv_cwd</div><div class="line">PM2        |     at Object.resolve (path.js:1167:25)</div><div class="line">PM2        |     at Function.Module._resolveLookupPaths (module.js:424:17)</div><div class="line">PM2        |     at Function.Module._resolveFilename (module.js:542:20)</div><div class="line">PM2        |     at Function.Module._load (module.js:475:25)</div><div class="line">PM2        |     at Module.require (module.js:597:17)</div><div class="line">PM2        |     at require (internal/module.js:11:18)</div><div class="line">PM2        |     at Object.&lt;anonymous&gt; (/usr/node/node-v8.12.0-linux-x64/node-v8.12.0-linux-x64/lib/node_modules/pm2/lib/ProcessContainer.js:13:15)</div><div class="line">PM2        |     at Module._compile (module.js:653:30)</div><div class="line">PM2        |     at Object.Module._extensions..js (module.js:664:10)</div><div class="line">PM2        |     at Module.load (module.js:566:32)</div><div class="line">PM2        | [2019-04-25T18:47:51.855Z] PM2 log: App name:arms-console id:0 disconnected</div><div class="line">PM2        | [2019-04-25T18:47:51.856Z] PM2 log: App [arms-console] with id [0] and pid [27634], exited with code [1] via signal [SIGINT]</div><div class="line">PM2        | [2019-04-25T18:47:51.857Z] PM2 log: Script /usr/server/arms-console-4004/server.js had too many unstable restarts (16). Stopped. &quot;errored&quot;</div></pre></td></tr></table></figure>
<p> 其它项目都是行的就是这个项目不行，后来在网上查了一通，也有人遇到这个问题，大概的解释就是在你的命令行中第一次运行pm2的那个文件夹是不能被删除的一删除就会出现这个错误，然后我运行pm2 kill然后在一个安全的目录先运行pm2 -v，问题解决了。因为我的脚本是每次部署都会把之前的文件夹删除，然后建立文件夹把必要的文件复制进去，然后解压然后删除不必要的问题，刚刚有个项目的目录是第一次运行pm2的文件夹被自动化部署的时候删除，就出现这个错误所以我在脚本里防止出现这个错误，  cd /usr  pm2 list，会先前去安全目录运行pm2 list，然后进入项目目录，运行pm2命令。请大家也能注意一下，在pm kill之后要先到安全目录运行以下pm2命令。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/15/docker学习/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="GoGo (吴克伟)">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GoGo's home">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/15/docker学习/" itemprop="url">docker学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-15T20:04:04+08:00">
                2019-04-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>因为本人的电脑是mac的，以下操作均在mac系统下操作。</p>
<h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p> <a href="https://hub.docker.com/editions/community/docker-ce-desktop-mac" target="_blank" rel="external">地址</a>，下载之后安装。</p>
<h3 id="阿里云加速"><a href="#阿里云加速" class="headerlink" title="阿里云加速"></a>阿里云加速</h3><p>  在docker的Preferences的Daemon中的Registry mirros添加一个从阿里云获取的地址。</p>
<h3 id="运行hello-world"><a href="#运行hello-world" class="headerlink" title="运行hello-world"></a>运行hello-world</h3><p>  在终端输入docker pull hello-world，这样就从docker仓库下载里镜像，docker run hello-world，创建容器。</p>
<h3 id="安装redis"><a href="#安装redis" class="headerlink" title="安装redis"></a>安装redis</h3><p>  docker pull redis下载镜像，在 docker/redis目录下建立redis.conf文件内容为</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div><div class="line">459</div><div class="line">460</div><div class="line">461</div><div class="line">462</div><div class="line">463</div><div class="line">464</div><div class="line">465</div><div class="line">466</div><div class="line">467</div><div class="line">468</div><div class="line">469</div><div class="line">470</div><div class="line">471</div><div class="line">472</div><div class="line">473</div><div class="line">474</div><div class="line">475</div><div class="line">476</div><div class="line">477</div><div class="line">478</div><div class="line">479</div><div class="line">480</div><div class="line">481</div><div class="line">482</div><div class="line">483</div><div class="line">484</div><div class="line">485</div><div class="line">486</div><div class="line">487</div><div class="line">488</div><div class="line">489</div><div class="line">490</div><div class="line">491</div><div class="line">492</div><div class="line">493</div><div class="line">494</div><div class="line">495</div><div class="line">496</div><div class="line">497</div><div class="line">498</div><div class="line">499</div><div class="line">500</div><div class="line">501</div><div class="line">502</div><div class="line">503</div><div class="line">504</div><div class="line">505</div><div class="line">506</div><div class="line">507</div><div class="line">508</div><div class="line">509</div><div class="line">510</div><div class="line">511</div><div class="line">512</div><div class="line">513</div><div class="line">514</div><div class="line">515</div><div class="line">516</div><div class="line">517</div><div class="line">518</div><div class="line">519</div><div class="line">520</div><div class="line">521</div><div class="line">522</div><div class="line">523</div><div class="line">524</div><div class="line">525</div><div class="line">526</div><div class="line">527</div><div class="line">528</div><div class="line">529</div><div class="line">530</div><div class="line">531</div><div class="line">532</div><div class="line">533</div><div class="line">534</div><div class="line">535</div><div class="line">536</div><div class="line">537</div><div class="line">538</div><div class="line">539</div><div class="line">540</div><div class="line">541</div><div class="line">542</div><div class="line">543</div><div class="line">544</div><div class="line">545</div><div class="line">546</div><div class="line">547</div><div class="line">548</div><div class="line">549</div><div class="line">550</div><div class="line">551</div><div class="line">552</div><div class="line">553</div><div class="line">554</div><div class="line">555</div><div class="line">556</div><div class="line">557</div><div class="line">558</div><div class="line">559</div><div class="line">560</div><div class="line">561</div><div class="line">562</div><div class="line">563</div><div class="line">564</div><div class="line">565</div><div class="line">566</div><div class="line">567</div><div class="line">568</div><div class="line">569</div><div class="line">570</div><div class="line">571</div><div class="line">572</div><div class="line">573</div><div class="line">574</div><div class="line">575</div><div class="line">576</div><div class="line">577</div><div class="line">578</div><div class="line">579</div><div class="line">580</div><div class="line">581</div><div class="line">582</div><div class="line">583</div><div class="line">584</div><div class="line">585</div><div class="line">586</div><div class="line">587</div><div class="line">588</div><div class="line">589</div><div class="line">590</div><div class="line">591</div><div class="line">592</div><div class="line">593</div><div class="line">594</div><div class="line">595</div><div class="line">596</div><div class="line">597</div><div class="line">598</div><div class="line">599</div><div class="line">600</div><div class="line">601</div><div class="line">602</div><div class="line">603</div><div class="line">604</div><div class="line">605</div><div class="line">606</div><div class="line">607</div><div class="line">608</div><div class="line">609</div><div class="line">610</div><div class="line">611</div><div class="line">612</div><div class="line">613</div><div class="line">614</div><div class="line">615</div><div class="line">616</div><div class="line">617</div><div class="line">618</div><div class="line">619</div><div class="line">620</div><div class="line">621</div><div class="line">622</div><div class="line">623</div><div class="line">624</div><div class="line">625</div><div class="line">626</div><div class="line">627</div><div class="line">628</div><div class="line">629</div><div class="line">630</div><div class="line">631</div><div class="line">632</div><div class="line">633</div><div class="line">634</div><div class="line">635</div><div class="line">636</div><div class="line">637</div><div class="line">638</div><div class="line">639</div><div class="line">640</div><div class="line">641</div><div class="line">642</div><div class="line">643</div><div class="line">644</div><div class="line">645</div><div class="line">646</div><div class="line">647</div><div class="line">648</div><div class="line">649</div><div class="line">650</div><div class="line">651</div><div class="line">652</div><div class="line">653</div><div class="line">654</div><div class="line">655</div><div class="line">656</div><div class="line">657</div><div class="line">658</div><div class="line">659</div><div class="line">660</div><div class="line">661</div><div class="line">662</div><div class="line">663</div><div class="line">664</div><div class="line">665</div><div class="line">666</div><div class="line">667</div><div class="line">668</div><div class="line">669</div><div class="line">670</div><div class="line">671</div><div class="line">672</div><div class="line">673</div><div class="line">674</div><div class="line">675</div><div class="line">676</div><div class="line">677</div><div class="line">678</div><div class="line">679</div><div class="line">680</div><div class="line">681</div><div class="line">682</div><div class="line">683</div><div class="line">684</div><div class="line">685</div><div class="line">686</div><div class="line">687</div><div class="line">688</div><div class="line">689</div><div class="line">690</div><div class="line">691</div><div class="line">692</div><div class="line">693</div><div class="line">694</div><div class="line">695</div><div class="line">696</div><div class="line">697</div><div class="line">698</div><div class="line">699</div><div class="line">700</div><div class="line">701</div><div class="line">702</div><div class="line">703</div><div class="line">704</div><div class="line">705</div><div class="line">706</div><div class="line">707</div><div class="line">708</div><div class="line">709</div><div class="line">710</div><div class="line">711</div><div class="line">712</div><div class="line">713</div><div class="line">714</div><div class="line">715</div><div class="line">716</div><div class="line">717</div><div class="line">718</div><div class="line">719</div><div class="line">720</div><div class="line">721</div><div class="line">722</div><div class="line">723</div><div class="line">724</div><div class="line">725</div><div class="line">726</div><div class="line">727</div><div class="line">728</div><div class="line">729</div><div class="line">730</div><div class="line">731</div><div class="line">732</div><div class="line">733</div><div class="line">734</div><div class="line">735</div><div class="line">736</div><div class="line">737</div><div class="line">738</div><div class="line">739</div><div class="line">740</div><div class="line">741</div><div class="line">742</div><div class="line">743</div><div class="line">744</div><div class="line">745</div><div class="line">746</div><div class="line">747</div><div class="line">748</div><div class="line">749</div><div class="line">750</div><div class="line">751</div><div class="line">752</div><div class="line">753</div><div class="line">754</div><div class="line">755</div><div class="line">756</div><div class="line">757</div><div class="line">758</div><div class="line">759</div><div class="line">760</div><div class="line">761</div><div class="line">762</div><div class="line">763</div><div class="line">764</div><div class="line">765</div><div class="line">766</div><div class="line">767</div><div class="line">768</div><div class="line">769</div><div class="line">770</div><div class="line">771</div><div class="line">772</div><div class="line">773</div><div class="line">774</div><div class="line">775</div><div class="line">776</div><div class="line">777</div><div class="line">778</div><div class="line">779</div><div class="line">780</div><div class="line">781</div><div class="line">782</div><div class="line">783</div><div class="line">784</div><div class="line">785</div><div class="line">786</div><div class="line">787</div><div class="line">788</div><div class="line">789</div><div class="line">790</div><div class="line">791</div><div class="line">792</div><div class="line">793</div><div class="line">794</div><div class="line">795</div><div class="line">796</div><div class="line">797</div><div class="line">798</div><div class="line">799</div><div class="line">800</div><div class="line">801</div><div class="line">802</div><div class="line">803</div><div class="line">804</div><div class="line">805</div><div class="line">806</div><div class="line">807</div><div class="line">808</div><div class="line">809</div><div class="line">810</div><div class="line">811</div><div class="line">812</div><div class="line">813</div><div class="line">814</div><div class="line">815</div><div class="line">816</div><div class="line">817</div><div class="line">818</div><div class="line">819</div><div class="line">820</div><div class="line">821</div><div class="line">822</div><div class="line">823</div><div class="line">824</div><div class="line">825</div><div class="line">826</div><div class="line">827</div><div class="line">828</div><div class="line">829</div><div class="line">830</div><div class="line">831</div><div class="line">832</div><div class="line">833</div><div class="line">834</div><div class="line">835</div><div class="line">836</div><div class="line">837</div><div class="line">838</div><div class="line">839</div><div class="line">840</div><div class="line">841</div><div class="line">842</div><div class="line">843</div><div class="line">844</div><div class="line">845</div><div class="line">846</div><div class="line">847</div><div class="line">848</div><div class="line">849</div><div class="line">850</div><div class="line">851</div><div class="line">852</div><div class="line">853</div><div class="line">854</div><div class="line">855</div><div class="line">856</div><div class="line">857</div><div class="line">858</div><div class="line">859</div><div class="line">860</div><div class="line">861</div><div class="line">862</div><div class="line">863</div><div class="line">864</div><div class="line">865</div><div class="line">866</div><div class="line">867</div><div class="line">868</div><div class="line">869</div><div class="line">870</div><div class="line">871</div><div class="line">872</div><div class="line">873</div><div class="line">874</div><div class="line">875</div><div class="line">876</div><div class="line">877</div><div class="line">878</div><div class="line">879</div><div class="line">880</div><div class="line">881</div><div class="line">882</div><div class="line">883</div><div class="line">884</div><div class="line">885</div><div class="line">886</div><div class="line">887</div><div class="line">888</div><div class="line">889</div><div class="line">890</div><div class="line">891</div><div class="line">892</div><div class="line">893</div><div class="line">894</div><div class="line">895</div><div class="line">896</div><div class="line">897</div><div class="line">898</div><div class="line">899</div><div class="line">900</div><div class="line">901</div><div class="line">902</div><div class="line">903</div><div class="line">904</div><div class="line">905</div><div class="line">906</div><div class="line">907</div><div class="line">908</div><div class="line">909</div><div class="line">910</div><div class="line">911</div><div class="line">912</div><div class="line">913</div><div class="line">914</div><div class="line">915</div><div class="line">916</div><div class="line">917</div><div class="line">918</div><div class="line">919</div><div class="line">920</div><div class="line">921</div><div class="line">922</div><div class="line">923</div><div class="line">924</div><div class="line">925</div><div class="line">926</div><div class="line">927</div><div class="line">928</div><div class="line">929</div><div class="line">930</div><div class="line">931</div><div class="line">932</div><div class="line">933</div><div class="line">934</div><div class="line">935</div><div class="line">936</div><div class="line">937</div><div class="line">938</div><div class="line">939</div><div class="line">940</div><div class="line">941</div><div class="line">942</div><div class="line">943</div><div class="line">944</div><div class="line">945</div><div class="line">946</div><div class="line">947</div><div class="line">948</div><div class="line">949</div><div class="line">950</div><div class="line">951</div><div class="line">952</div><div class="line">953</div><div class="line">954</div><div class="line">955</div><div class="line">956</div><div class="line">957</div><div class="line">958</div><div class="line">959</div><div class="line">960</div><div class="line">961</div><div class="line">962</div><div class="line">963</div><div class="line">964</div><div class="line">965</div><div class="line">966</div><div class="line">967</div><div class="line">968</div><div class="line">969</div><div class="line">970</div><div class="line">971</div><div class="line">972</div><div class="line">973</div><div class="line">974</div><div class="line">975</div><div class="line">976</div><div class="line">977</div><div class="line">978</div><div class="line">979</div><div class="line">980</div><div class="line">981</div><div class="line">982</div><div class="line">983</div><div class="line">984</div><div class="line">985</div><div class="line">986</div><div class="line">987</div><div class="line">988</div><div class="line">989</div><div class="line">990</div><div class="line">991</div><div class="line">992</div><div class="line">993</div><div class="line">994</div><div class="line">995</div><div class="line">996</div><div class="line">997</div><div class="line">998</div><div class="line">999</div><div class="line">1000</div><div class="line">1001</div><div class="line">1002</div><div class="line">1003</div><div class="line">1004</div><div class="line">1005</div><div class="line">1006</div><div class="line">1007</div><div class="line">1008</div><div class="line">1009</div><div class="line">1010</div><div class="line">1011</div><div class="line">1012</div><div class="line">1013</div><div class="line">1014</div><div class="line">1015</div><div class="line">1016</div><div class="line">1017</div><div class="line">1018</div><div class="line">1019</div><div class="line">1020</div><div class="line">1021</div><div class="line">1022</div><div class="line">1023</div><div class="line">1024</div><div class="line">1025</div><div class="line">1026</div><div class="line">1027</div><div class="line">1028</div><div class="line">1029</div><div class="line">1030</div><div class="line">1031</div><div class="line">1032</div><div class="line">1033</div><div class="line">1034</div><div class="line">1035</div><div class="line">1036</div><div class="line">1037</div><div class="line">1038</div><div class="line">1039</div><div class="line">1040</div><div class="line">1041</div><div class="line">1042</div><div class="line">1043</div><div class="line">1044</div><div class="line">1045</div><div class="line">1046</div><div class="line">1047</div><div class="line">1048</div><div class="line">1049</div><div class="line">1050</div><div class="line">1051</div><div class="line">1052</div><div class="line">1053</div><div class="line">1054</div><div class="line">1055</div><div class="line">1056</div><div class="line">1057</div><div class="line">1058</div><div class="line">1059</div><div class="line">1060</div><div class="line">1061</div><div class="line">1062</div><div class="line">1063</div><div class="line">1064</div><div class="line">1065</div><div class="line">1066</div><div class="line">1067</div><div class="line">1068</div><div class="line">1069</div><div class="line">1070</div><div class="line">1071</div><div class="line">1072</div><div class="line">1073</div><div class="line">1074</div><div class="line">1075</div><div class="line">1076</div><div class="line">1077</div><div class="line">1078</div><div class="line">1079</div><div class="line">1080</div><div class="line">1081</div><div class="line">1082</div><div class="line">1083</div><div class="line">1084</div><div class="line">1085</div><div class="line">1086</div><div class="line">1087</div><div class="line">1088</div><div class="line">1089</div><div class="line">1090</div><div class="line">1091</div><div class="line">1092</div><div class="line">1093</div><div class="line">1094</div><div class="line">1095</div><div class="line">1096</div><div class="line">1097</div><div class="line">1098</div><div class="line">1099</div><div class="line">1100</div><div class="line">1101</div><div class="line">1102</div><div class="line">1103</div><div class="line">1104</div><div class="line">1105</div><div class="line">1106</div><div class="line">1107</div><div class="line">1108</div><div class="line">1109</div><div class="line">1110</div><div class="line">1111</div><div class="line">1112</div><div class="line">1113</div><div class="line">1114</div><div class="line">1115</div><div class="line">1116</div><div class="line">1117</div><div class="line">1118</div><div class="line">1119</div><div class="line">1120</div><div class="line">1121</div><div class="line">1122</div><div class="line">1123</div><div class="line">1124</div><div class="line">1125</div><div class="line">1126</div><div class="line">1127</div><div class="line">1128</div><div class="line">1129</div><div class="line">1130</div><div class="line">1131</div><div class="line">1132</div><div class="line">1133</div><div class="line">1134</div><div class="line">1135</div><div class="line">1136</div><div class="line">1137</div><div class="line">1138</div><div class="line">1139</div><div class="line">1140</div><div class="line">1141</div><div class="line">1142</div><div class="line">1143</div><div class="line">1144</div><div class="line">1145</div><div class="line">1146</div><div class="line">1147</div><div class="line">1148</div><div class="line">1149</div><div class="line">1150</div><div class="line">1151</div><div class="line">1152</div><div class="line">1153</div><div class="line">1154</div><div class="line">1155</div><div class="line">1156</div><div class="line">1157</div><div class="line">1158</div><div class="line">1159</div><div class="line">1160</div><div class="line">1161</div><div class="line">1162</div><div class="line">1163</div><div class="line">1164</div><div class="line">1165</div><div class="line">1166</div><div class="line">1167</div><div class="line">1168</div><div class="line">1169</div><div class="line">1170</div><div class="line">1171</div><div class="line">1172</div><div class="line">1173</div><div class="line">1174</div><div class="line">1175</div><div class="line">1176</div><div class="line">1177</div><div class="line">1178</div><div class="line">1179</div><div class="line">1180</div><div class="line">1181</div><div class="line">1182</div><div class="line">1183</div><div class="line">1184</div><div class="line">1185</div><div class="line">1186</div><div class="line">1187</div><div class="line">1188</div><div class="line">1189</div><div class="line">1190</div><div class="line">1191</div><div class="line">1192</div><div class="line">1193</div><div class="line">1194</div><div class="line">1195</div><div class="line">1196</div><div class="line">1197</div><div class="line">1198</div><div class="line">1199</div><div class="line">1200</div><div class="line">1201</div><div class="line">1202</div><div class="line">1203</div><div class="line">1204</div><div class="line">1205</div><div class="line">1206</div><div class="line">1207</div><div class="line">1208</div><div class="line">1209</div><div class="line">1210</div><div class="line">1211</div><div class="line">1212</div><div class="line">1213</div><div class="line">1214</div><div class="line">1215</div><div class="line">1216</div><div class="line">1217</div><div class="line">1218</div><div class="line">1219</div><div class="line">1220</div><div class="line">1221</div><div class="line">1222</div><div class="line">1223</div><div class="line">1224</div><div class="line">1225</div><div class="line">1226</div><div class="line">1227</div><div class="line">1228</div><div class="line">1229</div><div class="line">1230</div><div class="line">1231</div><div class="line">1232</div><div class="line">1233</div><div class="line">1234</div><div class="line">1235</div><div class="line">1236</div><div class="line">1237</div><div class="line">1238</div><div class="line">1239</div><div class="line">1240</div><div class="line">1241</div><div class="line">1242</div><div class="line">1243</div><div class="line">1244</div><div class="line">1245</div><div class="line">1246</div><div class="line">1247</div><div class="line">1248</div><div class="line">1249</div><div class="line">1250</div><div class="line">1251</div><div class="line">1252</div><div class="line">1253</div><div class="line">1254</div><div class="line">1255</div><div class="line">1256</div><div class="line">1257</div><div class="line">1258</div><div class="line">1259</div><div class="line">1260</div><div class="line">1261</div><div class="line">1262</div><div class="line">1263</div><div class="line">1264</div><div class="line">1265</div><div class="line">1266</div><div class="line">1267</div><div class="line">1268</div><div class="line">1269</div><div class="line">1270</div><div class="line">1271</div><div class="line">1272</div><div class="line">1273</div><div class="line">1274</div><div class="line">1275</div><div class="line">1276</div><div class="line">1277</div><div class="line">1278</div><div class="line">1279</div><div class="line">1280</div><div class="line">1281</div><div class="line">1282</div><div class="line">1283</div><div class="line">1284</div><div class="line">1285</div><div class="line">1286</div><div class="line">1287</div><div class="line">1288</div><div class="line">1289</div><div class="line">1290</div><div class="line">1291</div><div class="line">1292</div><div class="line">1293</div><div class="line">1294</div><div class="line">1295</div><div class="line">1296</div><div class="line">1297</div><div class="line">1298</div><div class="line">1299</div><div class="line">1300</div><div class="line">1301</div><div class="line">1302</div><div class="line">1303</div><div class="line">1304</div><div class="line">1305</div><div class="line">1306</div><div class="line">1307</div><div class="line">1308</div><div class="line">1309</div><div class="line">1310</div><div class="line">1311</div><div class="line">1312</div><div class="line">1313</div><div class="line">1314</div><div class="line">1315</div><div class="line">1316</div><div class="line">1317</div><div class="line">1318</div><div class="line">1319</div><div class="line">1320</div><div class="line">1321</div><div class="line">1322</div><div class="line">1323</div><div class="line">1324</div><div class="line">1325</div><div class="line">1326</div><div class="line">1327</div><div class="line">1328</div><div class="line">1329</div><div class="line">1330</div><div class="line">1331</div><div class="line">1332</div><div class="line">1333</div><div class="line">1334</div><div class="line">1335</div><div class="line">1336</div><div class="line">1337</div><div class="line">1338</div><div class="line">1339</div><div class="line">1340</div><div class="line">1341</div><div class="line">1342</div><div class="line">1343</div><div class="line">1344</div><div class="line">1345</div><div class="line">1346</div><div class="line">1347</div><div class="line">1348</div><div class="line">1349</div><div class="line">1350</div><div class="line">1351</div><div class="line">1352</div><div class="line">1353</div><div class="line">1354</div><div class="line">1355</div><div class="line">1356</div><div class="line">1357</div><div class="line">1358</div><div class="line">1359</div><div class="line">1360</div><div class="line">1361</div><div class="line">1362</div><div class="line">1363</div><div class="line">1364</div><div class="line">1365</div><div class="line">1366</div><div class="line">1367</div><div class="line">1368</div><div class="line">1369</div><div class="line">1370</div><div class="line">1371</div><div class="line">1372</div><div class="line">1373</div><div class="line">1374</div><div class="line">1375</div><div class="line">1376</div><div class="line">1377</div></pre></td><td class="code"><pre><div class="line"># Redis configuration file example.</div><div class="line">#</div><div class="line"># Note that in order to read the configuration file, Redis must be</div><div class="line"># started with the file path as first argument:</div><div class="line">#</div><div class="line"># ./redis-server /path/to/redis.conf</div><div class="line"></div><div class="line"># Note on units: when memory size is needed, it is possible to specify</div><div class="line"># it in the usual form of 1k 5GB 4M and so forth:</div><div class="line">#</div><div class="line"># 1k =&gt; 1000 bytes</div><div class="line"># 1kb =&gt; 1024 bytes</div><div class="line"># 1m =&gt; 1000000 bytes</div><div class="line"># 1mb =&gt; 1024*1024 bytes</div><div class="line"># 1g =&gt; 1000000000 bytes</div><div class="line"># 1gb =&gt; 1024*1024*1024 bytes</div><div class="line">#</div><div class="line"># units are case insensitive so 1GB 1Gb 1gB are all the same.</div><div class="line"></div><div class="line">################################## INCLUDES ###################################</div><div class="line"></div><div class="line"># Include one or more other config files here.  This is useful if you</div><div class="line"># have a standard template that goes to all Redis servers but also need</div><div class="line"># to customize a few per-server settings.  Include files can include</div><div class="line"># other files, so use this wisely.</div><div class="line">#</div><div class="line"># Notice option &quot;include&quot; won&apos;t be rewritten by command &quot;CONFIG REWRITE&quot;</div><div class="line"># from admin or Redis Sentinel. Since Redis always uses the last processed</div><div class="line"># line as value of a configuration directive, you&apos;d better put includes</div><div class="line"># at the beginning of this file to avoid overwriting config change at runtime.</div><div class="line">#</div><div class="line"># If instead you are interested in using includes to override configuration</div><div class="line"># options, it is better to use include as the last line.</div><div class="line">#</div><div class="line"># include /path/to/local.conf</div><div class="line"># include /path/to/other.conf</div><div class="line"></div><div class="line">################################## MODULES #####################################</div><div class="line"></div><div class="line"># Load modules at startup. If the server is not able to load modules</div><div class="line"># it will abort. It is possible to use multiple loadmodule directives.</div><div class="line">#</div><div class="line"># loadmodule /path/to/my_module.so</div><div class="line"># loadmodule /path/to/other_module.so</div><div class="line"></div><div class="line">################################## NETWORK #####################################</div><div class="line"></div><div class="line"># By default, if no &quot;bind&quot; configuration directive is specified, Redis listens</div><div class="line"># for connections from all the network interfaces available on the server.</div><div class="line"># It is possible to listen to just one or multiple selected interfaces using</div><div class="line"># the &quot;bind&quot; configuration directive, followed by one or more IP addresses.</div><div class="line">#</div><div class="line"># Examples:</div><div class="line">#</div><div class="line"># bind 192.168.1.100 10.0.0.1</div><div class="line"># bind 127.0.0.1 ::1</div><div class="line">#</div><div class="line"># ~~~ WARNING ~~~ If the computer running Redis is directly exposed to the</div><div class="line"># internet, binding to all the interfaces is dangerous and will expose the</div><div class="line"># instance to everybody on the internet. So by default we uncomment the</div><div class="line"># following bind directive, that will force Redis to listen only into</div><div class="line"># the IPv4 loopback interface address (this means Redis will be able to</div><div class="line"># accept connections only from clients running into the same computer it</div><div class="line"># is running).</div><div class="line">#</div><div class="line"># IF YOU ARE SURE YOU WANT YOUR INSTANCE TO LISTEN TO ALL THE INTERFACES</div><div class="line"># JUST COMMENT THE FOLLOWING LINE.</div><div class="line"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</div><div class="line"># bind 127.0.0.1</div><div class="line"></div><div class="line"># Protected mode is a layer of security protection, in order to avoid that</div><div class="line"># Redis instances left open on the internet are accessed and exploited.</div><div class="line">#</div><div class="line"># When protected mode is on and if:</div><div class="line">#</div><div class="line"># 1) The server is not binding explicitly to a set of addresses using the</div><div class="line">#    &quot;bind&quot; directive.</div><div class="line"># 2) No password is configured.</div><div class="line">#</div><div class="line"># The server only accepts connections from clients connecting from the</div><div class="line"># IPv4 and IPv6 loopback addresses 127.0.0.1 and ::1, and from Unix domain</div><div class="line"># sockets.</div><div class="line">#</div><div class="line"># By default protected mode is enabled. You should disable it only if</div><div class="line"># you are sure you want clients from other hosts to connect to Redis</div><div class="line"># even if no authentication is configured, nor a specific set of interfaces</div><div class="line"># are explicitly listed using the &quot;bind&quot; directive.</div><div class="line">protected-mode yes</div><div class="line"></div><div class="line"># Accept connections on the specified port, default is 6379 (IANA #815344).</div><div class="line"># If port 0 is specified Redis will not listen on a TCP socket.</div><div class="line">port 6379</div><div class="line"></div><div class="line"># TCP listen() backlog.</div><div class="line">#</div><div class="line"># In high requests-per-second environments you need an high backlog in order</div><div class="line"># to avoid slow clients connections issues. Note that the Linux kernel</div><div class="line"># will silently truncate it to the value of /proc/sys/net/core/somaxconn so</div><div class="line"># make sure to raise both the value of somaxconn and tcp_max_syn_backlog</div><div class="line"># in order to get the desired effect.</div><div class="line">tcp-backlog 511</div><div class="line"></div><div class="line"># Unix socket.</div><div class="line">#</div><div class="line"># Specify the path for the Unix socket that will be used to listen for</div><div class="line"># incoming connections. There is no default, so Redis will not listen</div><div class="line"># on a unix socket when not specified.</div><div class="line">#</div><div class="line"># unixsocket /tmp/redis.sock</div><div class="line"># unixsocketperm 700</div><div class="line"></div><div class="line"># Close the connection after a client is idle for N seconds (0 to disable)</div><div class="line">timeout 0</div><div class="line"></div><div class="line"># TCP keepalive.</div><div class="line">#</div><div class="line"># If non-zero, use SO_KEEPALIVE to send TCP ACKs to clients in absence</div><div class="line"># of communication. This is useful for two reasons:</div><div class="line">#</div><div class="line"># 1) Detect dead peers.</div><div class="line"># 2) Take the connection alive from the point of view of network</div><div class="line">#    equipment in the middle.</div><div class="line">#</div><div class="line"># On Linux, the specified value (in seconds) is the period used to send ACKs.</div><div class="line"># Note that to close the connection the double of the time is needed.</div><div class="line"># On other kernels the period depends on the kernel configuration.</div><div class="line">#</div><div class="line"># A reasonable value for this option is 300 seconds, which is the new</div><div class="line"># Redis default starting with Redis 3.2.1.</div><div class="line">tcp-keepalive 300</div><div class="line"></div><div class="line">################################# GENERAL #####################################</div><div class="line"></div><div class="line"># By default Redis does not run as a daemon. Use &apos;yes&apos; if you need it.</div><div class="line"># Note that Redis will write a pid file in /var/run/redis.pid when daemonized.</div><div class="line">daemonize no</div><div class="line"></div><div class="line"># If you run Redis from upstart or systemd, Redis can interact with your</div><div class="line"># supervision tree. Options:</div><div class="line">#   supervised no      - no supervision interaction</div><div class="line">#   supervised upstart - signal upstart by putting Redis into SIGSTOP mode</div><div class="line">#   supervised systemd - signal systemd by writing READY=1 to $NOTIFY_SOCKET</div><div class="line">#   supervised auto    - detect upstart or systemd method based on</div><div class="line">#                        UPSTART_JOB or NOTIFY_SOCKET environment variables</div><div class="line"># Note: these supervision methods only signal &quot;process is ready.&quot;</div><div class="line">#       They do not enable continuous liveness pings back to your supervisor.</div><div class="line">supervised no</div><div class="line"></div><div class="line"># If a pid file is specified, Redis writes it where specified at startup</div><div class="line"># and removes it at exit.</div><div class="line">#</div><div class="line"># When the server runs non daemonized, no pid file is created if none is</div><div class="line"># specified in the configuration. When the server is daemonized, the pid file</div><div class="line"># is used even if not specified, defaulting to &quot;/var/run/redis.pid&quot;.</div><div class="line">#</div><div class="line"># Creating a pid file is best effort: if Redis is not able to create it</div><div class="line"># nothing bad happens, the server will start and run normally.</div><div class="line">pidfile /var/run/redis_6379.pid</div><div class="line"></div><div class="line"># Specify the server verbosity level.</div><div class="line"># This can be one of:</div><div class="line"># debug (a lot of information, useful for development/testing)</div><div class="line"># verbose (many rarely useful info, but not a mess like the debug level)</div><div class="line"># notice (moderately verbose, what you want in production probably)</div><div class="line"># warning (only very important / critical messages are logged)</div><div class="line">loglevel notice</div><div class="line"></div><div class="line"># Specify the log file name. Also the empty string can be used to force</div><div class="line"># Redis to log on the standard output. Note that if you use standard</div><div class="line"># output for logging but daemonize, logs will be sent to /dev/null</div><div class="line">logfile &quot;&quot;</div><div class="line"></div><div class="line"># To enable logging to the system logger, just set &apos;syslog-enabled&apos; to yes,</div><div class="line"># and optionally update the other syslog parameters to suit your needs.</div><div class="line"># syslog-enabled no</div><div class="line"></div><div class="line"># Specify the syslog identity.</div><div class="line"># syslog-ident redis</div><div class="line"></div><div class="line"># Specify the syslog facility. Must be USER or between LOCAL0-LOCAL7.</div><div class="line"># syslog-facility local0</div><div class="line"></div><div class="line"># Set the number of databases. The default database is DB 0, you can select</div><div class="line"># a different one on a per-connection basis using SELECT &lt;dbid&gt; where</div><div class="line"># dbid is a number between 0 and &apos;databases&apos;-1</div><div class="line">databases 16</div><div class="line"></div><div class="line"># By default Redis shows an ASCII art logo only when started to log to the</div><div class="line"># standard output and if the standard output is a TTY. Basically this means</div><div class="line"># that normally a logo is displayed only in interactive sessions.</div><div class="line">#</div><div class="line"># However it is possible to force the pre-4.0 behavior and always show a</div><div class="line"># ASCII art logo in startup logs by setting the following option to yes.</div><div class="line">always-show-logo yes</div><div class="line"></div><div class="line">################################ SNAPSHOTTING  ################################</div><div class="line">#</div><div class="line"># Save the DB on disk:</div><div class="line">#</div><div class="line">#   save &lt;seconds&gt; &lt;changes&gt;</div><div class="line">#</div><div class="line">#   Will save the DB if both the given number of seconds and the given</div><div class="line">#   number of write operations against the DB occurred.</div><div class="line">#</div><div class="line">#   In the example below the behaviour will be to save:</div><div class="line">#   after 900 sec (15 min) if at least 1 key changed</div><div class="line">#   after 300 sec (5 min) if at least 10 keys changed</div><div class="line">#   after 60 sec if at least 10000 keys changed</div><div class="line">#</div><div class="line">#   Note: you can disable saving completely by commenting out all &quot;save&quot; lines.</div><div class="line">#</div><div class="line">#   It is also possible to remove all the previously configured save</div><div class="line">#   points by adding a save directive with a single empty string argument</div><div class="line">#   like in the following example:</div><div class="line">#</div><div class="line">#   save &quot;&quot;</div><div class="line"></div><div class="line">save 900 1</div><div class="line">save 300 10</div><div class="line">save 60 10000</div><div class="line"></div><div class="line"># By default Redis will stop accepting writes if RDB snapshots are enabled</div><div class="line"># (at least one save point) and the latest background save failed.</div><div class="line"># This will make the user aware (in a hard way) that data is not persisting</div><div class="line"># on disk properly, otherwise chances are that no one will notice and some</div><div class="line"># disaster will happen.</div><div class="line">#</div><div class="line"># If the background saving process will start working again Redis will</div><div class="line"># automatically allow writes again.</div><div class="line">#</div><div class="line"># However if you have setup your proper monitoring of the Redis server</div><div class="line"># and persistence, you may want to disable this feature so that Redis will</div><div class="line"># continue to work as usual even if there are problems with disk,</div><div class="line"># permissions, and so forth.</div><div class="line">stop-writes-on-bgsave-error yes</div><div class="line"></div><div class="line"># Compress string objects using LZF when dump .rdb databases?</div><div class="line"># For default that&apos;s set to &apos;yes&apos; as it&apos;s almost always a win.</div><div class="line"># If you want to save some CPU in the saving child set it to &apos;no&apos; but</div><div class="line"># the dataset will likely be bigger if you have compressible values or keys.</div><div class="line">rdbcompression yes</div><div class="line"></div><div class="line"># Since version 5 of RDB a CRC64 checksum is placed at the end of the file.</div><div class="line"># This makes the format more resistant to corruption but there is a performance</div><div class="line"># hit to pay (around 10%) when saving and loading RDB files, so you can disable it</div><div class="line"># for maximum performances.</div><div class="line">#</div><div class="line"># RDB files created with checksum disabled have a checksum of zero that will</div><div class="line"># tell the loading code to skip the check.</div><div class="line">rdbchecksum yes</div><div class="line"></div><div class="line"># The filename where to dump the DB</div><div class="line">dbfilename dump.rdb</div><div class="line"></div><div class="line"># The working directory.</div><div class="line">#</div><div class="line"># The DB will be written inside this directory, with the filename specified</div><div class="line"># above using the &apos;dbfilename&apos; configuration directive.</div><div class="line">#</div><div class="line"># The Append Only File will also be created inside this directory.</div><div class="line">#</div><div class="line"># Note that you must specify a directory here, not a file name.</div><div class="line">dir ./</div><div class="line"></div><div class="line">################################# REPLICATION #################################</div><div class="line"></div><div class="line"># Master-Replica replication. Use replicaof to make a Redis instance a copy of</div><div class="line"># another Redis server. A few things to understand ASAP about Redis replication.</div><div class="line">#</div><div class="line">#   +------------------+      +---------------+</div><div class="line">#   |      Master      | ---&gt; |    Replica    |</div><div class="line">#   | (receive writes) |      |  (exact copy) |</div><div class="line">#   +------------------+      +---------------+</div><div class="line">#</div><div class="line"># 1) Redis replication is asynchronous, but you can configure a master to</div><div class="line">#    stop accepting writes if it appears to be not connected with at least</div><div class="line">#    a given number of replicas.</div><div class="line"># 2) Redis replicas are able to perform a partial resynchronization with the</div><div class="line">#    master if the replication link is lost for a relatively small amount of</div><div class="line">#    time. You may want to configure the replication backlog size (see the next</div><div class="line">#    sections of this file) with a sensible value depending on your needs.</div><div class="line"># 3) Replication is automatic and does not need user intervention. After a</div><div class="line">#    network partition replicas automatically try to reconnect to masters</div><div class="line">#    and resynchronize with them.</div><div class="line">#</div><div class="line"># replicaof &lt;masterip&gt; &lt;masterport&gt;</div><div class="line"></div><div class="line"># If the master is password protected (using the &quot;requirepass&quot; configuration</div><div class="line"># directive below) it is possible to tell the replica to authenticate before</div><div class="line"># starting the replication synchronization process, otherwise the master will</div><div class="line"># refuse the replica request.</div><div class="line">#</div><div class="line"># masterauth &lt;master-password&gt;</div><div class="line"></div><div class="line"># When a replica loses its connection with the master, or when the replication</div><div class="line"># is still in progress, the replica can act in two different ways:</div><div class="line">#</div><div class="line"># 1) if replica-serve-stale-data is set to &apos;yes&apos; (the default) the replica will</div><div class="line">#    still reply to client requests, possibly with out of date data, or the</div><div class="line">#    data set may just be empty if this is the first synchronization.</div><div class="line">#</div><div class="line"># 2) if replica-serve-stale-data is set to &apos;no&apos; the replica will reply with</div><div class="line">#    an error &quot;SYNC with master in progress&quot; to all the kind of commands</div><div class="line">#    but to INFO, replicaOF, AUTH, PING, SHUTDOWN, REPLCONF, ROLE, CONFIG,</div><div class="line">#    SUBSCRIBE, UNSUBSCRIBE, PSUBSCRIBE, PUNSUBSCRIBE, PUBLISH, PUBSUB,</div><div class="line">#    COMMAND, POST, HOST: and LATENCY.</div><div class="line">#</div><div class="line">replica-serve-stale-data yes</div><div class="line"></div><div class="line"># You can configure a replica instance to accept writes or not. Writing against</div><div class="line"># a replica instance may be useful to store some ephemeral data (because data</div><div class="line"># written on a replica will be easily deleted after resync with the master) but</div><div class="line"># may also cause problems if clients are writing to it because of a</div><div class="line"># misconfiguration.</div><div class="line">#</div><div class="line"># Since Redis 2.6 by default replicas are read-only.</div><div class="line">#</div><div class="line"># Note: read only replicas are not designed to be exposed to untrusted clients</div><div class="line"># on the internet. It&apos;s just a protection layer against misuse of the instance.</div><div class="line"># Still a read only replica exports by default all the administrative commands</div><div class="line"># such as CONFIG, DEBUG, and so forth. To a limited extent you can improve</div><div class="line"># security of read only replicas using &apos;rename-command&apos; to shadow all the</div><div class="line"># administrative / dangerous commands.</div><div class="line">replica-read-only yes</div><div class="line"></div><div class="line"># Replication SYNC strategy: disk or socket.</div><div class="line">#</div><div class="line"># -------------------------------------------------------</div><div class="line"># WARNING: DISKLESS REPLICATION IS EXPERIMENTAL CURRENTLY</div><div class="line"># -------------------------------------------------------</div><div class="line">#</div><div class="line"># New replicas and reconnecting replicas that are not able to continue the replication</div><div class="line"># process just receiving differences, need to do what is called a &quot;full</div><div class="line"># synchronization&quot;. An RDB file is transmitted from the master to the replicas.</div><div class="line"># The transmission can happen in two different ways:</div><div class="line">#</div><div class="line"># 1) Disk-backed: The Redis master creates a new process that writes the RDB</div><div class="line">#                 file on disk. Later the file is transferred by the parent</div><div class="line">#                 process to the replicas incrementally.</div><div class="line"># 2) Diskless: The Redis master creates a new process that directly writes the</div><div class="line">#              RDB file to replica sockets, without touching the disk at all.</div><div class="line">#</div><div class="line"># With disk-backed replication, while the RDB file is generated, more replicas</div><div class="line"># can be queued and served with the RDB file as soon as the current child producing</div><div class="line"># the RDB file finishes its work. With diskless replication instead once</div><div class="line"># the transfer starts, new replicas arriving will be queued and a new transfer</div><div class="line"># will start when the current one terminates.</div><div class="line">#</div><div class="line"># When diskless replication is used, the master waits a configurable amount of</div><div class="line"># time (in seconds) before starting the transfer in the hope that multiple replicas</div><div class="line"># will arrive and the transfer can be parallelized.</div><div class="line">#</div><div class="line"># With slow disks and fast (large bandwidth) networks, diskless replication</div><div class="line"># works better.</div><div class="line">repl-diskless-sync no</div><div class="line"></div><div class="line"># When diskless replication is enabled, it is possible to configure the delay</div><div class="line"># the server waits in order to spawn the child that transfers the RDB via socket</div><div class="line"># to the replicas.</div><div class="line">#</div><div class="line"># This is important since once the transfer starts, it is not possible to serve</div><div class="line"># new replicas arriving, that will be queued for the next RDB transfer, so the server</div><div class="line"># waits a delay in order to let more replicas arrive.</div><div class="line">#</div><div class="line"># The delay is specified in seconds, and by default is 5 seconds. To disable</div><div class="line"># it entirely just set it to 0 seconds and the transfer will start ASAP.</div><div class="line">repl-diskless-sync-delay 5</div><div class="line"></div><div class="line"># Replicas send PINGs to server in a predefined interval. It&apos;s possible to change</div><div class="line"># this interval with the repl_ping_replica_period option. The default value is 10</div><div class="line"># seconds.</div><div class="line">#</div><div class="line"># repl-ping-replica-period 10</div><div class="line"></div><div class="line"># The following option sets the replication timeout for:</div><div class="line">#</div><div class="line"># 1) Bulk transfer I/O during SYNC, from the point of view of replica.</div><div class="line"># 2) Master timeout from the point of view of replicas (data, pings).</div><div class="line"># 3) Replica timeout from the point of view of masters (REPLCONF ACK pings).</div><div class="line">#</div><div class="line"># It is important to make sure that this value is greater than the value</div><div class="line"># specified for repl-ping-replica-period otherwise a timeout will be detected</div><div class="line"># every time there is low traffic between the master and the replica.</div><div class="line">#</div><div class="line"># repl-timeout 60</div><div class="line"></div><div class="line"># Disable TCP_NODELAY on the replica socket after SYNC?</div><div class="line">#</div><div class="line"># If you select &quot;yes&quot; Redis will use a smaller number of TCP packets and</div><div class="line"># less bandwidth to send data to replicas. But this can add a delay for</div><div class="line"># the data to appear on the replica side, up to 40 milliseconds with</div><div class="line"># Linux kernels using a default configuration.</div><div class="line">#</div><div class="line"># If you select &quot;no&quot; the delay for data to appear on the replica side will</div><div class="line"># be reduced but more bandwidth will be used for replication.</div><div class="line">#</div><div class="line"># By default we optimize for low latency, but in very high traffic conditions</div><div class="line"># or when the master and replicas are many hops away, turning this to &quot;yes&quot; may</div><div class="line"># be a good idea.</div><div class="line">repl-disable-tcp-nodelay no</div><div class="line"></div><div class="line"># Set the replication backlog size. The backlog is a buffer that accumulates</div><div class="line"># replica data when replicas are disconnected for some time, so that when a replica</div><div class="line"># wants to reconnect again, often a full resync is not needed, but a partial</div><div class="line"># resync is enough, just passing the portion of data the replica missed while</div><div class="line"># disconnected.</div><div class="line">#</div><div class="line"># The bigger the replication backlog, the longer the time the replica can be</div><div class="line"># disconnected and later be able to perform a partial resynchronization.</div><div class="line">#</div><div class="line"># The backlog is only allocated once there is at least a replica connected.</div><div class="line">#</div><div class="line"># repl-backlog-size 1mb</div><div class="line"></div><div class="line"># After a master has no longer connected replicas for some time, the backlog</div><div class="line"># will be freed. The following option configures the amount of seconds that</div><div class="line"># need to elapse, starting from the time the last replica disconnected, for</div><div class="line"># the backlog buffer to be freed.</div><div class="line">#</div><div class="line"># Note that replicas never free the backlog for timeout, since they may be</div><div class="line"># promoted to masters later, and should be able to correctly &quot;partially</div><div class="line"># resynchronize&quot; with the replicas: hence they should always accumulate backlog.</div><div class="line">#</div><div class="line"># A value of 0 means to never release the backlog.</div><div class="line">#</div><div class="line"># repl-backlog-ttl 3600</div><div class="line"></div><div class="line"># The replica priority is an integer number published by Redis in the INFO output.</div><div class="line"># It is used by Redis Sentinel in order to select a replica to promote into a</div><div class="line"># master if the master is no longer working correctly.</div><div class="line">#</div><div class="line"># A replica with a low priority number is considered better for promotion, so</div><div class="line"># for instance if there are three replicas with priority 10, 100, 25 Sentinel will</div><div class="line"># pick the one with priority 10, that is the lowest.</div><div class="line">#</div><div class="line"># However a special priority of 0 marks the replica as not able to perform the</div><div class="line"># role of master, so a replica with priority of 0 will never be selected by</div><div class="line"># Redis Sentinel for promotion.</div><div class="line">#</div><div class="line"># By default the priority is 100.</div><div class="line">replica-priority 100</div><div class="line"></div><div class="line"># It is possible for a master to stop accepting writes if there are less than</div><div class="line"># N replicas connected, having a lag less or equal than M seconds.</div><div class="line">#</div><div class="line"># The N replicas need to be in &quot;online&quot; state.</div><div class="line">#</div><div class="line"># The lag in seconds, that must be &lt;= the specified value, is calculated from</div><div class="line"># the last ping received from the replica, that is usually sent every second.</div><div class="line">#</div><div class="line"># This option does not GUARANTEE that N replicas will accept the write, but</div><div class="line"># will limit the window of exposure for lost writes in case not enough replicas</div><div class="line"># are available, to the specified number of seconds.</div><div class="line">#</div><div class="line"># For example to require at least 3 replicas with a lag &lt;= 10 seconds use:</div><div class="line">#</div><div class="line"># min-replicas-to-write 3</div><div class="line"># min-replicas-max-lag 10</div><div class="line">#</div><div class="line"># Setting one or the other to 0 disables the feature.</div><div class="line">#</div><div class="line"># By default min-replicas-to-write is set to 0 (feature disabled) and</div><div class="line"># min-replicas-max-lag is set to 10.</div><div class="line"></div><div class="line"># A Redis master is able to list the address and port of the attached</div><div class="line"># replicas in different ways. For example the &quot;INFO replication&quot; section</div><div class="line"># offers this information, which is used, among other tools, by</div><div class="line"># Redis Sentinel in order to discover replica instances.</div><div class="line"># Another place where this info is available is in the output of the</div><div class="line"># &quot;ROLE&quot; command of a master.</div><div class="line">#</div><div class="line"># The listed IP and address normally reported by a replica is obtained</div><div class="line"># in the following way:</div><div class="line">#</div><div class="line">#   IP: The address is auto detected by checking the peer address</div><div class="line">#   of the socket used by the replica to connect with the master.</div><div class="line">#</div><div class="line">#   Port: The port is communicated by the replica during the replication</div><div class="line">#   handshake, and is normally the port that the replica is using to</div><div class="line">#   listen for connections.</div><div class="line">#</div><div class="line"># However when port forwarding or Network Address Translation (NAT) is</div><div class="line"># used, the replica may be actually reachable via different IP and port</div><div class="line"># pairs. The following two options can be used by a replica in order to</div><div class="line"># report to its master a specific set of IP and port, so that both INFO</div><div class="line"># and ROLE will report those values.</div><div class="line">#</div><div class="line"># There is no need to use both the options if you need to override just</div><div class="line"># the port or the IP address.</div><div class="line">#</div><div class="line"># replica-announce-ip 5.5.5.5</div><div class="line"># replica-announce-port 1234</div><div class="line"></div><div class="line">################################## SECURITY ###################################</div><div class="line"></div><div class="line"># Require clients to issue AUTH &lt;PASSWORD&gt; before processing any other</div><div class="line"># commands.  This might be useful in environments in which you do not trust</div><div class="line"># others with access to the host running redis-server.</div><div class="line">#</div><div class="line"># This should stay commented out for backward compatibility and because most</div><div class="line"># people do not need auth (e.g. they run their own servers).</div><div class="line">#</div><div class="line"># Warning: since Redis is pretty fast an outside user can try up to</div><div class="line"># 150k passwords per second against a good box. This means that you should</div><div class="line"># use a very strong password otherwise it will be very easy to break.</div><div class="line">#</div><div class="line">requirepass wukewei123456</div><div class="line"></div><div class="line"># Command renaming.</div><div class="line">#</div><div class="line"># It is possible to change the name of dangerous commands in a shared</div><div class="line"># environment. For instance the CONFIG command may be renamed into something</div><div class="line"># hard to guess so that it will still be available for internal-use tools</div><div class="line"># but not available for general clients.</div><div class="line">#</div><div class="line"># Example:</div><div class="line">#</div><div class="line"># rename-command CONFIG b840fc02d524045429941cc15f59e41cb7be6c52</div><div class="line">#</div><div class="line"># It is also possible to completely kill a command by renaming it into</div><div class="line"># an empty string:</div><div class="line">#</div><div class="line"># rename-command CONFIG &quot;&quot;</div><div class="line">#</div><div class="line"># Please note that changing the name of commands that are logged into the</div><div class="line"># AOF file or transmitted to replicas may cause problems.</div><div class="line"></div><div class="line">################################### CLIENTS ####################################</div><div class="line"></div><div class="line"># Set the max number of connected clients at the same time. By default</div><div class="line"># this limit is set to 10000 clients, however if the Redis server is not</div><div class="line"># able to configure the process file limit to allow for the specified limit</div><div class="line"># the max number of allowed clients is set to the current file limit</div><div class="line"># minus 32 (as Redis reserves a few file descriptors for internal uses).</div><div class="line">#</div><div class="line"># Once the limit is reached Redis will close all the new connections sending</div><div class="line"># an error &apos;max number of clients reached&apos;.</div><div class="line">#</div><div class="line"># maxclients 10000</div><div class="line"></div><div class="line">############################## MEMORY MANAGEMENT ################################</div><div class="line"></div><div class="line"># Set a memory usage limit to the specified amount of bytes.</div><div class="line"># When the memory limit is reached Redis will try to remove keys</div><div class="line"># according to the eviction policy selected (see maxmemory-policy).</div><div class="line">#</div><div class="line"># If Redis can&apos;t remove keys according to the policy, or if the policy is</div><div class="line"># set to &apos;noeviction&apos;, Redis will start to reply with errors to commands</div><div class="line"># that would use more memory, like SET, LPUSH, and so on, and will continue</div><div class="line"># to reply to read-only commands like GET.</div><div class="line">#</div><div class="line"># This option is usually useful when using Redis as an LRU or LFU cache, or to</div><div class="line"># set a hard memory limit for an instance (using the &apos;noeviction&apos; policy).</div><div class="line">#</div><div class="line"># WARNING: If you have replicas attached to an instance with maxmemory on,</div><div class="line"># the size of the output buffers needed to feed the replicas are subtracted</div><div class="line"># from the used memory count, so that network problems / resyncs will</div><div class="line"># not trigger a loop where keys are evicted, and in turn the output</div><div class="line"># buffer of replicas is full with DELs of keys evicted triggering the deletion</div><div class="line"># of more keys, and so forth until the database is completely emptied.</div><div class="line">#</div><div class="line"># In short... if you have replicas attached it is suggested that you set a lower</div><div class="line"># limit for maxmemory so that there is some free RAM on the system for replica</div><div class="line"># output buffers (but this is not needed if the policy is &apos;noeviction&apos;).</div><div class="line">#</div><div class="line"># maxmemory &lt;bytes&gt;</div><div class="line"></div><div class="line"># MAXMEMORY POLICY: how Redis will select what to remove when maxmemory</div><div class="line"># is reached. You can select among five behaviors:</div><div class="line">#</div><div class="line"># volatile-lru -&gt; Evict using approximated LRU among the keys with an expire set.</div><div class="line"># allkeys-lru -&gt; Evict any key using approximated LRU.</div><div class="line"># volatile-lfu -&gt; Evict using approximated LFU among the keys with an expire set.</div><div class="line"># allkeys-lfu -&gt; Evict any key using approximated LFU.</div><div class="line"># volatile-random -&gt; Remove a random key among the ones with an expire set.</div><div class="line"># allkeys-random -&gt; Remove a random key, any key.</div><div class="line"># volatile-ttl -&gt; Remove the key with the nearest expire time (minor TTL)</div><div class="line"># noeviction -&gt; Don&apos;t evict anything, just return an error on write operations.</div><div class="line">#</div><div class="line"># LRU means Least Recently Used</div><div class="line"># LFU means Least Frequently Used</div><div class="line">#</div><div class="line"># Both LRU, LFU and volatile-ttl are implemented using approximated</div><div class="line"># randomized algorithms.</div><div class="line">#</div><div class="line"># Note: with any of the above policies, Redis will return an error on write</div><div class="line">#       operations, when there are no suitable keys for eviction.</div><div class="line">#</div><div class="line">#       At the date of writing these commands are: set setnx setex append</div><div class="line">#       incr decr rpush lpush rpushx lpushx linsert lset rpoplpush sadd</div><div class="line">#       sinter sinterstore sunion sunionstore sdiff sdiffstore zadd zincrby</div><div class="line">#       zunionstore zinterstore hset hsetnx hmset hincrby incrby decrby</div><div class="line">#       getset mset msetnx exec sort</div><div class="line">#</div><div class="line"># The default is:</div><div class="line">#</div><div class="line"># maxmemory-policy noeviction</div><div class="line"></div><div class="line"># LRU, LFU and minimal TTL algorithms are not precise algorithms but approximated</div><div class="line"># algorithms (in order to save memory), so you can tune it for speed or</div><div class="line"># accuracy. For default Redis will check five keys and pick the one that was</div><div class="line"># used less recently, you can change the sample size using the following</div><div class="line"># configuration directive.</div><div class="line">#</div><div class="line"># The default of 5 produces good enough results. 10 Approximates very closely</div><div class="line"># true LRU but costs more CPU. 3 is faster but not very accurate.</div><div class="line">#</div><div class="line"># maxmemory-samples 5</div><div class="line"></div><div class="line"># Starting from Redis 5, by default a replica will ignore its maxmemory setting</div><div class="line"># (unless it is promoted to master after a failover or manually). It means</div><div class="line"># that the eviction of keys will be just handled by the master, sending the</div><div class="line"># DEL commands to the replica as keys evict in the master side.</div><div class="line">#</div><div class="line"># This behavior ensures that masters and replicas stay consistent, and is usually</div><div class="line"># what you want, however if your replica is writable, or you want the replica to have</div><div class="line"># a different memory setting, and you are sure all the writes performed to the</div><div class="line"># replica are idempotent, then you may change this default (but be sure to understand</div><div class="line"># what you are doing).</div><div class="line">#</div><div class="line"># Note that since the replica by default does not evict, it may end using more</div><div class="line"># memory than the one set via maxmemory (there are certain buffers that may</div><div class="line"># be larger on the replica, or data structures may sometimes take more memory and so</div><div class="line"># forth). So make sure you monitor your replicas and make sure they have enough</div><div class="line"># memory to never hit a real out-of-memory condition before the master hits</div><div class="line"># the configured maxmemory setting.</div><div class="line">#</div><div class="line"># replica-ignore-maxmemory yes</div><div class="line"></div><div class="line">############################# LAZY FREEING ####################################</div><div class="line"></div><div class="line"># Redis has two primitives to delete keys. One is called DEL and is a blocking</div><div class="line"># deletion of the object. It means that the server stops processing new commands</div><div class="line"># in order to reclaim all the memory associated with an object in a synchronous</div><div class="line"># way. If the key deleted is associated with a small object, the time needed</div><div class="line"># in order to execute the DEL command is very small and comparable to most other</div><div class="line"># O(1) or O(log_N) commands in Redis. However if the key is associated with an</div><div class="line"># aggregated value containing millions of elements, the server can block for</div><div class="line"># a long time (even seconds) in order to complete the operation.</div><div class="line">#</div><div class="line"># For the above reasons Redis also offers non blocking deletion primitives</div><div class="line"># such as UNLINK (non blocking DEL) and the ASYNC option of FLUSHALL and</div><div class="line"># FLUSHDB commands, in order to reclaim memory in background. Those commands</div><div class="line"># are executed in constant time. Another thread will incrementally free the</div><div class="line"># object in the background as fast as possible.</div><div class="line">#</div><div class="line"># DEL, UNLINK and ASYNC option of FLUSHALL and FLUSHDB are user-controlled.</div><div class="line"># It&apos;s up to the design of the application to understand when it is a good</div><div class="line"># idea to use one or the other. However the Redis server sometimes has to</div><div class="line"># delete keys or flush the whole database as a side effect of other operations.</div><div class="line"># Specifically Redis deletes objects independently of a user call in the</div><div class="line"># following scenarios:</div><div class="line">#</div><div class="line"># 1) On eviction, because of the maxmemory and maxmemory policy configurations,</div><div class="line">#    in order to make room for new data, without going over the specified</div><div class="line">#    memory limit.</div><div class="line"># 2) Because of expire: when a key with an associated time to live (see the</div><div class="line">#    EXPIRE command) must be deleted from memory.</div><div class="line"># 3) Because of a side effect of a command that stores data on a key that may</div><div class="line">#    already exist. For example the RENAME command may delete the old key</div><div class="line">#    content when it is replaced with another one. Similarly SUNIONSTORE</div><div class="line">#    or SORT with STORE option may delete existing keys. The SET command</div><div class="line">#    itself removes any old content of the specified key in order to replace</div><div class="line">#    it with the specified string.</div><div class="line"># 4) During replication, when a replica performs a full resynchronization with</div><div class="line">#    its master, the content of the whole database is removed in order to</div><div class="line">#    load the RDB file just transferred.</div><div class="line">#</div><div class="line"># In all the above cases the default is to delete objects in a blocking way,</div><div class="line"># like if DEL was called. However you can configure each case specifically</div><div class="line"># in order to instead release memory in a non-blocking way like if UNLINK</div><div class="line"># was called, using the following configuration directives:</div><div class="line"></div><div class="line">lazyfree-lazy-eviction no</div><div class="line">lazyfree-lazy-expire no</div><div class="line">lazyfree-lazy-server-del no</div><div class="line">replica-lazy-flush no</div><div class="line"></div><div class="line">############################## APPEND ONLY MODE ###############################</div><div class="line"></div><div class="line"># By default Redis asynchronously dumps the dataset on disk. This mode is</div><div class="line"># good enough in many applications, but an issue with the Redis process or</div><div class="line"># a power outage may result into a few minutes of writes lost (depending on</div><div class="line"># the configured save points).</div><div class="line">#</div><div class="line"># The Append Only File is an alternative persistence mode that provides</div><div class="line"># much better durability. For instance using the default data fsync policy</div><div class="line"># (see later in the config file) Redis can lose just one second of writes in a</div><div class="line"># dramatic event like a server power outage, or a single write if something</div><div class="line"># wrong with the Redis process itself happens, but the operating system is</div><div class="line"># still running correctly.</div><div class="line">#</div><div class="line"># AOF and RDB persistence can be enabled at the same time without problems.</div><div class="line"># If the AOF is enabled on startup Redis will load the AOF, that is the file</div><div class="line"># with the better durability guarantees.</div><div class="line">#</div><div class="line"># Please check http://redis.io/topics/persistence for more information.</div><div class="line"></div><div class="line">appendonly no</div><div class="line"></div><div class="line"># The name of the append only file (default: &quot;appendonly.aof&quot;)</div><div class="line"></div><div class="line">appendfilename &quot;appendonly.aof&quot;</div><div class="line"></div><div class="line"># The fsync() call tells the Operating System to actually write data on disk</div><div class="line"># instead of waiting for more data in the output buffer. Some OS will really flush</div><div class="line"># data on disk, some other OS will just try to do it ASAP.</div><div class="line">#</div><div class="line"># Redis supports three different modes:</div><div class="line">#</div><div class="line"># no: don&apos;t fsync, just let the OS flush the data when it wants. Faster.</div><div class="line"># always: fsync after every write to the append only log. Slow, Safest.</div><div class="line"># everysec: fsync only one time every second. Compromise.</div><div class="line">#</div><div class="line"># The default is &quot;everysec&quot;, as that&apos;s usually the right compromise between</div><div class="line"># speed and data safety. It&apos;s up to you to understand if you can relax this to</div><div class="line"># &quot;no&quot; that will let the operating system flush the output buffer when</div><div class="line"># it wants, for better performances (but if you can live with the idea of</div><div class="line"># some data loss consider the default persistence mode that&apos;s snapshotting),</div><div class="line"># or on the contrary, use &quot;always&quot; that&apos;s very slow but a bit safer than</div><div class="line"># everysec.</div><div class="line">#</div><div class="line"># More details please check the following article:</div><div class="line"># http://antirez.com/post/redis-persistence-demystified.html</div><div class="line">#</div><div class="line"># If unsure, use &quot;everysec&quot;.</div><div class="line"></div><div class="line"># appendfsync always</div><div class="line">appendfsync everysec</div><div class="line"># appendfsync no</div><div class="line"></div><div class="line"># When the AOF fsync policy is set to always or everysec, and a background</div><div class="line"># saving process (a background save or AOF log background rewriting) is</div><div class="line"># performing a lot of I/O against the disk, in some Linux configurations</div><div class="line"># Redis may block too long on the fsync() call. Note that there is no fix for</div><div class="line"># this currently, as even performing fsync in a different thread will block</div><div class="line"># our synchronous write(2) call.</div><div class="line">#</div><div class="line"># In order to mitigate this problem it&apos;s possible to use the following option</div><div class="line"># that will prevent fsync() from being called in the main process while a</div><div class="line"># BGSAVE or BGREWRITEAOF is in progress.</div><div class="line">#</div><div class="line"># This means that while another child is saving, the durability of Redis is</div><div class="line"># the same as &quot;appendfsync none&quot;. In practical terms, this means that it is</div><div class="line"># possible to lose up to 30 seconds of log in the worst scenario (with the</div><div class="line"># default Linux settings).</div><div class="line">#</div><div class="line"># If you have latency problems turn this to &quot;yes&quot;. Otherwise leave it as</div><div class="line"># &quot;no&quot; that is the safest pick from the point of view of durability.</div><div class="line"></div><div class="line">no-appendfsync-on-rewrite no</div><div class="line"></div><div class="line"># Automatic rewrite of the append only file.</div><div class="line"># Redis is able to automatically rewrite the log file implicitly calling</div><div class="line"># BGREWRITEAOF when the AOF log size grows by the specified percentage.</div><div class="line">#</div><div class="line"># This is how it works: Redis remembers the size of the AOF file after the</div><div class="line"># latest rewrite (if no rewrite has happened since the restart, the size of</div><div class="line"># the AOF at startup is used).</div><div class="line">#</div><div class="line"># This base size is compared to the current size. If the current size is</div><div class="line"># bigger than the specified percentage, the rewrite is triggered. Also</div><div class="line"># you need to specify a minimal size for the AOF file to be rewritten, this</div><div class="line"># is useful to avoid rewriting the AOF file even if the percentage increase</div><div class="line"># is reached but it is still pretty small.</div><div class="line">#</div><div class="line"># Specify a percentage of zero in order to disable the automatic AOF</div><div class="line"># rewrite feature.</div><div class="line"></div><div class="line">auto-aof-rewrite-percentage 100</div><div class="line">auto-aof-rewrite-min-size 64mb</div><div class="line"></div><div class="line"># An AOF file may be found to be truncated at the end during the Redis</div><div class="line"># startup process, when the AOF data gets loaded back into memory.</div><div class="line"># This may happen when the system where Redis is running</div><div class="line"># crashes, especially when an ext4 filesystem is mounted without the</div><div class="line"># data=ordered option (however this can&apos;t happen when Redis itself</div><div class="line"># crashes or aborts but the operating system still works correctly).</div><div class="line">#</div><div class="line"># Redis can either exit with an error when this happens, or load as much</div><div class="line"># data as possible (the default now) and start if the AOF file is found</div><div class="line"># to be truncated at the end. The following option controls this behavior.</div><div class="line">#</div><div class="line"># If aof-load-truncated is set to yes, a truncated AOF file is loaded and</div><div class="line"># the Redis server starts emitting a log to inform the user of the event.</div><div class="line"># Otherwise if the option is set to no, the server aborts with an error</div><div class="line"># and refuses to start. When the option is set to no, the user requires</div><div class="line"># to fix the AOF file using the &quot;redis-check-aof&quot; utility before to restart</div><div class="line"># the server.</div><div class="line">#</div><div class="line"># Note that if the AOF file will be found to be corrupted in the middle</div><div class="line"># the server will still exit with an error. This option only applies when</div><div class="line"># Redis will try to read more data from the AOF file but not enough bytes</div><div class="line"># will be found.</div><div class="line">aof-load-truncated yes</div><div class="line"></div><div class="line"># When rewriting the AOF file, Redis is able to use an RDB preamble in the</div><div class="line"># AOF file for faster rewrites and recoveries. When this option is turned</div><div class="line"># on the rewritten AOF file is composed of two different stanzas:</div><div class="line">#</div><div class="line">#   [RDB file][AOF tail]</div><div class="line">#</div><div class="line"># When loading Redis recognizes that the AOF file starts with the &quot;REDIS&quot;</div><div class="line"># string and loads the prefixed RDB file, and continues loading the AOF</div><div class="line"># tail.</div><div class="line">aof-use-rdb-preamble yes</div><div class="line"></div><div class="line">################################ LUA SCRIPTING  ###############################</div><div class="line"></div><div class="line"># Max execution time of a Lua script in milliseconds.</div><div class="line">#</div><div class="line"># If the maximum execution time is reached Redis will log that a script is</div><div class="line"># still in execution after the maximum allowed time and will start to</div><div class="line"># reply to queries with an error.</div><div class="line">#</div><div class="line"># When a long running script exceeds the maximum execution time only the</div><div class="line"># SCRIPT KILL and SHUTDOWN NOSAVE commands are available. The first can be</div><div class="line"># used to stop a script that did not yet called write commands. The second</div><div class="line"># is the only way to shut down the server in the case a write command was</div><div class="line"># already issued by the script but the user doesn&apos;t want to wait for the natural</div><div class="line"># termination of the script.</div><div class="line">#</div><div class="line"># Set it to 0 or a negative value for unlimited execution without warnings.</div><div class="line">lua-time-limit 5000</div><div class="line"></div><div class="line">################################ REDIS CLUSTER  ###############################</div><div class="line">#</div><div class="line"># ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</div><div class="line"># WARNING EXPERIMENTAL: Redis Cluster is considered to be stable code, however</div><div class="line"># in order to mark it as &quot;mature&quot; we need to wait for a non trivial percentage</div><div class="line"># of users to deploy it in production.</div><div class="line"># ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</div><div class="line">#</div><div class="line"># Normal Redis instances can&apos;t be part of a Redis Cluster; only nodes that are</div><div class="line"># started as cluster nodes can. In order to start a Redis instance as a</div><div class="line"># cluster node enable the cluster support uncommenting the following:</div><div class="line">#</div><div class="line"># cluster-enabled yes</div><div class="line"></div><div class="line"># Every cluster node has a cluster configuration file. This file is not</div><div class="line"># intended to be edited by hand. It is created and updated by Redis nodes.</div><div class="line"># Every Redis Cluster node requires a different cluster configuration file.</div><div class="line"># Make sure that instances running in the same system do not have</div><div class="line"># overlapping cluster configuration file names.</div><div class="line">#</div><div class="line"># cluster-config-file nodes-6379.conf</div><div class="line"></div><div class="line"># Cluster node timeout is the amount of milliseconds a node must be unreachable</div><div class="line"># for it to be considered in failure state.</div><div class="line"># Most other internal time limits are multiple of the node timeout.</div><div class="line">#</div><div class="line"># cluster-node-timeout 15000</div><div class="line"></div><div class="line"># A replica of a failing master will avoid to start a failover if its data</div><div class="line"># looks too old.</div><div class="line">#</div><div class="line"># There is no simple way for a replica to actually have an exact measure of</div><div class="line"># its &quot;data age&quot;, so the following two checks are performed:</div><div class="line">#</div><div class="line"># 1) If there are multiple replicas able to failover, they exchange messages</div><div class="line">#    in order to try to give an advantage to the replica with the best</div><div class="line">#    replication offset (more data from the master processed).</div><div class="line">#    Replicas will try to get their rank by offset, and apply to the start</div><div class="line">#    of the failover a delay proportional to their rank.</div><div class="line">#</div><div class="line"># 2) Every single replica computes the time of the last interaction with</div><div class="line">#    its master. This can be the last ping or command received (if the master</div><div class="line">#    is still in the &quot;connected&quot; state), or the time that elapsed since the</div><div class="line">#    disconnection with the master (if the replication link is currently down).</div><div class="line">#    If the last interaction is too old, the replica will not try to failover</div><div class="line">#    at all.</div><div class="line">#</div><div class="line"># The point &quot;2&quot; can be tuned by user. Specifically a replica will not perform</div><div class="line"># the failover if, since the last interaction with the master, the time</div><div class="line"># elapsed is greater than:</div><div class="line">#</div><div class="line">#   (node-timeout * replica-validity-factor) + repl-ping-replica-period</div><div class="line">#</div><div class="line"># So for example if node-timeout is 30 seconds, and the replica-validity-factor</div><div class="line"># is 10, and assuming a default repl-ping-replica-period of 10 seconds, the</div><div class="line"># replica will not try to failover if it was not able to talk with the master</div><div class="line"># for longer than 310 seconds.</div><div class="line">#</div><div class="line"># A large replica-validity-factor may allow replicas with too old data to failover</div><div class="line"># a master, while a too small value may prevent the cluster from being able to</div><div class="line"># elect a replica at all.</div><div class="line">#</div><div class="line"># For maximum availability, it is possible to set the replica-validity-factor</div><div class="line"># to a value of 0, which means, that replicas will always try to failover the</div><div class="line"># master regardless of the last time they interacted with the master.</div><div class="line"># (However they&apos;ll always try to apply a delay proportional to their</div><div class="line"># offset rank).</div><div class="line">#</div><div class="line"># Zero is the only value able to guarantee that when all the partitions heal</div><div class="line"># the cluster will always be able to continue.</div><div class="line">#</div><div class="line"># cluster-replica-validity-factor 10</div><div class="line"></div><div class="line"># Cluster replicas are able to migrate to orphaned masters, that are masters</div><div class="line"># that are left without working replicas. This improves the cluster ability</div><div class="line"># to resist to failures as otherwise an orphaned master can&apos;t be failed over</div><div class="line"># in case of failure if it has no working replicas.</div><div class="line">#</div><div class="line"># Replicas migrate to orphaned masters only if there are still at least a</div><div class="line"># given number of other working replicas for their old master. This number</div><div class="line"># is the &quot;migration barrier&quot;. A migration barrier of 1 means that a replica</div><div class="line"># will migrate only if there is at least 1 other working replica for its master</div><div class="line"># and so forth. It usually reflects the number of replicas you want for every</div><div class="line"># master in your cluster.</div><div class="line">#</div><div class="line"># Default is 1 (replicas migrate only if their masters remain with at least</div><div class="line"># one replica). To disable migration just set it to a very large value.</div><div class="line"># A value of 0 can be set but is useful only for debugging and dangerous</div><div class="line"># in production.</div><div class="line">#</div><div class="line"># cluster-migration-barrier 1</div><div class="line"></div><div class="line"># By default Redis Cluster nodes stop accepting queries if they detect there</div><div class="line"># is at least an hash slot uncovered (no available node is serving it).</div><div class="line"># This way if the cluster is partially down (for example a range of hash slots</div><div class="line"># are no longer covered) all the cluster becomes, eventually, unavailable.</div><div class="line"># It automatically returns available as soon as all the slots are covered again.</div><div class="line">#</div><div class="line"># However sometimes you want the subset of the cluster which is working,</div><div class="line"># to continue to accept queries for the part of the key space that is still</div><div class="line"># covered. In order to do so, just set the cluster-require-full-coverage</div><div class="line"># option to no.</div><div class="line">#</div><div class="line"># cluster-require-full-coverage yes</div><div class="line"></div><div class="line"># This option, when set to yes, prevents replicas from trying to failover its</div><div class="line"># master during master failures. However the master can still perform a</div><div class="line"># manual failover, if forced to do so.</div><div class="line">#</div><div class="line"># This is useful in different scenarios, especially in the case of multiple</div><div class="line"># data center operations, where we want one side to never be promoted if not</div><div class="line"># in the case of a total DC failure.</div><div class="line">#</div><div class="line"># cluster-replica-no-failover no</div><div class="line"></div><div class="line"># In order to setup your cluster make sure to read the documentation</div><div class="line"># available at http://redis.io web site.</div><div class="line"></div><div class="line">########################## CLUSTER DOCKER/NAT support  ########################</div><div class="line"></div><div class="line"># In certain deployments, Redis Cluster nodes address discovery fails, because</div><div class="line"># addresses are NAT-ted or because ports are forwarded (the typical case is</div><div class="line"># Docker and other containers).</div><div class="line">#</div><div class="line"># In order to make Redis Cluster working in such environments, a static</div><div class="line"># configuration where each node knows its public address is needed. The</div><div class="line"># following two options are used for this scope, and are:</div><div class="line">#</div><div class="line"># * cluster-announce-ip</div><div class="line"># * cluster-announce-port</div><div class="line"># * cluster-announce-bus-port</div><div class="line">#</div><div class="line"># Each instruct the node about its address, client port, and cluster message</div><div class="line"># bus port. The information is then published in the header of the bus packets</div><div class="line"># so that other nodes will be able to correctly map the address of the node</div><div class="line"># publishing the information.</div><div class="line">#</div><div class="line"># If the above options are not used, the normal Redis Cluster auto-detection</div><div class="line"># will be used instead.</div><div class="line">#</div><div class="line"># Note that when remapped, the bus port may not be at the fixed offset of</div><div class="line"># clients port + 10000, so you can specify any port and bus-port depending</div><div class="line"># on how they get remapped. If the bus-port is not set, a fixed offset of</div><div class="line"># 10000 will be used as usually.</div><div class="line">#</div><div class="line"># Example:</div><div class="line">#</div><div class="line"># cluster-announce-ip 10.1.1.5</div><div class="line"># cluster-announce-port 6379</div><div class="line"># cluster-announce-bus-port 6380</div><div class="line"></div><div class="line">################################## SLOW LOG ###################################</div><div class="line"></div><div class="line"># The Redis Slow Log is a system to log queries that exceeded a specified</div><div class="line"># execution time. The execution time does not include the I/O operations</div><div class="line"># like talking with the client, sending the reply and so forth,</div><div class="line"># but just the time needed to actually execute the command (this is the only</div><div class="line"># stage of command execution where the thread is blocked and can not serve</div><div class="line"># other requests in the meantime).</div><div class="line">#</div><div class="line"># You can configure the slow log with two parameters: one tells Redis</div><div class="line"># what is the execution time, in microseconds, to exceed in order for the</div><div class="line"># command to get logged, and the other parameter is the length of the</div><div class="line"># slow log. When a new command is logged the oldest one is removed from the</div><div class="line"># queue of logged commands.</div><div class="line"></div><div class="line"># The following time is expressed in microseconds, so 1000000 is equivalent</div><div class="line"># to one second. Note that a negative number disables the slow log, while</div><div class="line"># a value of zero forces the logging of every command.</div><div class="line">slowlog-log-slower-than 10000</div><div class="line"></div><div class="line"># There is no limit to this length. Just be aware that it will consume memory.</div><div class="line"># You can reclaim memory used by the slow log with SLOWLOG RESET.</div><div class="line">slowlog-max-len 128</div><div class="line"></div><div class="line">################################ LATENCY MONITOR ##############################</div><div class="line"></div><div class="line"># The Redis latency monitoring subsystem samples different operations</div><div class="line"># at runtime in order to collect data related to possible sources of</div><div class="line"># latency of a Redis instance.</div><div class="line">#</div><div class="line"># Via the LATENCY command this information is available to the user that can</div><div class="line"># print graphs and obtain reports.</div><div class="line">#</div><div class="line"># The system only logs operations that were performed in a time equal or</div><div class="line"># greater than the amount of milliseconds specified via the</div><div class="line"># latency-monitor-threshold configuration directive. When its value is set</div><div class="line"># to zero, the latency monitor is turned off.</div><div class="line">#</div><div class="line"># By default latency monitoring is disabled since it is mostly not needed</div><div class="line"># if you don&apos;t have latency issues, and collecting data has a performance</div><div class="line"># impact, that while very small, can be measured under big load. Latency</div><div class="line"># monitoring can easily be enabled at runtime using the command</div><div class="line"># &quot;CONFIG SET latency-monitor-threshold &lt;milliseconds&gt;&quot; if needed.</div><div class="line">latency-monitor-threshold 0</div><div class="line"></div><div class="line">############################# EVENT NOTIFICATION ##############################</div><div class="line"></div><div class="line"># Redis can notify Pub/Sub clients about events happening in the key space.</div><div class="line"># This feature is documented at http://redis.io/topics/notifications</div><div class="line">#</div><div class="line"># For instance if keyspace events notification is enabled, and a client</div><div class="line"># performs a DEL operation on key &quot;foo&quot; stored in the Database 0, two</div><div class="line"># messages will be published via Pub/Sub:</div><div class="line">#</div><div class="line"># PUBLISH __keyspace@0__:foo del</div><div class="line"># PUBLISH __keyevent@0__:del foo</div><div class="line">#</div><div class="line"># It is possible to select the events that Redis will notify among a set</div><div class="line"># of classes. Every class is identified by a single character:</div><div class="line">#</div><div class="line">#  K     Keyspace events, published with __keyspace@&lt;db&gt;__ prefix.</div><div class="line">#  E     Keyevent events, published with __keyevent@&lt;db&gt;__ prefix.</div><div class="line">#  g     Generic commands (non-type specific) like DEL, EXPIRE, RENAME, ...</div><div class="line">#  $     String commands</div><div class="line">#  l     List commands</div><div class="line">#  s     Set commands</div><div class="line">#  h     Hash commands</div><div class="line">#  z     Sorted set commands</div><div class="line">#  x     Expired events (events generated every time a key expires)</div><div class="line">#  e     Evicted events (events generated when a key is evicted for maxmemory)</div><div class="line">#  A     Alias for g$lshzxe, so that the &quot;AKE&quot; string means all the events.</div><div class="line">#</div><div class="line">#  The &quot;notify-keyspace-events&quot; takes as argument a string that is composed</div><div class="line">#  of zero or multiple characters. The empty string means that notifications</div><div class="line">#  are disabled.</div><div class="line">#</div><div class="line">#  Example: to enable list and generic events, from the point of view of the</div><div class="line">#           event name, use:</div><div class="line">#</div><div class="line">#  notify-keyspace-events Elg</div><div class="line">#</div><div class="line">#  Example 2: to get the stream of the expired keys subscribing to channel</div><div class="line">#             name __keyevent@0__:expired use:</div><div class="line">#</div><div class="line">#  notify-keyspace-events Ex</div><div class="line">#</div><div class="line">#  By default all notifications are disabled because most users don&apos;t need</div><div class="line">#  this feature and the feature has some overhead. Note that if you don&apos;t</div><div class="line">#  specify at least one of K or E, no events will be delivered.</div><div class="line">notify-keyspace-events &quot;&quot;</div><div class="line"></div><div class="line">############################### ADVANCED CONFIG ###############################</div><div class="line"></div><div class="line"># Hashes are encoded using a memory efficient data structure when they have a</div><div class="line"># small number of entries, and the biggest entry does not exceed a given</div><div class="line"># threshold. These thresholds can be configured using the following directives.</div><div class="line">hash-max-ziplist-entries 512</div><div class="line">hash-max-ziplist-value 64</div><div class="line"></div><div class="line"># Lists are also encoded in a special way to save a lot of space.</div><div class="line"># The number of entries allowed per internal list node can be specified</div><div class="line"># as a fixed maximum size or a maximum number of elements.</div><div class="line"># For a fixed maximum size, use -5 through -1, meaning:</div><div class="line"># -5: max size: 64 Kb  &lt;-- not recommended for normal workloads</div><div class="line"># -4: max size: 32 Kb  &lt;-- not recommended</div><div class="line"># -3: max size: 16 Kb  &lt;-- probably not recommended</div><div class="line"># -2: max size: 8 Kb   &lt;-- good</div><div class="line"># -1: max size: 4 Kb   &lt;-- good</div><div class="line"># Positive numbers mean store up to _exactly_ that number of elements</div><div class="line"># per list node.</div><div class="line"># The highest performing option is usually -2 (8 Kb size) or -1 (4 Kb size),</div><div class="line"># but if your use case is unique, adjust the settings as necessary.</div><div class="line">list-max-ziplist-size -2</div><div class="line"></div><div class="line"># Lists may also be compressed.</div><div class="line"># Compress depth is the number of quicklist ziplist nodes from *each* side of</div><div class="line"># the list to *exclude* from compression.  The head and tail of the list</div><div class="line"># are always uncompressed for fast push/pop operations.  Settings are:</div><div class="line"># 0: disable all list compression</div><div class="line"># 1: depth 1 means &quot;don&apos;t start compressing until after 1 node into the list,</div><div class="line">#    going from either the head or tail&quot;</div><div class="line">#    So: [head]-&gt;node-&gt;node-&gt;...-&gt;node-&gt;[tail]</div><div class="line">#    [head], [tail] will always be uncompressed; inner nodes will compress.</div><div class="line"># 2: [head]-&gt;[next]-&gt;node-&gt;node-&gt;...-&gt;node-&gt;[prev]-&gt;[tail]</div><div class="line">#    2 here means: don&apos;t compress head or head-&gt;next or tail-&gt;prev or tail,</div><div class="line">#    but compress all nodes between them.</div><div class="line"># 3: [head]-&gt;[next]-&gt;[next]-&gt;node-&gt;node-&gt;...-&gt;node-&gt;[prev]-&gt;[prev]-&gt;[tail]</div><div class="line"># etc.</div><div class="line">list-compress-depth 0</div><div class="line"></div><div class="line"># Sets have a special encoding in just one case: when a set is composed</div><div class="line"># of just strings that happen to be integers in radix 10 in the range</div><div class="line"># of 64 bit signed integers.</div><div class="line"># The following configuration setting sets the limit in the size of the</div><div class="line"># set in order to use this special memory saving encoding.</div><div class="line">set-max-intset-entries 512</div><div class="line"></div><div class="line"># Similarly to hashes and lists, sorted sets are also specially encoded in</div><div class="line"># order to save a lot of space. This encoding is only used when the length and</div><div class="line"># elements of a sorted set are below the following limits:</div><div class="line">zset-max-ziplist-entries 128</div><div class="line">zset-max-ziplist-value 64</div><div class="line"></div><div class="line"># HyperLogLog sparse representation bytes limit. The limit includes the</div><div class="line"># 16 bytes header. When an HyperLogLog using the sparse representation crosses</div><div class="line"># this limit, it is converted into the dense representation.</div><div class="line">#</div><div class="line"># A value greater than 16000 is totally useless, since at that point the</div><div class="line"># dense representation is more memory efficient.</div><div class="line">#</div><div class="line"># The suggested value is ~ 3000 in order to have the benefits of</div><div class="line"># the space efficient encoding without slowing down too much PFADD,</div><div class="line"># which is O(N) with the sparse encoding. The value can be raised to</div><div class="line"># ~ 10000 when CPU is not a concern, but space is, and the data set is</div><div class="line"># composed of many HyperLogLogs with cardinality in the 0 - 15000 range.</div><div class="line">hll-sparse-max-bytes 3000</div><div class="line"></div><div class="line"># Streams macro node max size / items. The stream data structure is a radix</div><div class="line"># tree of big nodes that encode multiple items inside. Using this configuration</div><div class="line"># it is possible to configure how big a single node can be in bytes, and the</div><div class="line"># maximum number of items it may contain before switching to a new node when</div><div class="line"># appending new stream entries. If any of the following settings are set to</div><div class="line"># zero, the limit is ignored, so for instance it is possible to set just a</div><div class="line"># max entires limit by setting max-bytes to 0 and max-entries to the desired</div><div class="line"># value.</div><div class="line">stream-node-max-bytes 4096</div><div class="line">stream-node-max-entries 100</div><div class="line"></div><div class="line"># Active rehashing uses 1 millisecond every 100 milliseconds of CPU time in</div><div class="line"># order to help rehashing the main Redis hash table (the one mapping top-level</div><div class="line"># keys to values). The hash table implementation Redis uses (see dict.c)</div><div class="line"># performs a lazy rehashing: the more operation you run into a hash table</div><div class="line"># that is rehashing, the more rehashing &quot;steps&quot; are performed, so if the</div><div class="line"># server is idle the rehashing is never complete and some more memory is used</div><div class="line"># by the hash table.</div><div class="line">#</div><div class="line"># The default is to use this millisecond 10 times every second in order to</div><div class="line"># actively rehash the main dictionaries, freeing memory when possible.</div><div class="line">#</div><div class="line"># If unsure:</div><div class="line"># use &quot;activerehashing no&quot; if you have hard latency requirements and it is</div><div class="line"># not a good thing in your environment that Redis can reply from time to time</div><div class="line"># to queries with 2 milliseconds delay.</div><div class="line">#</div><div class="line"># use &quot;activerehashing yes&quot; if you don&apos;t have such hard requirements but</div><div class="line"># want to free memory asap when possible.</div><div class="line">activerehashing yes</div><div class="line"></div><div class="line"># The client output buffer limits can be used to force disconnection of clients</div><div class="line"># that are not reading data from the server fast enough for some reason (a</div><div class="line"># common reason is that a Pub/Sub client can&apos;t consume messages as fast as the</div><div class="line"># publisher can produce them).</div><div class="line">#</div><div class="line"># The limit can be set differently for the three different classes of clients:</div><div class="line">#</div><div class="line"># normal -&gt; normal clients including MONITOR clients</div><div class="line"># replica  -&gt; replica clients</div><div class="line"># pubsub -&gt; clients subscribed to at least one pubsub channel or pattern</div><div class="line">#</div><div class="line"># The syntax of every client-output-buffer-limit directive is the following:</div><div class="line">#</div><div class="line"># client-output-buffer-limit &lt;class&gt; &lt;hard limit&gt; &lt;soft limit&gt; &lt;soft seconds&gt;</div><div class="line">#</div><div class="line"># A client is immediately disconnected once the hard limit is reached, or if</div><div class="line"># the soft limit is reached and remains reached for the specified number of</div><div class="line"># seconds (continuously).</div><div class="line"># So for instance if the hard limit is 32 megabytes and the soft limit is</div><div class="line"># 16 megabytes / 10 seconds, the client will get disconnected immediately</div><div class="line"># if the size of the output buffers reach 32 megabytes, but will also get</div><div class="line"># disconnected if the client reaches 16 megabytes and continuously overcomes</div><div class="line"># the limit for 10 seconds.</div><div class="line">#</div><div class="line"># By default normal clients are not limited because they don&apos;t receive data</div><div class="line"># without asking (in a push way), but just after a request, so only</div><div class="line"># asynchronous clients may create a scenario where data is requested faster</div><div class="line"># than it can read.</div><div class="line">#</div><div class="line"># Instead there is a default limit for pubsub and replica clients, since</div><div class="line"># subscribers and replicas receive data in a push fashion.</div><div class="line">#</div><div class="line"># Both the hard or the soft limit can be disabled by setting them to zero.</div><div class="line">client-output-buffer-limit normal 0 0 0</div><div class="line">client-output-buffer-limit replica 256mb 64mb 60</div><div class="line">client-output-buffer-limit pubsub 32mb 8mb 60</div><div class="line"></div><div class="line"># Client query buffers accumulate new commands. They are limited to a fixed</div><div class="line"># amount by default in order to avoid that a protocol desynchronization (for</div><div class="line"># instance due to a bug in the client) will lead to unbound memory usage in</div><div class="line"># the query buffer. However you can configure it here if you have very special</div><div class="line"># needs, such us huge multi/exec requests or alike.</div><div class="line">#</div><div class="line"># client-query-buffer-limit 1gb</div><div class="line"></div><div class="line"># In the Redis protocol, bulk requests, that are, elements representing single</div><div class="line"># strings, are normally limited ot 512 mb. However you can change this limit</div><div class="line"># here.</div><div class="line">#</div><div class="line"># proto-max-bulk-len 512mb</div><div class="line"></div><div class="line"># Redis calls an internal function to perform many background tasks, like</div><div class="line"># closing connections of clients in timeout, purging expired keys that are</div><div class="line"># never requested, and so forth.</div><div class="line">#</div><div class="line"># Not all tasks are performed with the same frequency, but Redis checks for</div><div class="line"># tasks to perform according to the specified &quot;hz&quot; value.</div><div class="line">#</div><div class="line"># By default &quot;hz&quot; is set to 10. Raising the value will use more CPU when</div><div class="line"># Redis is idle, but at the same time will make Redis more responsive when</div><div class="line"># there are many keys expiring at the same time, and timeouts may be</div><div class="line"># handled with more precision.</div><div class="line">#</div><div class="line"># The range is between 1 and 500, however a value over 100 is usually not</div><div class="line"># a good idea. Most users should use the default of 10 and raise this up to</div><div class="line"># 100 only in environments where very low latency is required.</div><div class="line">hz 10</div><div class="line"></div><div class="line"># Normally it is useful to have an HZ value which is proportional to the</div><div class="line"># number of clients connected. This is useful in order, for instance, to</div><div class="line"># avoid too many clients are processed for each background task invocation</div><div class="line"># in order to avoid latency spikes.</div><div class="line">#</div><div class="line"># Since the default HZ value by default is conservatively set to 10, Redis</div><div class="line"># offers, and enables by default, the ability to use an adaptive HZ value</div><div class="line"># which will temporary raise when there are many connected clients.</div><div class="line">#</div><div class="line"># When dynamic HZ is enabled, the actual configured HZ will be used as</div><div class="line"># as a baseline, but multiples of the configured HZ value will be actually</div><div class="line"># used as needed once more clients are connected. In this way an idle</div><div class="line"># instance will use very little CPU time while a busy instance will be</div><div class="line"># more responsive.</div><div class="line">dynamic-hz yes</div><div class="line"></div><div class="line"># When a child rewrites the AOF file, if the following option is enabled</div><div class="line"># the file will be fsync-ed every 32 MB of data generated. This is useful</div><div class="line"># in order to commit the file to the disk more incrementally and avoid</div><div class="line"># big latency spikes.</div><div class="line">aof-rewrite-incremental-fsync yes</div><div class="line"></div><div class="line"># When redis saves RDB file, if the following option is enabled</div><div class="line"># the file will be fsync-ed every 32 MB of data generated. This is useful</div><div class="line"># in order to commit the file to the disk more incrementally and avoid</div><div class="line"># big latency spikes.</div><div class="line">rdb-save-incremental-fsync yes</div><div class="line"></div><div class="line"># Redis LFU eviction (see maxmemory setting) can be tuned. However it is a good</div><div class="line"># idea to start with the default settings and only change them after investigating</div><div class="line"># how to improve the performances and how the keys LFU change over time, which</div><div class="line"># is possible to inspect via the OBJECT FREQ command.</div><div class="line">#</div><div class="line"># There are two tunable parameters in the Redis LFU implementation: the</div><div class="line"># counter logarithm factor and the counter decay time. It is important to</div><div class="line"># understand what the two parameters mean before changing them.</div><div class="line">#</div><div class="line"># The LFU counter is just 8 bits per key, it&apos;s maximum value is 255, so Redis</div><div class="line"># uses a probabilistic increment with logarithmic behavior. Given the value</div><div class="line"># of the old counter, when a key is accessed, the counter is incremented in</div><div class="line"># this way:</div><div class="line">#</div><div class="line"># 1. A random number R between 0 and 1 is extracted.</div><div class="line"># 2. A probability P is calculated as 1/(old_value*lfu_log_factor+1).</div><div class="line"># 3. The counter is incremented only if R &lt; P.</div><div class="line">#</div><div class="line"># The default lfu-log-factor is 10. This is a table of how the frequency</div><div class="line"># counter changes with a different number of accesses with different</div><div class="line"># logarithmic factors:</div><div class="line">#</div><div class="line"># +--------+------------+------------+------------+------------+------------+</div><div class="line"># | factor | 100 hits   | 1000 hits  | 100K hits  | 1M hits    | 10M hits   |</div><div class="line"># +--------+------------+------------+------------+------------+------------+</div><div class="line"># | 0      | 104        | 255        | 255        | 255        | 255        |</div><div class="line"># +--------+------------+------------+------------+------------+------------+</div><div class="line"># | 1      | 18         | 49         | 255        | 255        | 255        |</div><div class="line"># +--------+------------+------------+------------+------------+------------+</div><div class="line"># | 10     | 10         | 18         | 142        | 255        | 255        |</div><div class="line"># +--------+------------+------------+------------+------------+------------+</div><div class="line"># | 100    | 8          | 11         | 49         | 143        | 255        |</div><div class="line"># +--------+------------+------------+------------+------------+------------+</div><div class="line">#</div><div class="line"># NOTE: The above table was obtained by running the following commands:</div><div class="line">#</div><div class="line">#   redis-benchmark -n 1000000 incr foo</div><div class="line">#   redis-cli object freq foo</div><div class="line">#</div><div class="line"># NOTE 2: The counter initial value is 5 in order to give new objects a chance</div><div class="line"># to accumulate hits.</div><div class="line">#</div><div class="line"># The counter decay time is the time, in minutes, that must elapse in order</div><div class="line"># for the key counter to be divided by two (or decremented if it has a value</div><div class="line"># less &lt;= 10).</div><div class="line">#</div><div class="line"># The default value for the lfu-decay-time is 1. A Special value of 0 means to</div><div class="line"># decay the counter every time it happens to be scanned.</div><div class="line">#</div><div class="line"># lfu-log-factor 10</div><div class="line"># lfu-decay-time 1</div><div class="line"></div><div class="line">########################### ACTIVE DEFRAGMENTATION #######################</div><div class="line">#</div><div class="line"># WARNING THIS FEATURE IS EXPERIMENTAL. However it was stress tested</div><div class="line"># even in production and manually tested by multiple engineers for some</div><div class="line"># time.</div><div class="line">#</div><div class="line"># What is active defragmentation?</div><div class="line"># -------------------------------</div><div class="line">#</div><div class="line"># Active (online) defragmentation allows a Redis server to compact the</div><div class="line"># spaces left between small allocations and deallocations of data in memory,</div><div class="line"># thus allowing to reclaim back memory.</div><div class="line">#</div><div class="line"># Fragmentation is a natural process that happens with every allocator (but</div><div class="line"># less so with Jemalloc, fortunately) and certain workloads. Normally a server</div><div class="line"># restart is needed in order to lower the fragmentation, or at least to flush</div><div class="line"># away all the data and create it again. However thanks to this feature</div><div class="line"># implemented by Oran Agra for Redis 4.0 this process can happen at runtime</div><div class="line"># in an &quot;hot&quot; way, while the server is running.</div><div class="line">#</div><div class="line"># Basically when the fragmentation is over a certain level (see the</div><div class="line"># configuration options below) Redis will start to create new copies of the</div><div class="line"># values in contiguous memory regions by exploiting certain specific Jemalloc</div><div class="line"># features (in order to understand if an allocation is causing fragmentation</div><div class="line"># and to allocate it in a better place), and at the same time, will release the</div><div class="line"># old copies of the data. This process, repeated incrementally for all the keys</div><div class="line"># will cause the fragmentation to drop back to normal values.</div><div class="line">#</div><div class="line"># Important things to understand:</div><div class="line">#</div><div class="line"># 1. This feature is disabled by default, and only works if you compiled Redis</div><div class="line">#    to use the copy of Jemalloc we ship with the source code of Redis.</div><div class="line">#    This is the default with Linux builds.</div><div class="line">#</div><div class="line"># 2. You never need to enable this feature if you don&apos;t have fragmentation</div><div class="line">#    issues.</div><div class="line">#</div><div class="line"># 3. Once you experience fragmentation, you can enable this feature when</div><div class="line">#    needed with the command &quot;CONFIG SET activedefrag yes&quot;.</div><div class="line">#</div><div class="line"># The configuration parameters are able to fine tune the behavior of the</div><div class="line"># defragmentation process. If you are not sure about what they mean it is</div><div class="line"># a good idea to leave the defaults untouched.</div><div class="line"></div><div class="line"># Enabled active defragmentation</div><div class="line"># activedefrag yes</div><div class="line"></div><div class="line"># Minimum amount of fragmentation waste to start active defrag</div><div class="line"># active-defrag-ignore-bytes 100mb</div><div class="line"></div><div class="line"># Minimum percentage of fragmentation to start active defrag</div><div class="line"># active-defrag-threshold-lower 10</div><div class="line"></div><div class="line"># Maximum percentage of fragmentation at which we use maximum effort</div><div class="line"># active-defrag-threshold-upper 100</div><div class="line"></div><div class="line"># Minimal effort for defrag in CPU percentage</div><div class="line"># active-defrag-cycle-min 5</div><div class="line"></div><div class="line"># Maximal effort for defrag in CPU percentage</div><div class="line"># active-defrag-cycle-max 75</div><div class="line"></div><div class="line"># Maximum number of set/hash/zset/list fields that will be processed from</div><div class="line"># the main dictionary scan</div><div class="line"># active-defrag-max-scan-fields 1000</div></pre></td></tr></table></figure>
<p>在终端输入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">docker run -p 6379:6379  </div><div class="line">-v ~/docker/redis/data:/data </div><div class="line">-v ~/docker/redis/redis.conf:/user/etc/redis/redis.conf </div><div class="line">-d redis redis-server /user/etc/redis/redis.conf </div><div class="line">--requirepass wukewei123456</div><div class="line">--appendonly yes</div></pre></td></tr></table></figure>
<p>连接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker exec -it 6d58450e9e06&#123;CONTAINER ID&#125; redis-cli -a wukewei123456&#123;密码&#125;</div></pre></td></tr></table></figure>
<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><p> docker run<br> docker start<br> docker stop<br> docker ps -a<br> exit</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/26/Share项目/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="GoGo (吴克伟)">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GoGo's home">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/26/Share项目/" itemprop="url">Share项目</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-26T20:08:26+08:00">
                2019-03-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Share项目是我自己私下在学习并且练习的一个项目，项目大概的是可以去分享自己的宠物，现在项目包含的模块有登录模块、首页模块、个人模块、设置模块。其中项目包含android端、Server端、PC后台管理、Taro端。各个端在开发中，因为是利用自己的业余时间去学习和开发的，所以在整体的进度上是比较缓慢的。在此也希望2019年能够自己花时间去尽可能的去完成，这里先简单的介绍一下各个端所使用的技术，后期会各自写文章描述在学习和开发中遇到的困难。</p>
<h3 id="Server端"><a href="#Server端" class="headerlink" title="Server端"></a><a href="https://github.com/zj-wukewei/share_server" target="_blank" rel="external">Server端</a></h3><p>采用java开发为所有其它端提供api接口，所采用的技术：<br>1：<a href="https://github.com/spring-projects/spring-boot" target="_blank" rel="external">SpringBoot开发</a><br>2：<a href="https://github.com/spring-projects/spring-security" target="_blank" rel="external">Spring Security</a>权限管理和token<br>3：<a href="https://blog.mybatis.org/" target="_blank" rel="external">MyBatis</a>持久层框架,并且使用mybatis-generator来生产代码<br>4：<a href="https://github.com/pagehelper/Mybatis-PageHelper" target="_blank" rel="external">PageHelper</a>(MyBatis的分页插件)<br>5：<a href="https://github.com/mapstruct/mapstruct" target="_blank" rel="external">MapStruct</a>对象与对象之间的互相转换<br>后期会加入swagger</p>
<h3 id="Android端"><a href="#Android端" class="headerlink" title="Android端"></a><a href="https://github.com/zj-wukewei/share_android" target="_blank" rel="external">Android端</a></h3><p>采用Kotlin开发，所采用的技术，暂时完成登录和首页列表：<br>1：<a href="https://github.com/ReactiveX/RxJava" target="_blank" rel="external">RxJava</a><br>2：<a href="https://github.com/square/retrofit" target="_blank" rel="external">Retrofit</a>网络请求<br>3：<a href="https://github.com/google/dagger" target="_blank" rel="external">Dagger2</a>一个依赖注入库<br>4：<a href="https://github.com/bumptech/glide" target="_blank" rel="external">Glide</a>图片请求</p>
<h3 id="Pc端后台管理"><a href="#Pc端后台管理" class="headerlink" title="Pc端后台管理"></a><a href="https://github.com/zj-wukewei/share_admin" target="_blank" rel="external">Pc端后台管理</a></h3><p>采用React开发后台开发管理系统，采用的技术：<br>1：<a href="https://github.com/facebook/react" target="_blank" rel="external">React</a><br>2：<a href="https://github.com/ReactTraining/react-router" target="_blank" rel="external">react-router</a><br>3：<a href="https://github.com/reduxjs/redux" target="_blank" rel="external">redux</a><br>4：<a href="https://ant.design/index-cn" target="_blank" rel="external">antd</a></p>
<h3 id="Taro适配小程序、H5"><a href="#Taro适配小程序、H5" class="headerlink" title="Taro适配小程序、H5"></a><a href="https://github.com/zj-wukewei/share_taro" target="_blank" rel="external">Taro适配小程序、H5</a></h3><p>采用Taro来开发，暂时选定适配小程序和H5端，采用的技术如下：<br>1：<a href="https://github.com/NervJS/taro" target="_blank" rel="external">Taro</a><br>2：<a href="https://github.com/NervJS/taro-ui" target="_blank" rel="external">taro-ui</a>ui库<br>3：<a href="https://github.com/dvajs/dva" target="_blank" rel="external">dva</a></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>这四个端的学习和工作量还是比较大的，希望在接下来的时间能够坚持的去学习和不断的完成这4个端的代码，尽管进度比较慢，但也不能停止学习的脚步。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/11/kotlin学习之DslAdapter/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="GoGo (吴克伟)">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GoGo's home">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/11/kotlin学习之DslAdapter/" itemprop="url">Kotlin学习之DslAdapter</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-11T12:22:29+08:00">
                2018-11-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>又开始学习kotlin了，Adapter的库在github也是一找一大堆，这次Dsl就用它来学习吧，DataBinding（支持多布局）</p>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">val mAdapter = MagicAdapter.repositoryAdapter()</div><div class="line">          .addItemDsl&lt;String&gt; &#123;</div><div class="line">              resId = R.layout.item_string</div><div class="line">              dataMatch = &#123; d, _ -&gt; d is String &#125;</div><div class="line">              itemId(BR.user) &#123; User(1234567, &quot;GoGo&quot;) &#125;</div><div class="line">              handler(BR.presenter, View.OnClickListener &#123;</div><div class="line">                  Toast.makeText(this@MainActivity, R.string.item_string, Toast.LENGTH_LONG).show()</div><div class="line">              &#125;)</div><div class="line">              areItems = &#123; o, n -&gt; o == n &#125;</div><div class="line">          &#125;</div><div class="line">          .addItemDsl&lt;User&gt; &#123;</div><div class="line">              resId = R.layout.item_user</div><div class="line">              dataMatch = &#123; d, _ -&gt; d is User &#125;</div><div class="line">              handler(BR.presenter, View.OnClickListener &#123;</div><div class="line">                  Toast.makeText(this@MainActivity, R.string.item_user, Toast.LENGTH_LONG).show()</div><div class="line">              &#125;)</div><div class="line">              areItems = &#123; o, n -&gt; o.id == n.id &#125;</div><div class="line">              areContents = &#123; o, n -&gt; o.id == n.id &amp;&amp; o.name == n.name&#125;</div><div class="line">          &#125;</div><div class="line">          .build()</div><div class="line"></div><div class="line">      binding.rv.run &#123;</div><div class="line">          adapter = mAdapter</div><div class="line">          layoutManager = LinearLayoutManager(this@MainActivity)</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      val data = ArrayList&lt;Any&gt;()</div><div class="line">      data.add(&quot;11111&quot;)</div><div class="line">      data.add(&quot;22222&quot;)</div><div class="line">      data.add(&quot;33333&quot;)</div><div class="line">      data.add(&quot;44444&quot;)</div><div class="line">      data.add(&quot;44444&quot;)</div><div class="line">      data.add(User(111, &quot;张三&quot;))</div><div class="line">      data.add(User(222, &quot;李四&quot;))</div><div class="line">      data.add(User(333, &quot;王五&quot;))</div><div class="line">      data.add(User(444, &quot;桃六&quot;))</div><div class="line"></div><div class="line">      mAdapter.submitList(data)</div></pre></td></tr></table></figure>
<p>主要方法介绍addItemDsl()方法代表添加一个布局可以指定类型，传入一个MagicItem类，resId代码布局id，dataMatch是之在多布局的时候，当前item的数据和你加入的布局类型是否符合，因为是DataBinding版本，所以在布局上默认有个BR.item的,如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;data&gt;</div><div class="line"></div><div class="line">      &lt;variable</div><div class="line">              name=&quot;item&quot;</div><div class="line">              type=&quot;String&quot;/&gt;</div><div class="line"></div><div class="line">      &lt;variable name=&quot;user&quot; type=&quot;com.github.wkw.magicadapter.User&quot;/&gt;</div><div class="line"></div><div class="line">      &lt;variable</div><div class="line">              name=&quot;presenter&quot;</div><div class="line">              type=&quot;android.view.View.OnClickListener&quot;/&gt;</div><div class="line"></div><div class="line">  &lt;/data&gt;</div></pre></td></tr></table></figure></p>
<p>itemId方法就是可以给布局加入其它类型的比如我加入了User类型，handler方法也是传人id和函数，因为有时候你会onClick，onLongClick自己可以加入。areItems和areContents代表的意思是加入了DiffUtil.Callback() 里面的两个areItemsTheSame和areContentsTheSame方法。</p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>MagicAdapter里面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">private var datas: MutableList&lt;Any&gt; = ArrayList()</div><div class="line"></div><div class="line">internal val items: MutableList&lt;MagicItem&lt;Any&gt;&gt; = builder.items</div><div class="line"></div><div class="line">private val positionToTypeMap = SparseIntArray()</div></pre></td></tr></table></figure>
<p>item就是记录所以的布局总和，如何通过position来找到对应的布局核心代码就是如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">private fun positionToItemsIndex(position: Int): Int &#123;</div><div class="line">       if (items.isEmpty()) &#123;</div><div class="line">           throw RuntimeException(&quot;item must add&quot;)</div><div class="line">       &#125;</div><div class="line">       items.forEachIndexed &#123; index, magicItem -&gt;</div><div class="line">           if (magicItem.getItemViewType(datas[position], position)) &#123;</div><div class="line">               positionToTypeMap.put(position, index)</div><div class="line">               return index</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       throw RuntimeException(&quot;can&apos;t find matched item&quot;)</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>onBindViewHolder默认</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">override fun onBindViewHolder(holder: BindingViewHolder&lt;ViewDataBinding&gt;, postion: Int) &#123;</div><div class="line">       val data = datas[postion]</div><div class="line">       val magicItem = items[positionToTypeMap.get(postion)]</div><div class="line"></div><div class="line">       holder.binding.setVariable(BR.item, data)</div><div class="line"></div><div class="line">       val handlers = magicItem.handlers()</div><div class="line">       for ((id, handle) in handlers) &#123;</div><div class="line">           holder.binding.setVariable(id, handle)</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       val itemIds = magicItem.itemIds()</div><div class="line">       for ((idGet, setter) in itemIds) &#123;</div><div class="line">           val itemVariable = idGet(data)</div><div class="line">           holder.binding.setVariable(itemVariable, setter(data))</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       holder.binding.executePendingBindings()</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>其实代码量很少。</p>
<h3 id="支持Dsl"><a href="#支持Dsl" class="headerlink" title="支持Dsl"></a>支持Dsl</h3><p>MagicDslItem类来支持</p>
<h3 id="不足之处"><a href="#不足之处" class="headerlink" title="不足之处"></a>不足之处</h3><p>目前只支持databinding版本后期可以支持普通版本，<a href="https://github.com/zj-wukewei/KotlinDslMagicAdapter/" target="_blank" rel="external">DataBindingDslAdapter</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/27/在library中使用productFlavors/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="GoGo (吴克伟)">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GoGo's home">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/27/在library中使用productFlavors/" itemprop="url">在library中使用productFlavors</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-27T16:10:13+08:00">
                2018-10-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>因为公司的app是医生端和患者端，在app开发中会很多模块是相似的只有一部分逻辑不同，比如登录模块,IM模块。</p>
<h3 id="library使用productFlavors"><a href="#library使用productFlavors" class="headerlink" title="library使用productFlavors"></a>library使用productFlavors</h3><p> 在library的 build.gradle中如下配置，</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">flavorDimensions &quot;type&quot;</div><div class="line"></div><div class="line">publishNonDefault true</div><div class="line"></div><div class="line"></div><div class="line">productFlavors &#123;</div><div class="line"></div><div class="line">    doctor &#123;</div><div class="line">        buildConfigField(&quot;String&quot;, &quot;appType&quot;, &quot;\&quot;1\&quot;&quot;)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    patient &#123;</div><div class="line">        buildConfigField(&quot;String&quot;, &quot;appType&quot;, &quot;\&quot;2\&quot;&quot;)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> 定义一个维度为 type类型的，分android和patient，定义了appType，1为医生端，2为患者端，在library中可以使用如下来区分是哪个渠道，BuildConfig.appType,但是当很大一部分代码不一样的时候，可以在src目录下建立两个doctor和patient的包，这样在打包的时候就不会把对方渠道的代码打进去，可以减少app的体积。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"> public class LoginActivity extends AppCompatActivity &#123;</div><div class="line">    private TextView mTvType;</div><div class="line">    @Override</div><div class="line">    protected void onCreate(@Nullable Bundle savedInstanceState) &#123;</div><div class="line">        super.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.login_activity_login);</div><div class="line">        mTvType = findViewById(R.id.tv_login_type);</div><div class="line">        mTvType.setText(BuildConfig.appType);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="app中使用"><a href="#app中使用" class="headerlink" title="app中使用"></a>app中使用</h3><p>  app是分两个的，在doctor的app下我们只想要doctor渠道，patient也是类型，但是我在doctor的app下面是不想要这两个渠道的，我只需要其中的一中而且是确定的，app下有自己的渠道,这种情况就是library中有，但是app中没有，这个时候可以使用missingDimensionStrategy选择策，在defaultConfig下，意思就是我当前app下没有和library相同渠道的时候，都采用你设置的渠道，这样不管app自己有什么渠道，都会采用library中你所选择的渠道。（还有很多其它场景可以使用matchingFallbacks属性来设置回退策略）</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">   defaultConfig &#123;</div><div class="line">        applicationId &quot;com.github.wkw.doctor&quot;</div><div class="line">        minSdkVersion 21</div><div class="line">        targetSdkVersion 28</div><div class="line">        versionCode 1</div><div class="line">        versionName &quot;1.0&quot;</div><div class="line">        testInstrumentationRunner &quot;android.support.test.runner.AndroidJUnitRunner&quot;</div><div class="line">        missingDimensionStrategy &quot;type&quot;, &quot;doctor&quot;</div><div class="line">    &#125;</div><div class="line">    buildTypes &#123;</div><div class="line">        release &#123;</div><div class="line">            minifyEnabled false</div><div class="line">            proguardFiles getDefaultProguardFile(&apos;proguard-android.txt&apos;), &apos;proguard-rules.pro&apos;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    flavorDimensions &quot;app&quot;</div><div class="line"></div><div class="line">    productFlavors &#123;</div><div class="line">        preProd &#123;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    dependencies &#123;</div><div class="line">       implementation fileTree(dir: &apos;libs&apos;, include: [&apos;*.jar&apos;])</div><div class="line">       implementation project(&apos;:module_login&apos;)</div><div class="line">    &#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>这样login模块就不用维护两份代码，当出现bug的时候还要修改两份，这种办法非常适合两个高度相似的app。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/21/android组件化登录的思考/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="GoGo (吴克伟)">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GoGo's home">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/21/android组件化登录的思考/" itemprop="url">android组件化登录的思考</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-21T21:07:23+08:00">
                2018-10-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="登录问题思考"><a href="#登录问题思考" class="headerlink" title="登录问题思考"></a>登录问题思考</h3><p> 很久没有写文章了，因为一些个人的原因，但是现在一切问题都解决了。1年前写了一篇android组件化的学习，里面提到了commonbusiness里面会包含登录模块，但是后来经过实践表明这是一个不理想的决定，因为在各个模块当然运行的时候大多数的功能都是会依赖登录模块的，这样会造成各个模块都要登录。<br> 现在的做法是把登录模块单独提取出来，也能单独运行， 登录模块运行之后，登录成功之后其它模块的app也能感知到登录成功之后的用户数据。</p>
<h3 id="运用内容提供者进行app之间通讯"><a href="#运用内容提供者进行app之间通讯" class="headerlink" title="运用内容提供者进行app之间通讯"></a>运用内容提供者进行app之间通讯</h3><p> 登录模块定义一个UserContentProvider代码如下：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">public class UserContentProvider extends DaggerContentProvider &#123;</div><div class="line"></div><div class="line"></div><div class="line">    private static final int SUCCESS = 1;</div><div class="line"></div><div class="line">    private final String[] columnNames = new String[]&#123;AppConstats.TOKEN, AppConstats.UID&#125;;</div><div class="line">    static UriMatcher mUriMatcher = new UriMatcher(UriMatcher.NO_MATCH);</div><div class="line"></div><div class="line">    static &#123;</div><div class="line">        mUriMatcher.addURI(&quot;com.modularization.android.login&quot;, &quot;user&quot;, SUCCESS);    //uri规则可自己定义，但一定和清单文件一直</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Inject</div><div class="line">    RxSharedPreferences mRxSharedPreferences;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public boolean onCreate() &#123;</div><div class="line">        return super.onCreate();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Nullable</div><div class="line">    @Override</div><div class="line">    public Cursor query(@NonNull Uri uri, @Nullable String[] strings, @Nullable String s, @Nullable String[] strings1, @Nullable String s1) &#123;</div><div class="line">        String token = mRxSharedPreferences.getString(AppConstats.TOKEN).get();</div><div class="line">        String uId = mRxSharedPreferences.getString(AppConstats.UID).get();</div><div class="line">        MatrixCursor cursor = new MatrixCursor(columnNames);</div><div class="line">        cursor.addRow(new String[] &#123;token, uId&#125;);</div><div class="line">        return cursor;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Nullable</div><div class="line">    @Override</div><div class="line">    public String getType(@NonNull Uri uri) &#123;</div><div class="line">        return null;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Nullable</div><div class="line">    @Override</div><div class="line">    public Uri insert(@NonNull Uri uri, @Nullable ContentValues contentValues) &#123;</div><div class="line">        return null;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public int delete(@NonNull Uri uri, @Nullable String s, @Nullable String[] strings) &#123;</div><div class="line">        return 0;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public int update(@NonNull Uri uri, @Nullable ContentValues contentValues, @Nullable String s, @Nullable String[] strings) &#123;</div><div class="line">        return 0;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> 我这里简单的使用了RxSharedPreferences去保存登录成功之后的数据，提供了query方法。</p>
<p> 登录的伪代码</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">String token  = UUID.randomUUID().toString();</div><div class="line">         String uId = &quot;123456&quot;;</div><div class="line">         SharedPreferences.Editor editor = mSharedPreferences.edit();</div><div class="line">         editor.putString(AppConstats.TOKEN, token);</div><div class="line">         editor.putString(AppConstats.UID, uId);</div><div class="line">         editor.apply();</div><div class="line">         getContentResolver().notifyChange(Uri.parse(AppConstats.USER_URI), null);</div></pre></td></tr></table></figure>
<p>getContentResolver().notifyChange(）方法来通知其它模块app变化了。</p>
<p>因为在commonbusiness的UserSystem类，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">@Singleton</div><div class="line">public class UserSystem &#123;</div><div class="line">    private static final String KEY_TOKEN = &quot;token&quot;;</div><div class="line">    private static final String KEY_USER_ID = &quot;uid&quot;;</div><div class="line"></div><div class="line">    private BehaviorSubject&lt;TokenEntity&gt; mTokenEntityBehaviorSubject = BehaviorSubject.create();</div><div class="line"></div><div class="line">    private Context mContext;</div><div class="line"></div><div class="line">    @Inject</div><div class="line">    public UserSystem(Context context) &#123;</div><div class="line">        this.mContext = context;</div><div class="line">        loadTokenEntity();</div><div class="line">        context.getContentResolver().registerContentObserver(Uri.parse(AppConstats.USER_URI), false, new ContentObserver(null) &#123;</div><div class="line">            @Override</div><div class="line">            public void onChange(boolean selfChange) &#123;</div><div class="line">                super.onChange(selfChange);</div><div class="line">                loadTokenEntity();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    private void loadTokenEntity() &#123;</div><div class="line">        ContentResolver resolver = mContext.getContentResolver();</div><div class="line">        Uri uri = Uri.parse(AppConstats.USER_URI);</div><div class="line">        Cursor cursor = resolver.query(uri, null, null, null, null);</div><div class="line">        if (cursor != null) &#123;</div><div class="line">            while (cursor.moveToNext()) &#123;</div><div class="line">                String token = cursor.getString(0);</div><div class="line">                String uId = cursor.getString(1);</div><div class="line">                TokenEntity entity = new TokenEntity(uId, token);</div><div class="line">                mTokenEntityBehaviorSubject.onNext(entity);</div><div class="line">            &#125;</div><div class="line">            cursor.close();</div><div class="line">        &#125; else &#123;</div><div class="line">            ToastUtils.show(mContext, &quot;请安装登录模块&quot;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public Observable&lt;TokenEntity&gt; getTokenEntityObservable() &#123;</div><div class="line">        return mTokenEntityBehaviorSubject;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>registerContentObserver方法能监听到数据的变化，再去从新获取数据这样在登录模块单独运行的时候，登录成功其它模块的app也能感知得到变化，这样就只要登录一次就可以了。</p>
<h3 id="其它思考"><a href="#其它思考" class="headerlink" title="其它思考"></a>其它思考</h3><p>因为每个app接口要是你没有登录你都会返回一个错误码，全局app都有个错误处理的方法，我的如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">public class ResponseListenerImpl implements ResponseErrorListener &#123;</div><div class="line">    @Override</div><div class="line">    public void handleResponseError(Context context, Throwable t) &#123;</div><div class="line">        Timber.e(t);</div><div class="line">        if (t instanceof ResponseException) &#123;</div><div class="line"></div><div class="line">        &#125;</div><div class="line">        final String msg = ErrorMessageFactory.create(context, (Exception) t);</div><div class="line">        ToastUtils.show(context, msg);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这里面你就可以获取那个code，然后采用android:scheme 通过uri跳转到登录模块的LoginActivity,这样就算各个模块单独运行也会让你感觉在一个app之内一个，比如A模块app服务端返回要从新登录的code，这样跳转到Login模块的app中走完登录流程，采用内容提供者来通知A模块我登录完成了，A模块获取用户数据，再进行需要登录之后的操作，代码在我的github里面的<a href="https://github.com/zj-wukewei/ModularizationExample" target="_blank" rel="external">ModularizationExample项目</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/09/Lifecycle学习/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="GoGo (吴克伟)">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GoGo's home">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/09/Lifecycle学习/" itemprop="url">Lifecycle学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-09T22:46:02+08:00">
                2017-11-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>用于构建生命周期感知组件的类和接口，这些组件可以根据 Activity 或 Fragment 的当前生命周期自动调整其行为,在support版本为26.1.0中默认的AppCompatActivity和fragment已经集成这个功能。</p>
<h4 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h4><p>（1）首先让你的类实现LifecycleObserver接口，在类方法上加上注解OnLifecycleEvent</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">public class LifecycleTest implements LifecycleObserver &#123;</div><div class="line">    private static final String TAG = &quot;LifecycleTest&quot;;</div><div class="line"></div><div class="line">    @OnLifecycleEvent(Lifecycle.Event.ON_CREATE)</div><div class="line">    public void onCreate() &#123;</div><div class="line">        Log.d(TAG, &quot;onCreate&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @OnLifecycleEvent(Lifecycle.Event.ON_START)</div><div class="line">    public void onStart() &#123;</div><div class="line">        Log.d(TAG, &quot;onStart&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @OnLifecycleEvent(Lifecycle.Event.ON_RESUME)</div><div class="line">    public void onResume() &#123;</div><div class="line">        Log.d(TAG, &quot;onResume&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    @OnLifecycleEvent(Lifecycle.Event.ON_PAUSE)</div><div class="line">    public void onPause() &#123;</div><div class="line">        Log.d(TAG, &quot;onPause&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @OnLifecycleEvent(Lifecycle.Event.ON_STOP)</div><div class="line">    public void onStop() &#123;</div><div class="line">        Log.d(TAG, &quot;onStop&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @OnLifecycleEvent(Lifecycle.Event.ON_DESTROY)</div><div class="line">    public void onDestroy() &#123;</div><div class="line">        Log.d(TAG, &quot;onDestroy&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中的Event为以下代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">public enum Event &#123;</div><div class="line">       /**</div><div class="line">        * Constant for onCreate event of the &#123;@link LifecycleOwner&#125;.</div><div class="line">        */</div><div class="line">       ON_CREATE,</div><div class="line">       /**</div><div class="line">        * Constant for onStart event of the &#123;@link LifecycleOwner&#125;.</div><div class="line">        */</div><div class="line">       ON_START,</div><div class="line">       /**</div><div class="line">        * Constant for onResume event of the &#123;@link LifecycleOwner&#125;.</div><div class="line">        */</div><div class="line">       ON_RESUME,</div><div class="line">       /**</div><div class="line">        * Constant for onPause event of the &#123;@link LifecycleOwner&#125;.</div><div class="line">        */</div><div class="line">       ON_PAUSE,</div><div class="line">       /**</div><div class="line">        * Constant for onStop event of the &#123;@link LifecycleOwner&#125;.</div><div class="line">        */</div><div class="line">       ON_STOP,</div><div class="line">       /**</div><div class="line">        * Constant for onDestroy event of the &#123;@link LifecycleOwner&#125;.</div><div class="line">        */</div><div class="line">       ON_DESTROY,</div><div class="line">       /**</div><div class="line">        * An &#123;@link Event Event&#125; constant that can be used to match all events.</div><div class="line">        */</div><div class="line">       ON_ANY</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>很清晰的看到各种的值对应的生命周期的哪个方法。</p>
<p>（2）在activity或者fragmetn中注册</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">getLifecycle().addObserver(new LifecycleTest());</div></pre></td></tr></table></figure>
<h4 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h4><p>从addObserver这个方法切入，Lifecycle是一个抽象类，它的实现类是LifecycleRegistry，从下面我们可以猜测到运用了典型的观察者模式。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">@MainThread</div><div class="line">public abstract void addObserver(LifecycleObserver observer);</div><div class="line"></div><div class="line">@MainThread</div><div class="line">public abstract void removeObserver(LifecycleObserver observer);</div><div class="line"></div><div class="line">@MainThread</div><div class="line">public abstract State getCurrentState();</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div></pre></td><td class="code"><pre><div class="line">public class LifecycleRegistry extends Lifecycle &#123;</div><div class="line"></div><div class="line">    ....省略代码</div><div class="line"></div><div class="line">     @Override</div><div class="line">    public void addObserver(LifecycleObserver observer) &#123;</div><div class="line">        State initialState = mState == DESTROYED ? DESTROYED : INITIALIZED;</div><div class="line">        ObserverWithState statefulObserver = new ObserverWithState(observer, initialState);</div><div class="line">        ObserverWithState previous = mObserverMap.putIfAbsent(observer, statefulObserver);</div><div class="line"></div><div class="line">        if (previous != null) &#123;</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        boolean isReentrance = mAddingObserverCounter != 0 || mHandlingEvent;</div><div class="line"></div><div class="line">        State targetState = calculateTargetState(observer);</div><div class="line">        mAddingObserverCounter++;</div><div class="line">        while ((statefulObserver.mState.compareTo(targetState) &lt; 0</div><div class="line">                &amp;&amp; mObserverMap.contains(observer))) &#123;</div><div class="line">            pushParentState(statefulObserver.mState);</div><div class="line">            statefulObserver.dispatchEvent(mLifecycleOwner, upEvent(statefulObserver.mState));</div><div class="line">            popParentState();</div><div class="line">            // mState / subling may have been changed recalculate</div><div class="line">            targetState = calculateTargetState(observer);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (!isReentrance) &#123;</div><div class="line">            // we do sync only on the top level.</div><div class="line">            sync();</div><div class="line">        &#125;</div><div class="line">        mAddingObserverCounter--;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">static class ObserverWithState &#123;</div><div class="line">        State mState;</div><div class="line">        GenericLifecycleObserver mLifecycleObserver;</div><div class="line"></div><div class="line">        ObserverWithState(LifecycleObserver observer, State initialState) &#123;</div><div class="line">            mLifecycleObserver = Lifecycling.getCallback(observer);</div><div class="line">            mState = initialState;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        void dispatchEvent(LifecycleOwner owner, Event event) &#123;</div><div class="line">            State newState = getStateAfter(event);</div><div class="line">            mState = min(mState, newState);</div><div class="line">            mLifecycleObserver.onStateChanged(owner, event);</div><div class="line">            mState = newState;</div><div class="line">        &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"> @NonNull</div><div class="line">    static GenericLifecycleObserver getCallback(Object object) &#123;</div><div class="line">        if (object instanceof GenericLifecycleObserver) &#123;</div><div class="line">            return (GenericLifecycleObserver) object;</div><div class="line">        &#125;</div><div class="line">        //noinspection TryWithIdenticalCatches</div><div class="line">        try &#123;</div><div class="line">            final Class&lt;?&gt; klass = object.getClass();</div><div class="line">            Constructor&lt;? extends GenericLifecycleObserver&gt; cachedConstructor = sCallbackCache.get(</div><div class="line">                    klass);</div><div class="line">            if (cachedConstructor != null) &#123;</div><div class="line">                return cachedConstructor.newInstance(object);</div><div class="line">            &#125;</div><div class="line">            cachedConstructor = getGeneratedAdapterConstructor(klass);</div><div class="line">            if (cachedConstructor != null) &#123;</div><div class="line">                if (!cachedConstructor.isAccessible()) &#123;</div><div class="line">                    cachedConstructor.setAccessible(true);</div><div class="line">                &#125;</div><div class="line">            &#125; else &#123;</div><div class="line">                cachedConstructor = sREFLECTIVE;</div><div class="line">            &#125;</div><div class="line">            sCallbackCache.put(klass, cachedConstructor);</div><div class="line">            return cachedConstructor.newInstance(object);</div><div class="line">        &#125; catch (IllegalAccessException e) &#123;</div><div class="line">            throw new RuntimeException(e);</div><div class="line">        &#125; catch (InstantiationException e) &#123;</div><div class="line">            throw new RuntimeException(e);</div><div class="line">        &#125; catch (InvocationTargetException e) &#123;</div><div class="line">            throw new RuntimeException(e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">public interface GenericLifecycleObserver extends LifecycleObserver &#123;</div><div class="line">    /**</div><div class="line">     * Called when a state transition event happens.</div><div class="line">     *</div><div class="line">     * @param source The source of the event</div><div class="line">     * @param event The event</div><div class="line">     */</div><div class="line">    void onStateChanged(LifecycleOwner source, Lifecycle.Event event);</div><div class="line">&#125;</div><div class="line"></div><div class="line">class ReflectiveGenericLifecycleObserver implements GenericLifecycleObserver &#123;</div><div class="line">    private final Object mWrapped;</div><div class="line">    private final CallbackInfo mInfo;</div><div class="line">    //缓存ReflectiveGenericLifecycleObserver实例</div><div class="line">    @SuppressWarnings(&quot;WeakerAccess&quot;)</div><div class="line">    static final Map&lt;Class, CallbackInfo&gt; sInfoCache = new HashMap&lt;&gt;();</div><div class="line"></div><div class="line">    ReflectiveGenericLifecycleObserver(Object wrapped) &#123;  </div><div class="line">        mWrapped = wrapped;</div><div class="line">        mInfo = getInfo(mWrapped.getClass());</div><div class="line">    &#125;</div><div class="line">      private static CallbackInfo getInfo(Class klass) &#123;</div><div class="line">        CallbackInfo existing = sInfoCache.get(klass);</div><div class="line">        if (existing != null) &#123;</div><div class="line">            return existing;</div><div class="line">        &#125;</div><div class="line">        existing = createInfo(klass);</div><div class="line">        return existing;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private static CallbackInfo createInfo(Class klass) &#123;</div><div class="line">        Class superclass = klass.getSuperclass();</div><div class="line">        Map&lt;MethodReference, Event&gt; handlerToEvent = new HashMap&lt;&gt;();</div><div class="line">        if (superclass != null) &#123;</div><div class="line">            CallbackInfo superInfo = getInfo(superclass);</div><div class="line">            if (superInfo != null) &#123;</div><div class="line">                handlerToEvent.putAll(superInfo.mHandlerToEvent);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Method[] methods = klass.getDeclaredMethods();</div><div class="line"></div><div class="line">        Class[] interfaces = klass.getInterfaces();</div><div class="line">        for (Class intrfc : interfaces) &#123;</div><div class="line">            for (Entry&lt;MethodReference, Event&gt; entry : getInfo(intrfc).mHandlerToEvent.entrySet()) &#123;</div><div class="line">                verifyAndPutHandler(handlerToEvent, entry.getKey(), entry.getValue(), klass);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        for (Method method : methods) &#123;</div><div class="line">            OnLifecycleEvent annotation = method.getAnnotation(OnLifecycleEvent.class);</div><div class="line">            if (annotation == null) &#123;</div><div class="line">                continue;</div><div class="line">            &#125;</div><div class="line">            Class&lt;?&gt;[] params = method.getParameterTypes();</div><div class="line">            int callType = CALL_TYPE_NO_ARG;</div><div class="line">            if (params.length &gt; 0) &#123;</div><div class="line">                callType = CALL_TYPE_PROVIDER;</div><div class="line">                if (!params[0].isAssignableFrom(LifecycleOwner.class)) &#123;</div><div class="line">                    throw new IllegalArgumentException(</div><div class="line">                            &quot;invalid parameter type. Must be one and instanceof LifecycleOwner&quot;);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            Event event = annotation.value();</div><div class="line"></div><div class="line">            if (params.length &gt; 1) &#123;</div><div class="line">                callType = CALL_TYPE_PROVIDER_WITH_EVENT;</div><div class="line">                if (!params[1].isAssignableFrom(Event.class)) &#123;</div><div class="line">                    throw new IllegalArgumentException(</div><div class="line">                            &quot;invalid parameter type. second arg must be an event&quot;);</div><div class="line">                &#125;</div><div class="line">                if (event != Event.ON_ANY) &#123;</div><div class="line">                    throw new IllegalArgumentException(</div><div class="line">                            &quot;Second arg is supported only for ON_ANY value&quot;);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            if (params.length &gt; 2) &#123;</div><div class="line">                throw new IllegalArgumentException(&quot;cannot have more than 2 params&quot;);</div><div class="line">            &#125;</div><div class="line">            MethodReference methodReference = new MethodReference(callType, method);</div><div class="line">            verifyAndPutHandler(handlerToEvent, methodReference, event, klass);</div><div class="line">        &#125;</div><div class="line">        CallbackInfo info = new CallbackInfo(handlerToEvent);</div><div class="line">        sInfoCache.put(klass, info);</div><div class="line">        return info;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ObserverWithState这个类保持当前的状态和GenericLifecycleObserver，其中GenericLifecycleObserver也是个接口，实现类为ReflectiveGenericLifecycleObserver，就是把LifecycleObserver添加了onStateChanged（）的方法，这样在ObserverWithState的dispatchEvent的方法中调用onStateChanged，来通知状态发生变化，从而达到要调用那个注解方法，ReflectiveGenericLifecycleObserver里面有CallbackInfo mInfo，其实就是反射获取你添加了OnLifecycleEvent的注解的方法，以便到时候调用。</p>
<p>activity的生命周期和LifecycleRegistry关联，其中有个SupportActivity类，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">public class SupportActivity extends Activity implements LifecycleOwner &#123;</div><div class="line">    @Override</div><div class="line">    @SuppressWarnings(&quot;RestrictedApi&quot;)</div><div class="line">    protected void onCreate(@Nullable Bundle savedInstanceState) &#123;</div><div class="line">        super.onCreate(savedInstanceState);</div><div class="line">        ReportFragment.injectIfNeededIn(this);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">public class ReportFragment extends Fragment &#123;</div><div class="line">     public static void injectIfNeededIn(Activity activity) &#123;</div><div class="line">        // ProcessLifecycleOwner should always correctly work and some activities may not extend</div><div class="line">        // FragmentActivity from support lib, so we use framework fragments for activities</div><div class="line">        android.app.FragmentManager manager = activity.getFragmentManager();</div><div class="line">        if (manager.findFragmentByTag(REPORT_FRAGMENT_TAG) == null) &#123;</div><div class="line">            manager.beginTransaction().add(new ReportFragment(), REPORT_FRAGMENT_TAG).commit();</div><div class="line">            // Hopefully, we are the first to make a transaction.</div><div class="line">            manager.executePendingTransactions();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    @Override</div><div class="line">    public void onActivityCreated(Bundle savedInstanceState) &#123;</div><div class="line">        super.onActivityCreated(savedInstanceState);</div><div class="line">        dispatchCreate(mProcessListener);</div><div class="line">        dispatch(Lifecycle.Event.ON_CREATE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">     private void dispatch(Lifecycle.Event event) &#123;</div><div class="line">        Activity activity = getActivity();</div><div class="line">        if (activity instanceof LifecycleRegistryOwner) &#123;</div><div class="line">            ((LifecycleRegistryOwner) activity).getLifecycle().handleLifecycleEvent(event);</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (activity instanceof LifecycleOwner) &#123;</div><div class="line">            Lifecycle lifecycle = ((LifecycleOwner) activity).getLifecycle();</div><div class="line">            if (lifecycle instanceof LifecycleRegistry) &#123;</div><div class="line">                ((LifecycleRegistry) lifecycle).handleLifecycleEvent(event);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>就是通过添加个空的ReportFragment来监听activity的生命周期的变化（貌似很多地方都用到了这个），通过监听ReportFragment生命周期调用dispatch(Lifecycle.Event.ON_CREATE)，最后到LifecycleRegistry的handleLifecycleEvent方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">  public void handleLifecycleEvent(Lifecycle.Event event) &#123;</div><div class="line">        mState = getStateAfter(event);</div><div class="line">        if (mHandlingEvent || mAddingObserverCounter != 0) &#123;</div><div class="line">            mNewEventOccurred = true;</div><div class="line">            // we will figure out what to do on upper level.</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line">        mHandlingEvent = true;</div><div class="line">        sync();</div><div class="line">        mHandlingEvent = false;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">      // happens only on the top of stack (never in reentrance),</div><div class="line">    // so it doesn&apos;t have to take in account parents</div><div class="line">private void sync() &#123;</div><div class="line">        while (!isSynced()) &#123;</div><div class="line">            mNewEventOccurred = false;</div><div class="line">            // no need to check eldest for nullability, because isSynced does it for us.</div><div class="line">            if (mState.compareTo(mObserverMap.eldest().getValue().mState) &lt; 0) &#123;</div><div class="line">                backwardPass();</div><div class="line">            &#125;</div><div class="line">            Entry&lt;LifecycleObserver, ObserverWithState&gt; newest = mObserverMap.newest();</div><div class="line">            if (!mNewEventOccurred &amp;&amp; newest != null</div><div class="line">                    &amp;&amp; mState.compareTo(newest.getValue().mState) &gt; 0) &#123;</div><div class="line">                forwardPass();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        mNewEventOccurred = false;</div><div class="line">&#125;</div><div class="line"></div><div class="line">private boolean isSynced() &#123;</div><div class="line">        if (mObserverMap.size() == 0) &#123;</div><div class="line">            return true;</div><div class="line">        &#125;</div><div class="line">        State eldestObserverState = mObserverMap.eldest().getValue().mState;</div><div class="line">        State newestObserverState = mObserverMap.newest().getValue().mState;</div><div class="line">        return eldestObserverState == newestObserverState &amp;&amp; mState == newestObserverState;</div><div class="line">&#125;</div><div class="line">private void forwardPass() &#123;</div><div class="line">        Iterator&lt;Entry&lt;LifecycleObserver, ObserverWithState&gt;&gt; ascendingIterator =</div><div class="line">                mObserverMap.iteratorWithAdditions();</div><div class="line">        while (ascendingIterator.hasNext() &amp;&amp; !mNewEventOccurred) &#123;</div><div class="line">            Entry&lt;LifecycleObserver, ObserverWithState&gt; entry = ascendingIterator.next();</div><div class="line">            ObserverWithState observer = entry.getValue();</div><div class="line">            while ((observer.mState.compareTo(mState) &lt; 0 &amp;&amp; !mNewEventOccurred</div><div class="line">                    &amp;&amp; mObserverMap.contains(entry.getKey()))) &#123;</div><div class="line">                pushParentState(observer.mState);</div><div class="line">                observer.dispatchEvent(mLifecycleOwner, upEvent(observer.mState));</div><div class="line">                popParentState();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">static class CallbackInfo &#123;</div><div class="line">    final Map&lt;Event, List&lt;MethodReference&gt;&gt; mEventToHandlers;</div><div class="line">        final Map&lt;MethodReference, Event&gt; mHandlerToEvent;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>sync同步状态，isSynced判断要不要同步，它是比较当前的状态和我们存我们存放观察者的集合最早或最新放入的观察者的状态，当前状态比之前状态消的时候就是要回滚，好比从OnPause到OnResume，则调用backwardPass回退，forwardPass则为前进，最后调用<br>dispatchEvent方法就是，ObserverWithState的，最后调用onStateChanged，之前CallbackInfo的mEventToHandlers根据key就是事件，vaule就是方法，通过事件获取方法最后调用方法，从value是个list可以看出你可以给多个方法注解同个生命周期。</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>大致的流程就是通过在activity添加个空的fragment来和activity的生命周期同步，然后再调用LifecycleRegistry的handleLifecycleEvent方法到ObserverWithState的dispatchEvent方法到ReflectiveGenericLifecycleObserver的onStateChanged方法，根据注解方法获取各自监听生命周期的方法再调用，只是官方做的更加的完善方便。第一次写分析文章，大部分都是源码很少解读的，希望以后能够改进，通过这次的分析，可以学习到可以通过设置个空的fragment来监听activity的生命周末，很多高度抽象的东西，比如LifecycleObserver你只要实现，很多东西就会自动生成，让开发者集成更加的方便。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.png"
                alt="GoGo (吴克伟)" />
            
              <p class="site-author-name" itemprop="name">GoGo (吴克伟)</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">20</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/zj-wukewei" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="http://www.jianshu.com/u/80402b2535d3" target="_blank" title="简书">
                    
                      <i class="fa fa-fw fa-简书"></i>简书</a>
                </span>
              
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">GoGo (吴克伟)</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  








  





  

  

  

  

  

  

</body>
</html>
